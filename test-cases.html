<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EntelliExtract Test Cases – intellirevenue</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <style>
      :root {
        --bg: #ffffff;
        --surface: #fafafa;
        --text: #333333;
        --text-secondary: #555555;
        --border: #e0e0e0;
        --accent: #009688;
        --accent-light: #e6f7f2;
        --primary: #32c778;
        --primary-hover: #2ab369;
        --pass: #2e7d32;
        --pass-bg: #e8f5e9;
        --fail: #c62828;
        --fail-bg: #ffebee;
        --muted: #9e9e9e;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
        line-height: 1.5;
        font-size: 14px;
      }
      .header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--bg);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .header-inner {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
      }
      .header-field-wrap {
        display: grid;
        grid-template-columns: auto minmax(10rem, 1fr);
        grid-template-rows: auto minmax(1.25em, auto);
        align-items: center;
        column-gap: 0.5rem;
        row-gap: 0.2rem;
        min-height: calc(2.25rem + 1.25em);
        justify-content: start;
      }
      .header-field-wrap > .header-label {
        grid-column: 1;
        grid-row: 1;
      }
      .header-field-wrap > .header-select {
        grid-column: 2;
        grid-row: 1;
      }
      .header-field-wrap > .header-field-error {
        grid-column: 2;
        grid-row: 2;
      }
      .header-field-error {
        color: var(--fail);
        font-size: 0.75rem;
        min-height: 1.25em;
        line-height: 1.2;
      }
      .header .logo {
        height: 32px;
        width: auto;
        display: block;
        object-fit: contain;
      }
      .header .logo-placeholder {
        height: 32px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1rem;
      }
      .header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
      }
      .header .subtitle {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 400;
      }
      .header-label {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        white-space: nowrap;
      }
      .header-select {
        padding: 0.35rem 0.5rem;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.8125rem;
        font-family: inherit;
        min-width: 10rem;
      }
      .header-select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background: var(--surface);
      }
      .main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem 1.5rem 2rem;
      }
      .limits-cell {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .limits-cell .limit-row {
        display: grid;
        grid-template-columns: 4.5rem 4.5rem;
        gap: 0.25rem 0.5rem;
        align-items: center;
      }
      .limits-cell .limit-label {
        white-space: nowrap;
      }
      .limits-cell input[type="number"] {
        width: 4rem;
        padding: 0.25rem 0.4rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.8rem;
        box-sizing: border-box;
      }
      .limits-cell .n/a {
        color: var(--muted);
        font-style: italic;
      }
      h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.35rem;
      }
      h2:first-of-type {
        margin-top: 0;
      }
      .table-section {
        padding: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 1.25rem;
        overflow: hidden;
      }
      .table-section table {
        width: 100%;
        min-width: 1100px;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 0.875rem;
        background: var(--bg);
      }
      th,
      td {
        padding: 0.5rem 0.75rem;
        text-align: left;
        border: 1px solid var(--border);
        vertical-align: top;
      }
      th {
        background: var(--surface);
        color: var(--text);
        font-weight: 600;
      }
      thead th {
        border-bottom: none;
      }
      tr:hover td {
        background: var(--surface);
      }
      .id {
        width: 3rem;
        font-weight: 600;
        color: var(--accent);
      }
      .scenario {
        width: 12rem;
        word-break: break-word;
      }
      .expected {
        width: 12rem;
        word-break: break-word;
        font-size: 0.8rem;
        color: var(--muted);
      }
      .limits-col {
        width: 11rem;
      }
      .run-cell {
        width: 8rem;
        text-align: center;
      }
      .run-cell .btn-group {
        display: flex;
        gap: 0.35rem;
        justify-content: center;
        flex-wrap: wrap;
      }
      .result-header {
        width: 38rem;
      }
      .result-cell {
        width: 38rem;
        min-width: 38rem;
        max-width: none;
        vertical-align: top;
      }
      button.run {
        background: var(--primary);
        color: #fff;
        border: none;
        padding: 0.4rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
      }
      button.run:hover {
        background: var(--primary-hover);
      }
      button.run:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button.reset-case {
        background: var(--bg);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        padding: 0.4rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        font-family: inherit;
      }
      button.reset-case:hover {
        background: var(--surface);
        color: var(--text);
      }
      button.reset-case.stop-btn {
        background: var(--fail);
        color: #fff;
        border-color: var(--fail);
      }
      button.reset-case.stop-btn:hover {
        background: #b71c1c;
        border-color: #b71c1c;
        color: #fff;
      }
      .result {
        font-family: ui-monospace, "SF Mono", Consolas, monospace;
        font-size: 0.75rem;
        margin-top: 0.35rem;
        padding: 0.5rem;
        border-radius: 4px;
        white-space: pre-wrap;
        word-break: break-all;
        border-left: 3px solid var(--border);
      }
      .result.pass {
        background: var(--pass-bg);
        border-left-color: var(--pass);
      }
      .result.fail {
        background: var(--fail-bg);
        border-left-color: var(--fail);
      }
      .result.running {
        background: var(--accent-light);
        border-left-color: var(--accent);
      }
      .result.running .loading-dots::after {
        content: "";
        animation: loading-dots 1.2s steps(4, end) infinite;
      }
      @keyframes loading-dots {
        0%, 20% { content: ""; }
        40% { content: "."; }
        60% { content: ".."; }
        80%, 100% { content: "..."; }
      }
      .result .sync-progress-wrap {
        margin-top: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
      }
      .result .sync-progress-bar {
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.35rem;
        max-width: 12rem;
      }
      .result .sync-progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
        transition: width 0.15s ease-out;
      }
      .result .sync-progress-fill.sync-progress-indeterminate {
        animation: sync-indeterminate 1.2s ease-in-out infinite;
      }
      @keyframes sync-indeterminate {
        0%, 100% { transform: translateX(-100%); }
        50% { transform: translateX(150%); }
      }
      .result.result-placeholder .result-placeholder-text {
        color: var(--muted);
        font-size: 0.8125rem;
        font-style: italic;
      }
      .result .exit {
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: var(--text);
      }
      .result .out {
        color: var(--text-secondary);
      }
      code {
        background: var(--surface);
        padding: 0.15rem 0.35rem;
        border-radius: 3px;
        font-size: 0.85em;
        border: 1px solid var(--border);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <img
          src="/assets/logo.png"
          alt="intellirevenue"
          class="logo"
          id="logo-img"
        />
        <span class="logo-placeholder" style="display: none"
          >intellirevenue</span
        >
        <div class="header-right">
          <div class="header-field-wrap">
            <label class="header-label" for="tenant-select">Brand</label>
            <select id="tenant-select" class="header-select" title="Select brand">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="no-cow-026090539970-prod">no-cow-026090539970-prod</option>
              <option value="sundia-026090539970-prod">sundia-026090539970-prod</option>
              <option value="tractor-beverage-026090539970-prod">tractor-beverage-026090539970-prod</option>
            </select>
            <div id="brand-error" class="header-field-error" role="alert"></div>
          </div>
          <div class="header-field-wrap">
            <label class="header-label" for="purchaser-select">Purchaser</label>
            <select id="purchaser-select" class="header-select" title="Select purchaser (filtered by brand)">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="DOT_FOODS">DOT_FOODS</option>
              <option value="KEHE">KEHE</option>
              <option value="UNFI">UNFI</option>
            </select>
            <div id="purchaser-error" class="header-field-error" role="alert"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <h2>Positive (P1–P10)</h2>
      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th class="id">ID</th>
              <th class="scenario">Scenario</th>
              <th class="expected">Expected</th>
              <th class="limits-col">File limits (0 = no limit)</th>
              <th class="run-cell">Action</th>
              <th class="result-header">Result</th>
            </tr>
          </thead>
          <tbody id="positive"></tbody>
        </table>
      </div>

      <h2>Negative (N1–N6)</h2>
      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th class="id">ID</th>
              <th class="scenario">Scenario</th>
              <th class="expected">Expected</th>
              <th class="limits-col">File limits (0 = no limit)</th>
              <th class="run-cell">Actions</th>
              <th class="result-header">Result</th>
            </tr>
          </thead>
          <tbody id="negative"></tbody>
        </table>
      </div>

      <h2>Edge (E1–E8)</h2>
      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th class="id">ID</th>
              <th class="scenario">Scenario</th>
              <th class="expected">Expected</th>
              <th class="limits-col">File limits (0 = no limit)</th>
              <th class="run-cell">Actions</th>
              <th class="result-header">Result</th>
            </tr>
          </thead>
          <tbody id="edge"></tbody>
        </table>
      </div>
    </main>

    <script type="module">
      (function () {
        var logo = document.getElementById("logo-img");
        var placeholder = logo && logo.nextElementSibling;
        if (logo) {
          if (location.protocol === "file:") logo.src = "assets/logo.png";
          logo.addEventListener("error", function () {
            logo.style.display = "none";
            if (placeholder) placeholder.style.display = "flex";
          });
        }
      })();
      const CASES = {
        positive: [
          {
            id: "P1",
            scenario: "Sync (valid config)",
            cmd: "npm start sync [--tenant T --purchaser P]",
            expected: "Exit 0, files in staging (for selected tenant/purchaser or all)",
            limits: { sync: true, extract: false },
          },
          {
            id: "P2",
            scenario: "Run extraction",
            cmd: "npm start run -- --no-sync [--tenant T --purchaser P]",
            expected: "Exit 0, report + log (for selected tenant/purchaser or all)",
            limits: { sync: false, extract: true },
          },
          {
            id: "P3",
            scenario: "Report (last run)",
            cmd: "npm start report",
            expected: "Exit 0, report files",
            limits: { sync: false, extract: false },
          },
          {
            id: "P4",
            scenario: "Report (by run ID)",
            cmd: "npm start report -- --run-id <id>",
            expected: "Exit 0, report for run",
            limits: { sync: false, extract: false },
          },
          {
            id: "P5",
            scenario: "Custom config",
            cmd: "npm start sync -c config/config.yaml",
            expected: "Exit 0",
            limits: { sync: true, extract: false },
          },
          {
            id: "P6",
            scenario: "Run, no report",
            cmd: "npm start run -- --no-sync --no-report",
            expected: "Exit 0, no new reports",
            limits: { sync: false, extract: true },
          },
          {
            id: "P7",
            scenario: "Req 1 Full pipeline",
            cmd: "npm start run [--tenant T --purchaser P]",
            expected: "Exit 0, sync then run (for selected tenant/purchaser or all)",
            limits: { sync: true, extract: true },
          },
          {
            id: "P8",
            scenario: "Req 2 Log structure",
            cmd: "Inspect output/logs/*.jsonl",
            expected: "JSONL: runId, filePath, request, response",
            limits: { sync: false, extract: false },
          },
          {
            id: "P9",
            scenario: "Req 4 Benchmark in report",
            cmd: "Open report",
            expected: "Throughput, P95, error rate",
            limits: { sync: false, extract: false },
          },
          {
            id: "P10",
            scenario: "Req 5 Report formats",
            cmd: "npm start report",
            expected: "Exit 0, .md + .html + .json",
            limits: { sync: false, extract: false },
          },
        ],
        negative: [
          {
            id: "N1",
            scenario: "Config missing",
            cmd: "sync -c config/nonexistent.yaml",
            expected: "Exit 1, Failed to load config",
            limits: { sync: false, extract: false },
          },
          {
            id: "N2",
            scenario: "Invalid YAML",
            cmd: "sync -c config/bad-yaml.yaml",
            expected: "Exit 1, Invalid YAML",
            limits: { sync: false, extract: false },
          },
          {
            id: "N3",
            scenario: "Invalid config",
            cmd: "sync -c config/bad-schema.yaml",
            expected: "Exit 1, Missing or invalid",
            limits: { sync: false, extract: false },
          },
          {
            id: "N4",
            scenario: "No prior run",
            cmd: "report (no last-run-id.txt)",
            expected: "Exit 1, No last run found",
            limits: { sync: false, extract: false },
          },
          {
            id: "N5",
            scenario: "Bad run ID",
            cmd: "report --run-id run_000...fake",
            expected: "Exit 1, No records found",
            limits: { sync: false, extract: false },
          },
          {
            id: "N6",
            scenario: "Sync fails (AWS)",
            cmd: "sync (wrong creds/bucket)",
            expected: "Exit 1, Sync failed",
            limits: { sync: true, extract: false },
          },
        ],
        edge: [
          {
            id: "E1",
            scenario: "Empty staging",
            cmd: "run --no-sync",
            expected: "Exit 0, Success: 0, Failed: 0",
            limits: { sync: false, extract: true },
          },
          {
            id: "E2",
            scenario: "All API fail",
            cmd: "run --no-sync",
            expected: "Exit 0, Failed: N, anomalies",
            limits: { sync: false, extract: true },
          },
          {
            id: "E3",
            scenario: "Resume after stop",
            cmd: "run --no-sync (twice)",
            expected: "2nd run skips done files",
            limits: { sync: false, extract: true },
          },
          {
            id: "E4",
            scenario: "Empty S3 bucket",
            cmd: "sync [--tenant T --purchaser P]",
            expected: "Exit 0, synced 0, errors 0",
            limits: { sync: true, extract: false },
          },
          {
            id: "E5",
            scenario: "S3 partial failures",
            cmd: "sync [--tenant T --purchaser P]",
            expected: "Exit 0, errors M>0",
            limits: { sync: true, extract: false },
          },
          {
            id: "E6",
            scenario: "Report (all failed)",
            cmd: "report --run-id <id>",
            expected: "Exit 0, failed count, anomalies",
            limits: { sync: false, extract: false },
          },
          {
            id: "E7",
            scenario: "Corrupt checkpoint",
            cmd: "checkpoint.json={} then run",
            expected: "Exit 0, new run ID",
            limits: { sync: false, extract: true },
          },
          {
            id: "E8",
            scenario: "Req 4 Concurrency/rate",
            cmd: "run --no-sync",
            expected: "Exit 0, under cap",
            limits: { sync: false, extract: true },
          },
        ],
      };

      function renderLimitsCell(c) {
        const lim = c.limits || { sync: false, extract: false };
        if (!lim.sync && !lim.extract) {
          return '<td class="limits-cell"><span class="n/a">—</span></td>';
        }
        var html = '<td class="limits-cell"><div class="limit-row">';
        if (lim.sync) {
          html +=
            '<span class="limit-label">Sync:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to download. 0 = no limit">';
        }
        if (lim.extract) {
          html +=
            '<span class="limit-label">Extract:</span><input type="number" class="limit-extract" min="0" step="1" value="0" title="Max files to extract. 0 = no limit">';
        }
        html += "</div></td>";
        return html;
      }

      function renderRow(c, sectionId) {
        const tr = document.createElement("tr");
        const resultCell = document.createElement("td");
        resultCell.className = "result-cell";
        const resultDiv = document.createElement("div");
        resultDiv.className = "result result-placeholder";
        resultDiv.id = "result-" + c.id;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Choose Brand and Purchaser to sync or extract for a specific brand\'s purchaser. Leave as All to run for all.</span>';
        resultCell.appendChild(resultDiv);
        const btn = document.createElement("button");
        btn.className = "run";
        btn.textContent = "Run";
        btn.onclick = function () {
          runCase(c.id, btn, resultDiv);
        };
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-case";
        resetBtn.textContent = "Reset";
        resetBtn.onclick = function () {
          resetCase(resultDiv);
        };
        tr.innerHTML =
          '<td class="id">' +
          c.id +
          '</td><td class="scenario">' +
          escapeHtml(c.scenario) +
          '</td><td class="expected">' +
          escapeHtml(c.expected) +
          "</td>" +
          renderLimitsCell(c) +
          '<td class="run-cell"><div class="btn-group"></div></td>';
        tr.querySelector(".btn-group").appendChild(btn);
        tr.querySelector(".btn-group").appendChild(resetBtn);
        tr.appendChild(resultCell);
        return tr;
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showResult(div, data, pass, progress, syncProgress) {
        div.style.display = "block";
        var resultClass = "running";
        if (data) resultClass = pass ? "pass" : "fail";
        div.className = "result " + resultClass;
        if (!data) {
          var label;
          var extra = "";
          if (syncProgress != null && (syncProgress.done != null || syncProgress.total != null)) {
            var done = Number(syncProgress.done) || 0;
            var total = Number(syncProgress.total) || 0;
            label = "Syncing…";
            var pct = total > 0 ? Math.min(100, Math.round((100 * done) / total)) : 0;
            extra =
              '<div class="sync-progress-wrap">Downloads: ' +
              (total > 0 ? done + " / " + total : done + " file(s)") +
              '</div>' +
              (total > 0
                ? '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' + pct + '%"></div></div>'
                : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          } else {
            var pctVal = progress && progress.percent != null ? Number(progress.percent) : null;
            var doneVal = progress && progress.done != null ? Number(progress.done) : null;
            var totalVal = progress && progress.total != null ? Number(progress.total) : null;
            if (pctVal != null && totalVal != null && totalVal > 0 && doneVal != null) {
              label = "Running… " + pctVal + "% (" + doneVal + " / " + totalVal + ")";
            } else if (pctVal != null) {
              label = "Running… " + pctVal + "%";
            } else {
              label = "Running…";
            }
          }
          div.innerHTML =
            '<span class="exit">' + escapeHtml(label) + '<span class="loading-dots"></span></span>' + extra;
          return;
        }
        var exit = data.exitCode;
        var stdoutStr = (data.stdout && String(data.stdout).trim()) || "";
        var stderrStr = (data.stderr && String(data.stderr).trim()) || "";
        var syncProgressPrefix = "SYNC_PROGRESS\t";
        var stdoutFiltered = stdoutStr
          ? stdoutStr
              .split("\n")
              .filter(function (line) {
                return line.indexOf(syncProgressPrefix) !== 0;
              })
              .join("\n")
              .trim()
          : "";
        var out = [stdoutFiltered, stderrStr].filter(Boolean).join("\n");
        var noOutput = !out;
        var exitLabel, outHtml;
        if (noOutput) {
          if (exit === 0) {
            exitLabel = "Success";
            outHtml =
              "Command completed successfully with no console output (exit code 0). " +
              "Sync, extraction, or report may have run without printing to stdout/stderr.";
          } else {
            exitLabel = "Failed (exit " + exit + ")";
            outHtml =
              "Command produced no output. Check server logs or run the command in a terminal for details.";
          }
        } else {
          exitLabel = "Exit " + exit;
          outHtml = escapeHtml(out.slice(0, 2000)) + (out.length > 2000 ? "…" : "");
        }
        div.innerHTML =
          '<span class="exit">' + escapeHtml(exitLabel) + '</span>\n<span class="out">' + outHtml + "</span>";
      }

      function resetCase(resultDiv) {
        if (!resultDiv) return;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Choose Brand and Purchaser to sync or extract for a specific brand\'s purchaser; leave as All to run for all.</span>';
        resultDiv.className = "result result-placeholder";
        var row = resultDiv.closest("tr");
        if (row) {
          var inputs = row.querySelectorAll(".limit-sync, .limit-extract");
          inputs.forEach(function (input) {
            input.value = "0";
          });
        }
      }

      function getParamsFromRow(row) {
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncLimit = syncInput ? Number.parseInt(syncInput.value, 10) : 0;
        var extractLimit = extractInput
          ? Number.parseInt(extractInput.value, 10)
          : 0;
        return {
          syncLimit: Number.isNaN(syncLimit) ? 0 : Math.max(0, syncLimit),
          extractLimit: Number.isNaN(extractLimit)
            ? 0
            : Math.max(0, extractLimit),
        };
      }

      function getTenantPurchaser() {
        var tenantEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = tenantEl && tenantEl.value ? tenantEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        var tenant = (brandVal === "" || brandVal === "all") ? undefined : brandVal;
        var purchaser = (purchaserVal === "" || purchaserVal === "all") ? undefined : purchaserVal;
        return { tenant: tenant, purchaser: purchaser };
      }

      async function runCase(caseId, btn, resultDiv) {
        var brandEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = brandEl && brandEl.value ? brandEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        if (brandVal === "") {
          showBrandError("Please select a brand or All.");
          if (purchaserVal && purchaserVal !== "all") showPurchaserError("Please select a brand first.");
          else clearPurchaserError();
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        if (purchaserVal === "") {
          clearBrandError();
          showPurchaserError("Please select a purchaser or All.");
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        clearBrandError();
        clearPurchaserError();
        var tp = getTenantPurchaser();
        var row = btn.closest("tr");
        var resetBtn = row ? row.querySelector(".reset-case") : null;
        var controller = new AbortController();
        function restoreResetBtn() {
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.classList.remove("stop-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
        }
        if (resetBtn) {
          resetBtn.textContent = "Stop";
          resetBtn.classList.add("stop-btn");
          resetBtn.onclick = function () {
            controller.abort();
          };
        }
        btn.disabled = true;
        showResult(resultDiv, null, false, null, null);
        var params = getParamsFromRow(row);
        try {
          var r = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              caseId: caseId,
              syncLimit: params.syncLimit,
              extractLimit: params.extractLimit,
              tenant: tp.tenant,
              purchaser: tp.purchaser,
            }),
            signal: controller.signal,
          });
          if (!r.ok || !r.body) {
            var errText = await r.text();
            try {
              var errJson = JSON.parse(errText);
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: errText }, false);
            return;
          }
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buffer = "";
          var data = null;
          while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split("\n");
            buffer = lines.pop() || "";
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (!line) continue;
              try {
                var msg = JSON.parse(line);
                if (msg.type === "progress" && msg.percent != null) {
                  showResult(resultDiv, null, false, { percent: msg.percent, done: msg.done, total: msg.total }, null);
                } else if (msg.type === "sync_progress") {
                  showResult(resultDiv, null, false, null, { done: msg.done, total: msg.total });
                } else if (msg.type === "result") {
                  data = msg;
                } else if (msg.error) {
                  data = { exitCode: 1, stdout: "", stderr: msg.error };
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              var msg = JSON.parse(buffer.trim());
              if (msg.type === "result") data = msg;
              else if (msg.error) data = { exitCode: 1, stdout: "", stderr: msg.error };
            } catch (_) {}
          }
          if (!data) {
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: "No result from server" }, false);
            return;
          }
          var expectFail = caseId.indexOf("N") === 0;
          var pass = expectFail ? data.exitCode !== 0 : data.exitCode === 0;
          showResult(resultDiv, data, pass);
        } catch (e) {
          if (e.name === "AbortError") {
            showResult(
              resultDiv,
              { exitCode: 130, stdout: "", stderr: "Stopped by user." },
              false,
            );
          } else {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: e.message },
              false,
            );
          }
        } finally {
          btn.disabled = false;
          restoreResetBtn();
        }
      }

      ["positive", "negative", "edge"].forEach(function (section) {
        var tbody = document.getElementById(section);
        CASES[section].forEach(function (c) {
          tbody.appendChild(renderRow(c, section));
        });
      });

      var BRAND_PURCHASERS = {
        "no-cow-026090539970-prod": ["DOT_FOODS", "KEHE", "UNFI"],
        "sundia-026090539970-prod": ["DOT_FOODS", "KEHE"],
        "tractor-beverage-026090539970-prod": ["DOT_FOODS"],
      };
      function refreshPurchaserOptions() {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (!brandSelect || !purchaserSelect) return;
        var brand = brandSelect.value;
        if (brand === "") {
          purchaserSelect.disabled = true;
          purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option><option value="DOT_FOODS">DOT_FOODS</option><option value="KEHE">KEHE</option><option value="UNFI">UNFI</option>';
          purchaserSelect.value = "";
          return;
        }
        purchaserSelect.disabled = false;
        var current = purchaserSelect.value;
        var opts = brand !== "all" ? (BRAND_PURCHASERS[brand] || ["DOT_FOODS", "KEHE", "UNFI"]) : ["DOT_FOODS", "KEHE", "UNFI"];
        purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option>' + opts.map(function (p) { return '<option value="' + p + '">' + p + '</option>'; }).join("");
        if (current === "all" || opts.indexOf(current) !== -1) purchaserSelect.value = current;
        else purchaserSelect.value = "";
      }
      function showBrandError(msg) {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = msg || "Please select a brand.";
      }
      function clearBrandError() {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = "";
      }
      function showPurchaserError(msg) {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = msg || "Please select a brand first.";
      }
      function clearPurchaserError() {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = "";
      }
      (function () {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (brandSelect && purchaserSelect) {
          brandSelect.addEventListener("change", function () {
            clearBrandError();
            clearPurchaserError();
            refreshPurchaserOptions();
          });
          purchaserSelect.addEventListener("change", function () {
            if (purchaserSelect.value && purchaserSelect.value !== "all" && (!brandSelect.value || brandSelect.value === "")) {
              showPurchaserError("Please select a brand first.");
            } else {
              clearPurchaserError();
            }
          });
          refreshPurchaserOptions();
        }
      })();
    </script>
  </body>
</html>
