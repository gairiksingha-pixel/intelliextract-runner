<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EntelliExtract — intellirevenue</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <style>
      :root {
        --bg: #f5f7f9;
        --surface: #ffffff;
        --text: #2c2c2c;
        --text-secondary: #5a5a5a;
        --border: #c5cdd1;
        --border-light: #dfe4e8;
        --header-bg: #216c6d;
        --header-text: #ffffff;
        --header-border: #1a5758;
        --accent: #2d9d5f;
        --accent-light: #e8f5ee;
        --primary: #2d9d5f;
        --primary-hover: #248f54;
        --pass: #248f54;
        --pass-bg: #e8f5ee;
        --fail: #c62828;
        --fail-bg: #ffebee;
        --muted: #6b7c85;
        --row-alt: #fafbfc;
        --cell-pad: 0.85rem 1rem;
        --radius: 8px;
        --radius-sm: 6px;
        --radius-xs: 4px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
        --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-inset: inset 0 1px 2px rgba(0,0,0,0.06);
        --shadow-btn: 0 1px 3px rgba(0,0,0,0.12);
      }
      * {
        box-sizing: border-box;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", "Calibri", Candara, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
        font-size: 14px;
        display: flex;
        flex-direction: column;
      }
      .header {
        flex-shrink: 0;
        background: var(--surface);
        border-bottom: 2px solid var(--border);
        box-shadow: var(--shadow-md);
      }
      .header-inner {
        max-width: 100%;
        margin: 0 auto;
        padding: 0.9rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
      }
      .header-field-wrap {
        display: grid;
        grid-template-columns: auto minmax(11rem, 1fr);
        grid-template-rows: auto minmax(1.25em, auto);
        align-items: center;
        column-gap: 0.5rem;
        row-gap: 0.2rem;
        justify-content: start;
      }
      .header-field-wrap > .header-label {
        grid-column: 1;
        grid-row: 1;
      }
      .header-field-wrap > .header-select {
        grid-column: 2;
        grid-row: 1;
      }
      .header-field-wrap > .header-field-error {
        grid-column: 2;
        grid-row: 2;
      }
      .header-field-error {
        color: var(--fail);
        font-size: 0.75rem;
        min-height: 1.25em;
        line-height: 1.2;
      }
      .header .logo {
        height: 36px;
        width: auto;
        display: block;
        object-fit: contain;
      }
      .header .logo-placeholder {
        height: 36px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1rem;
      }
      .header-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        white-space: nowrap;
        font-weight: 600;
      }
      .header-select {
        width: 176px;
        min-width: 176px;
        max-width: 176px;
        height: 36px;
        padding: 0.5rem 2rem 0.5rem 0.6rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        box-sizing: border-box;
        box-shadow: var(--shadow-inset);
      }
      .header-select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background: var(--row-alt);
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 1.25rem 1.5rem;
        max-width: 100%;
      }
      .table-section {
        flex: 1 1 0%;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
      }
      .table-section table {
        height: 100%;
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: var(--surface);
        border-radius: var(--radius);
      }
      th, td {
        padding: var(--cell-pad);
        text-align: left;
        border: 1px solid var(--border);
        vertical-align: middle;
      }
      thead th:first-child {
        border-top-left-radius: calc(var(--radius) - 1px);
      }
      thead th:last-child {
        border-top-right-radius: calc(var(--radius) - 1px);
      }
      thead tr {
        height: 48px;
      }
      thead th {
        height: 48px;
        box-sizing: border-box;
      }
      tbody {
        height: 100%;
      }
      tbody tr {
        height: 33.333%;
      }
      tbody td {
        height: 33.333%;
        box-sizing: border-box;
      }
      thead th {
        background: var(--header-bg);
        color: var(--header-text);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: none;
        letter-spacing: 0.02em;
        border-color: var(--header-border);
      }
      tbody tr {
        background: var(--surface);
      }
      tbody tr:nth-child(even) {
        background: var(--row-alt);
      }
      tbody tr:hover td {
        background: #f0f9f4;
      }
      .op-name {
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        font-weight: 600;
      }
      thead th.op-name {
        color: var(--header-text);
      }
      tbody td.op-name {
        background: var(--header-bg);
        color: #ffffff;
        border-color: var(--header-border);
      }
      tbody tr:hover td.op-name {
        background: var(--header-bg);
      }
      .limits-col {
        width: 140px;
        min-width: 140px;
        max-width: 140px;
      }
      .limits-cell {
        font-size: 0.85rem;
        color: var(--text-secondary);
        overflow: hidden;
        vertical-align: top;
      }
      .limits-cell .limit-row {
        display: grid;
        grid-template-columns: auto 56px;
        gap: 0.5rem 0.75rem;
        align-items: center;
        min-height: 2.5rem;
      }
      .limits-cell .limit-label {
        white-space: nowrap;
        font-weight: 500;
      }
      .limits-cell input[type="number"] {
        width: 56px;
        min-width: 56px;
        max-width: 56px;
        height: 32px;
        padding: 0.35rem 0.4rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        box-sizing: border-box;
        box-shadow: var(--shadow-inset);
      }
      .limits-cell .limit-hint {
        margin-top: 0.5rem;
        padding: 0.35rem 0.5rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary);
        background: var(--accent-light);
        border-radius: var(--radius-xs);
        border: 1px solid rgba(45, 157, 95, 0.25);
        display: inline-block;
      }
      .limits-cell .n/a {
        color: var(--muted);
        font-style: italic;
      }
      .run-cell {
        width: 180px;
        min-width: 180px;
        max-width: 180px;
        text-align: center;
        vertical-align: top;
      }
      .run-cell .btn-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        width: 100%;
        margin: 0 auto;
        min-width: 0;
        box-sizing: border-box;
      }
      .run-cell .btn-row,
      .run-cell .btn-row-download {
        display: contents;
      }
      .run-cell .btn-group > .btn-row > button,
      .run-cell .btn-group > .btn-row-download > button {
        min-width: 0;
      }
      button.run {
        background: var(--primary);
        color: #fff;
        border: 1px solid var(--header-border);
        border-radius: var(--radius-sm);
        padding: 0.65rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-btn);
      }
      button.run:hover {
        background: var(--primary-hover);
        box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      }
      button.run:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      button.reset-case {
        background: var(--surface);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.55rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
      }
      button.reset-case:hover {
        background: var(--row-alt);
        color: var(--text);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      button.reset-case.stop-btn {
        background: var(--fail);
        color: #fff;
        border-color: var(--fail);
        box-shadow: var(--shadow-btn);
      }
      button.reset-case.stop-btn:hover {
        background: #a00;
        border-color: #a00;
        color: #fff;
      }
      button.download-sync-report-btn,
      button.download-report-btn {
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.55rem 0.85rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-sizing: border-box;
        box-shadow: var(--shadow-btn);
      }
      button.download-sync-report-btn {
        background: #2f5496;
        color: #fff;
      }
      button.download-sync-report-btn:hover {
        background: #244a7a;
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      }
      button.download-report-btn {
        background: var(--accent);
        color: #fff;
      }
      button.download-report-btn:hover {
        background: var(--primary-hover);
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      }
      button.download-sync-report-btn:disabled,
      button.download-report-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .result-header {
        width: 548px;
        min-width: 548px;
        max-width: 548px;
      }
      .result-cell {
        width: 548px;
        min-width: 548px;
        max-width: 548px;
        vertical-align: top;
        overflow: hidden;
        position: relative;
      }
      .result {
        position: absolute;
        top: 0.85rem;
        left: 1rem;
        right: 1rem;
        bottom: 0.85rem;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 0.8rem;
        padding: 0.6rem 0.75rem;
        white-space: pre-wrap;
        word-break: break-word;
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        background: #fafafa;
        overflow: auto;
        box-sizing: border-box;
        box-shadow: var(--shadow-sm);
      }
      .result.pass {
        background: var(--pass-bg);
        border-color: #b8e0c8;
      }
      .result.fail {
        background: var(--fail-bg);
        border-color: #f8d4d4;
      }
      .result.running {
        background: var(--accent-light);
        border-color: #b8e0c8;
      }
      .result.running .loading-dots::after {
        content: "";
        animation: loading-dots 1.2s steps(4, end) infinite;
      }
      @keyframes loading-dots {
        0%, 20% { content: ""; }
        40% { content: "."; }
        60% { content: ".."; }
        80%, 100% { content: "..."; }
      }
      .result .sync-progress-wrap {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .result .sync-progress-bar {
        height: 8px;
        background: var(--border-light);
        border-radius: var(--radius-xs);
        overflow: hidden;
        margin-top: 0.35rem;
        max-width: 14rem;
        box-shadow: var(--shadow-inset);
      }
      .result .sync-progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: var(--radius-xs);
        transition: width 0.15s ease-out;
      }
      .result .sync-progress-fill.sync-progress-indeterminate {
        animation: sync-indeterminate 1.2s ease-in-out infinite;
      }
      @keyframes sync-indeterminate {
        0%, 100% { transform: translateX(-100%); }
        50% { transform: translateX(150%); }
      }
      .result.result-placeholder .result-placeholder-text {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: italic;
      }
      .result .exit {
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: var(--text);
      }
      .result .out {
        color: var(--text-secondary);
      }
      .result-table-wrap {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8rem;
        table-layout: fixed;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-inset);
      }
      .result-table-wrap th,
      .result-table-wrap td {
        padding: 0.4rem 0.6rem;
        text-align: left;
        vertical-align: top;
        border: 1px solid var(--border-light);
        background: rgba(255,255,255,0.5);
      }
      .result-table-wrap th {
        font-weight: 600;
        color: var(--text);
        width: 100px;
        min-width: 100px;
      }
      .result-table-wrap td {
        color: var(--text-secondary);
        word-break: break-word;
        white-space: pre-wrap;
      }
      .result-table-wrap tr:first-child th:first-child,
      .result-table-wrap tr:first-child td:first-child {
        border-top-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:first-child th:last-child,
      .result-table-wrap tr:first-child td:last-child {
        border-top-right-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:first-child,
      .result-table-wrap tr:last-child td:first-child {
        border-bottom-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:last-child,
      .result-table-wrap tr:last-child td:last-child {
        border-bottom-right-radius: var(--radius-sm);
      }
      .result-table-wrap tr.status-row th {
        border-top: none;
      }
      .result-table-wrap tr.status-row td {
        font-weight: 600;
      }
      .result.pass .result-table-wrap tr.status-row td {
        color: var(--pass);
      }
      .result.fail .result-table-wrap tr.status-row td {
        color: var(--fail);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <img
          src="/assets/logo.png"
          alt="intellirevenue"
          class="logo"
          id="logo-img"
        />
        <span class="logo-placeholder" style="display: none"
          >intellirevenue</span
        >
        <div class="header-right">
          <div class="header-field-wrap">
            <label class="header-label" for="tenant-select">Brand</label>
            <select id="tenant-select" class="header-select" title="Select brand">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="no-cow-026090539970-prod">no-cow-026090539970-prod</option>
              <option value="sundia-026090539970-prod">sundia-026090539970-prod</option>
              <option value="tractor-beverage-026090539970-prod">tractor-beverage-026090539970-prod</option>
            </select>
            <div id="brand-error" class="header-field-error" role="alert"></div>
          </div>
          <div class="header-field-wrap">
            <label class="header-label" for="purchaser-select">Purchaser</label>
            <select id="purchaser-select" class="header-select" title="Select purchaser (filtered by brand)">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="DOT_FOODS">DOT_FOODS</option>
              <option value="KEHE">KEHE</option>
              <option value="UNFI">UNFI</option>
            </select>
            <div id="purchaser-error" class="header-field-error" role="alert"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th class="op-name">Operation</th>
              <th class="limits-col">Batch limits (Sync / Extract)</th>
              <th class="run-cell">Execute</th>
              <th class="result-header">Status &amp; output</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>

    <script type="module">
      (function () {
        var logo = document.getElementById("logo-img");
        var placeholder = logo && logo.nextElementSibling;
        if (logo) {
          if (location.protocol === "file:") logo.src = "assets/logo.png";
          logo.addEventListener("error", function () {
            logo.style.display = "none";
            if (placeholder) placeholder.style.display = "flex";
          });
        }
      })();
      const ROWS = [
        { id: "P1", scenario: "S3 Sync — Download files to staging", limits: { sync: true, extract: false } },
        { id: "P2", scenario: "Extract & Report — Run extraction and generate report", limits: { sync: false, extract: true } },
        { id: "PIPE", scenario: "Sync & Extract (pipeline) — One count: sync and extract each file in background as it's synced", limits: { pipeline: true } },
      ];

      function renderLimitsCell(c) {
        const lim = c.limits || { sync: false, extract: false, pipeline: false };
        if (!lim.sync && !lim.extract && !lim.pipeline) {
          return '<td class="limits-cell"><span class="n/a">—</span></td>';
        }
        var html = '<td class="limits-cell"><div class="limit-row">';
        if (lim.pipeline) {
          html +=
            '<span class="limit-label">Limit:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to sync; each is extracted in background as it is synced. 0 = no limit">';
        } else {
          if (lim.sync) {
            html +=
              '<span class="limit-label">Sync:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to download. 0 = no limit">';
          }
          if (lim.extract) {
            html +=
              '<span class="limit-label">Extract:</span><input type="number" class="limit-extract" min="0" step="1" value="0" title="Max files to extract. 0 = no limit">';
          }
        }
        html += "</div><div class=\"limit-hint\">0 = no limit</div></td>";
        return html;
      }

      function getRunButtonLabel(caseId) {
        if (caseId === "P1") return "Start Sync";
        if (caseId === "P2") return "Start Extraction";
        if (caseId === "PIPE") return "Start Sync and Extraction";
        return "Run";
      }

      function renderRow(c, sectionId) {
        const tr = document.createElement("tr");
        const resultCell = document.createElement("td");
        resultCell.className = "result-cell";
        const resultDiv = document.createElement("div");
        resultDiv.className = "result result-placeholder";
        resultDiv.id = "result-" + c.id;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select Brand and Purchaser above, then click Execute. Leave as All to run for all.</span>';
        resultCell.appendChild(resultDiv);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "run";
        btn.textContent = getRunButtonLabel(c.id);
        btn.onclick = function () {
          runCase(c.id, btn, resultDiv);
        };
        const resetBtn = document.createElement("button");
        resetBtn.type = "button";
        resetBtn.className = "reset-case";
        resetBtn.textContent = "Reset";
        resetBtn.onclick = function () {
          resetCase(resultDiv);
        };
        tr.innerHTML =
          '<td class="op-name">' +
          escapeHtml(c.scenario) +
          "</td>" +
          renderLimitsCell(c) +
          '<td class="run-cell"><div class="btn-group"><div class="btn-row"></div><div class="btn-row-download"></div></div></td>';
        tr.querySelector(".btn-row").appendChild(btn);
        tr.querySelector(".btn-row").appendChild(resetBtn);
        const downloadSyncReportBtn = document.createElement("button");
        downloadSyncReportBtn.className = "download-sync-report-btn";
        downloadSyncReportBtn.textContent = "Download Sync Report";
        downloadSyncReportBtn.type = "button";
        downloadSyncReportBtn.style.display = "none";
        downloadSyncReportBtn.onclick = function () {
          downloadSyncReport(downloadSyncReportBtn);
        };
        tr.querySelector(".btn-row-download").appendChild(downloadSyncReportBtn);
        function addReportDownloadBtn(label, format) {
          const b = document.createElement("button");
          b.className = "download-report-btn";
          b.textContent = label;
          b.type = "button";
          b.setAttribute("data-format", format);
          b.style.display = "none";
          b.onclick = function () { downloadLatestReport(b, format); };
          tr.querySelector(".btn-row-download").appendChild(b);
        }
        addReportDownloadBtn("Download HTML report", "html");
        addReportDownloadBtn("Download JSON report", "json");
        tr.appendChild(resultCell);
        return tr;
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showResult(div, data, pass, progress, syncProgress, caseId) {
        div.style.display = "block";
        var resultClass = "running";
        if (data) resultClass = pass ? "pass" : "fail";
        div.className = "result " + resultClass;
        var row = div.closest("tr");
        var syncCases = ["P1", "PIPE"];
        var extractCases = ["P2", "PIPE"];
        var showSync = data && pass && caseId && syncCases.includes(caseId);
        var showExtract = data && pass && caseId && extractCases.includes(caseId);
        var downloadSyncReportBtn = row ? row.querySelector(".download-sync-report-btn") : null;
        var downloadReportBtns = row ? row.querySelectorAll(".download-report-btn") : [];
        if (downloadSyncReportBtn) {
          downloadSyncReportBtn.style.display = showSync ? "block" : "none";
        }
        downloadReportBtns.forEach(function (b) {
          b.style.display = showExtract ? "block" : "none";
        });
        if (!data) {
          var label;
          var extra = "";
          if (syncProgress != null && (syncProgress.done != null || syncProgress.total != null)) {
            var done = Number(syncProgress.done) || 0;
            var total = Number(syncProgress.total) || 0;
            label = "Syncing…";
            var pct = total > 0 ? Math.min(100, Math.round((100 * done) / total)) : 0;
            extra =
              '<div class="sync-progress-wrap">Downloads: ' +
              (total > 0 ? done + " / " + total : done + " file(s)") +
              '</div>' +
              (total > 0
                ? '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' + pct + '%"></div></div>'
                : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          } else {
            var pctVal = progress && progress.percent != null ? Number(progress.percent) : null;
            var doneVal = progress && progress.done != null ? Number(progress.done) : null;
            var totalVal = progress && progress.total != null ? Number(progress.total) : null;
            if (pctVal != null && totalVal != null && totalVal > 0 && doneVal != null) {
              label = "Running… " + pctVal + "% (" + doneVal + " / " + totalVal + ")";
            } else if (pctVal != null) {
              label = "Running… " + pctVal + "%";
            } else {
              label = "Running…";
            }
          }
          div.innerHTML =
            '<span class="exit">' + escapeHtml(label) + '<span class="loading-dots"></span></span>' + extra;
          return;
        }
        var stdoutStr = (data.stdout && String(data.stdout).trim()) || "";
        var stderrStr = (data.stderr && String(data.stderr).trim()) || "";
        var syncProgressPrefix = "SYNC_PROGRESS\t";
        function filterResultLine(line) {
          if (line.indexOf(syncProgressPrefix) === 0) return false;
          if (line.indexOf("Report(s) written:") !== -1) return false;
          if (/Run run_\S+ finished\./.test(line)) return false;
          return true;
        }
        var stdoutFiltered = stdoutStr
          ? stdoutStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var stderrFiltered = stderrStr
          ? stderrStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var statusLabel = pass ? "Pass" : "Fail";
        var parsed = {};
        var lines = stdoutFiltered ? stdoutFiltered.split("\n") : [];
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          var m;
          if ((m = /^Download limit:\s*(.+)$/.exec(line))) parsed.downloadLimit = m[1].trim();
          else if ((m = /^Downloaded \(new\):\s*(\d+)$/.exec(line))) parsed.downloadedNew = m[1];
          else if ((m = /^Skipped \(already present[^:]*:\s*(\d+)$/.exec(line))) parsed.skipped = m[1];
          else if ((m = /^Errors:\s*(\d+)$/.exec(line))) parsed.errors = m[1];
          else if ((m = /^\s+Staging path:\s*(.+)$/.exec(line))) {
            if (!parsed.stagingPaths) parsed.stagingPaths = [];
            parsed.stagingPaths.push(m[1].trim());
          }           else if ((m = /^Scoped to tenant:\s*([^,]+),\s*purchaser:\s*(.+)$/.exec(line))) {
            parsed.brandAndPurchaser = (m[1].trim() + " / " + m[2].trim()).trim();
          } else if ((m = /^\s{2}([^:\s][^:]*)\s*$/.exec(line)) && line.trim().indexOf("/") !== -1 && !/Staging path|Downloaded:|Skipped:|Errors:/.test(line)) {
            if (!parsed.brandAndPurchaserList) parsed.brandAndPurchaserList = [];
            parsed.brandAndPurchaserList.push(line.trim());
          } else if ((m = /^Extraction metrics:\s*success=(\d+),\s*failed=(\d+),\s*skipped=(\d+)$/.exec(line))) {
            parsed.extractSuccess = m[1];
            parsed.extractFailed = m[2];
            parsed.extractSkipped = m[3];
          } else if ((m = /^Extraction result\(s\):\s*(.+?)\s*\(full/.exec(line))) parsed.extractionResultsPath = m[1].trim();
          else if ((m = /^Reports path:\s*(.+)$/.exec(line))) parsed.reportsPath = m[1].trim();
        }
        var syncCases = ["P1", "PIPE", "P5"];
        var extractCases = ["P2", "PIPE", "P5", "P3"];
        var hasSync = caseId && syncCases.indexOf(caseId) !== -1 && (parsed.downloadLimit != null || parsed.downloadedNew != null);
        var hasExtract = caseId && extractCases.indexOf(caseId) !== -1 && (parsed.extractSuccess != null || parsed.extractionResultsPath != null || parsed.reportsPath != null);
        var rows = [];
        rows.push(["Status", statusLabel]);
        if (hasSync) {
          if (parsed.downloadLimit != null) rows.push(["Download limit", parsed.downloadLimit]);
          if (parsed.downloadedNew != null) rows.push(["Downloaded (new)", parsed.downloadedNew]);
          var brandPurchaser = parsed.brandAndPurchaser || (parsed.brandAndPurchaserList && parsed.brandAndPurchaserList.length ? parsed.brandAndPurchaserList.join("\n") : null);
          if (brandPurchaser) rows.push(["Brand and purchaser", brandPurchaser]);
          if (parsed.stagingPaths && parsed.stagingPaths.length) rows.push(["Staging path", parsed.stagingPaths.join("\n")]);
          var overview = [];
          if (parsed.downloadedNew != null) overview.push("Downloaded: " + parsed.downloadedNew);
          if (parsed.skipped != null) overview.push("Skipped: " + parsed.skipped);
          if (parsed.errors != null) overview.push("Errors: " + parsed.errors);
          if (overview.length) rows.push(["Overview", overview.join(", ")]);
        }
        if (hasExtract) {
          if (parsed.brandAndPurchaser && !hasSync) rows.push(["Brand and purchaser", parsed.brandAndPurchaser]);
          if (parsed.extractSuccess != null || parsed.extractFailed != null || parsed.extractSkipped != null) {
            var detail = "Success: " + (parsed.extractSuccess || "0") + ", Failed: " + (parsed.extractFailed || "0") + ", Skipped: " + (parsed.extractSkipped || "0");
            rows.push(["Total file extracted", detail]);
          }
          if (parsed.extractionResultsPath) rows.push(["Staging path", parsed.extractionResultsPath]);
          if (parsed.reportsPath) rows.push(["Reports path", parsed.reportsPath]);
        }
        if (!hasSync && !hasExtract && stdoutFiltered) {
          rows.push(["Output", escapeHtml(stdoutFiltered.slice(0, 1500)) + (stdoutFiltered.length > 1500 ? "…" : "")]);
        } else if (rows.length === 1) {
          var noOutput = !stdoutFiltered && !stderrFiltered;
          rows.push(["Output", noOutput && data.exitCode === 0
            ? "Command completed successfully with no console output."
            : noOutput ? "Command produced no output. Check server logs or run in a terminal for details." : "—"]);
        }
        if (stderrFiltered) rows.push(["Standard error", escapeHtml(stderrFiltered.slice(0, 2000)) + (stderrFiltered.length > 2000 ? "…" : "")]);
        var tableRows = rows.map(function (r) {
          return "<tr" + (r[0] === "Status" ? " class=\"status-row\"" : "") + "><th>" + escapeHtml(r[0]) + "</th><td>" + (r[0] === "Standard error" || r[0] === "Output" ? r[1] : escapeHtml(r[1]).replace(/\n/g, "<br>")) + "</td></tr>";
        });
        div.innerHTML = "<table class=\"result-table-wrap\">" + tableRows.join("") + "</table>";
      }

      function resetCase(resultDiv, options) {
        if (!resultDiv) return;
        var clearLimits = !options || options.clearLimits !== false;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select Brand and Purchaser above, then click Execute. Leave as All to run for all.</span>';
        resultDiv.className = "result result-placeholder";
        var row = resultDiv.closest("tr");
        if (row) {
          if (clearLimits) {
            var inputs = row.querySelectorAll(".limit-sync, .limit-extract");
            inputs.forEach(function (input) {
              input.value = "0";
            });
          }
          var downloadSyncReportBtn = row.querySelector(".download-sync-report-btn");
          var downloadReportBtns = row.querySelectorAll(".download-report-btn");
          if (downloadSyncReportBtn) downloadSyncReportBtn.style.display = "none";
          downloadReportBtns.forEach(function (b) { b.style.display = "none"; });
        }
      }

      function getParamsFromRow(row) {
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncLimit = syncInput ? Number.parseInt(syncInput.value, 10) : 0;
        var extractLimit = extractInput
          ? Number.parseInt(extractInput.value, 10)
          : 0;
        return {
          syncLimit: Number.isNaN(syncLimit) ? 0 : Math.max(0, syncLimit),
          extractLimit: Number.isNaN(extractLimit)
            ? 0
            : Math.max(0, extractLimit),
        };
      }

      function getTenantPurchaser() {
        var tenantEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = tenantEl && tenantEl.value ? tenantEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        var tenant = (brandVal === "" || brandVal === "all") ? undefined : brandVal;
        var purchaser = (purchaserVal === "" || purchaserVal === "all") ? undefined : purchaserVal;
        return { tenant: tenant, purchaser: purchaser };
      }

      async function runCase(caseId, btn, resultDiv) {
        var brandEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = brandEl && brandEl.value ? brandEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        if (brandVal === "") {
          showBrandError("Please select a brand or All.");
          if (purchaserVal && purchaserVal !== "all") showPurchaserError("Please select a brand first.");
          else clearPurchaserError();
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        if (purchaserVal === "") {
          clearBrandError();
          showPurchaserError("Please select a purchaser or All.");
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        clearBrandError();
        clearPurchaserError();
        var tp = getTenantPurchaser();
        var row = btn.closest("tr");
        var resetBtn = row ? row.querySelector(".reset-case") : null;
        var controller = new AbortController();
        function restoreResetBtn() {
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.classList.remove("stop-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
        }
        if (resetBtn) {
          resetBtn.textContent = "Stop";
          resetBtn.classList.add("stop-btn");
          resetBtn.onclick = function () {
            controller.abort();
          };
        }
        btn.disabled = true;
        showResult(resultDiv, null, false, null, null);
        var params = getParamsFromRow(row);
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncIsZero = syncInput && Number.parseInt(syncInput.value, 10) === 0;
        var extractIsZero = extractInput && Number.parseInt(extractInput.value, 10) === 0;
        var isNoLimit = syncIsZero || extractIsZero;
        if (isNoLimit) {
          var proceed = window.confirm(
            "Limit is set to 0 (no limit). This will process all files and may take a long time. Continue?"
          );
          if (!proceed) {
            btn.disabled = false;
            resetCase(resultDiv, { clearLimits: false });
            restoreResetBtn();
            return;
          }
        }
        try {
          var r = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              caseId: caseId,
              syncLimit: params.syncLimit,
              extractLimit: params.extractLimit,
              tenant: tp.tenant,
              purchaser: tp.purchaser,
            }),
            signal: controller.signal,
          });
          if (!r.ok || !r.body) {
            var errText = await r.text();
            try {
              var errJson = JSON.parse(errText);
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: errText }, false);
            return;
          }
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buffer = "";
          var data = null;
          while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split("\n");
            buffer = lines.pop() || "";
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (!line) continue;
              try {
                var msg = JSON.parse(line);
                if (msg.type === "progress" && msg.percent != null) {
                  showResult(resultDiv, null, false, { percent: msg.percent, done: msg.done, total: msg.total }, null);
                } else if (msg.type === "sync_progress") {
                  showResult(resultDiv, null, false, null, { done: msg.done, total: msg.total });
                } else if (msg.type === "result") {
                  data = msg;
                } else if (msg.error) {
                  data = { exitCode: 1, stdout: "", stderr: msg.error };
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              var msg = JSON.parse(buffer.trim());
              if (msg.type === "result") data = msg;
              else if (msg.error) data = { exitCode: 1, stdout: "", stderr: msg.error };
            } catch (_) {}
          }
          if (!data) {
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: "No result from server" }, false, null, null, caseId);
            return;
          }
          var expectFail = caseId.indexOf("N") === 0;
          var pass = expectFail ? data.exitCode !== 0 : data.exitCode === 0;
          showResult(resultDiv, data, pass, null, null, caseId);
        } catch (e) {
          if (e.name === "AbortError") {
            showResult(
              resultDiv,
              { exitCode: 130, stdout: "", stderr: "Stopped by user." },
              false,
              null,
              null,
              caseId,
            );
          } else {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: e.message },
              false,
              null,
              null,
              caseId,
            );
          }
        } finally {
          btn.disabled = false;
          restoreResetBtn();
        }
      }

      var tbody = document.getElementById("rows");
      ROWS.forEach(function (c) {
        tbody.appendChild(renderRow(c, "rows"));
      });

      function downloadSyncReport(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/sync-report")
          .then(function (r) { return r.blob(); })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "sync-report.html";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadLatestReport(btn, format) {
        if (btn) btn.disabled = true;
        fetch("/api/reports")
          .then(function (r) { return r.json(); })
          .then(function (list) {
            var reports = list[format] || [];
            if (reports.length === 0) {
              if (btn) btn.disabled = false;
              return;
            }
            var latest = reports[0];
            var filename = latest.name;
            var url = "/api/reports/" + format + "/" + encodeURIComponent(filename);
            return fetch(url).then(function (r) { return r.blob(); }).then(function (blob) {
              var a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = filename;
              a.click();
              URL.revokeObjectURL(a.href);
            });
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      var BRAND_PURCHASERS = {
        "no-cow-026090539970-prod": ["DOT_FOODS", "KEHE", "UNFI"],
        "sundia-026090539970-prod": ["DOT_FOODS", "KEHE"],
        "tractor-beverage-026090539970-prod": ["DOT_FOODS"],
      };
      function refreshPurchaserOptions() {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (!brandSelect || !purchaserSelect) return;
        var brand = brandSelect.value;
        if (brand === "") {
          purchaserSelect.disabled = true;
          purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option><option value="DOT_FOODS">DOT_FOODS</option><option value="KEHE">KEHE</option><option value="UNFI">UNFI</option>';
          purchaserSelect.value = "";
          return;
        }
        purchaserSelect.disabled = false;
        var current = purchaserSelect.value;
        var opts = brand !== "all" ? (BRAND_PURCHASERS[brand] || ["DOT_FOODS", "KEHE", "UNFI"]) : ["DOT_FOODS", "KEHE", "UNFI"];
        purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option>' + opts.map(function (p) { return '<option value="' + p + '">' + p + '</option>'; }).join("");
        if (current === "all" || opts.indexOf(current) !== -1) purchaserSelect.value = current;
        else purchaserSelect.value = "";
      }
      function showBrandError(msg) {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = msg || "Please select a brand.";
      }
      function clearBrandError() {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = "";
      }
      function showPurchaserError(msg) {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = msg || "Please select a brand first.";
      }
      function clearPurchaserError() {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = "";
      }
      (function () {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (brandSelect && purchaserSelect) {
          brandSelect.addEventListener("change", function () {
            clearBrandError();
            clearPurchaserError();
            refreshPurchaserOptions();
          });
          purchaserSelect.addEventListener("change", function () {
            if (purchaserSelect.value && purchaserSelect.value !== "all" && (!brandSelect.value || brandSelect.value === "")) {
              showPurchaserError("Please select a brand first.");
            } else {
              clearPurchaserError();
            }
          });
          refreshPurchaserOptions();
        }
      })();
    </script>
  </body>
</html>
