<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelliExtract Runner — intellirevenue</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f5f7f9;
        --surface: #ffffff;
        --text: #2c2c2c;
        --text-secondary: #5a5a5a;
        --border: #c5cdd1;
        --border-light: #dfe4e8;
        --header-bg: #216c6d;
        --header-text: #ffffff;
        --header-border: #1a5758;
        --accent: #2d9d5f;
        --accent-light: #e8f5ee;
        --primary: #2d9d5f;
        --primary-hover: #248f54;
        --pass: #248f54;
        --pass-bg: #e8f5ee;
        --fail: #c62828;
        --fail-bg: #ffebee;
        --muted: #6b7c85;
        --row-alt: #fafbfc;
        --cell-pad: 0.722rem 0.85rem;
        --radius: 6.8px;
        --radius-sm: 5.1px;
        --radius-xs: 3.4px;
        --shadow-sm: 0 0.85px 2.55px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 1.7px 6.8px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 3.4px 10.2px rgba(0, 0, 0, 0.08);
        --shadow-inset: inset 0 0.85px 1.7px rgba(0, 0, 0, 0.06);
        --shadow-btn: 0 0.85px 2.55px rgba(0, 0, 0, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "JetBrains Mono", "Consolas", "Courier New", monospace;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
        /* Slightly smaller base font size for better fit on lower resolutions */
        font-size: 12px;
        display: flex;
        flex-direction: column;
      }
      .header {
        flex-shrink: 0;
        background: var(--surface);
        border: 0.85px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        margin: 1.062rem 1.275rem;
        box-sizing: border-box;
      }
      .header-inner {
        max-width: 100%;
        margin: 0;
        padding: 0.75rem 1.275rem;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 1.275rem;
        flex-wrap: wrap;
      }
      .header-right {
        margin-left: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        gap: 0;
        flex-shrink: 0;
        padding-top: 0;
      }
      .header-filter-row {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        flex-wrap: wrap;
        margin-top: 0.75rem;
      }
      .header-field-wrap {
        display: grid;
        grid-template-columns: auto minmax(9.35rem, 1fr);
        grid-template-rows: auto minmax(1.062em, auto);
        align-items: center;
        column-gap: 0.425rem;
        row-gap: 0.17rem;
        justify-content: start;
      }
      .header-field-wrap > .header-label {
        grid-column: 1;
        grid-row: 1;
      }
      .header-field-wrap > .header-select {
        grid-column: 2;
        grid-row: 1;
      }
      .header-field-wrap > .header-field-error {
        grid-column: 2;
        grid-row: 2;
      }
      .header-field-error {
        color: var(--fail);
        font-size: 0.75rem;
        min-height: 1.062em;
        line-height: 1.2;
      }
      .header .logo {
        height: 30.6px;
        width: auto;
        display: block;
        object-fit: contain;
        margin-top: -6.8px;
      }
      .header .logo-placeholder {
        height: 30.6px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1rem;
        margin-top: -6.8px;
      }
      .header-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        white-space: nowrap;
        font-weight: 600;
      }
      .header-select {
        width: 180px;
        min-width: 180px;
        max-width: 180px;
        height: 34px;
        padding: 0.297rem 1.7rem 0.297rem 0.51rem;
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.425rem center;
        box-sizing: border-box;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.8);
        transition:
          border-color 0.15s ease,
          box-shadow 0.15s ease;
      }
      .header-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .header-select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background: var(--row-alt);
      }
      .filter-dropdown {
        position: relative;
        width: 180px;
        min-width: 180px;
      }
      .filter-dropdown-trigger {
        width: 100%;
        height: 34px;
        padding: 0.297rem 1.7rem 0.297rem 0.51rem;
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        text-align: left;
        cursor: pointer;
        box-sizing: border-box;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.8);
        transition:
          border-color 0.15s ease,
          box-shadow 0.15s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.425rem center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .filter-dropdown-trigger:hover {
        border-color: var(--border-light);
        box-shadow:
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .filter-dropdown-trigger:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .filter-dropdown-panel {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 1.7px;
        min-width: 100%;
        max-height: 187px;
        overflow-y: auto;
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        box-shadow: var(--shadow-md);
        z-index: 100;
        padding: 0.297rem 0;
      }
      .filter-dropdown-panel.open {
        display: block;
      }
      .filter-dropdown-option {
        display: flex;
        align-items: center;
        gap: 0.425rem;
        padding: 0.34rem 0.51rem;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
      }
      .filter-dropdown-option:hover {
        background: var(--row-alt);
      }
      .filter-dropdown-option input {
        margin: 0;
        cursor: pointer;
      }
      .header-filter-reset-wrap {
        align-self: flex-end;
      }
      .header-btn-reset {
        height: 34px;
        padding: 0 0.85rem;
        min-width: 180px;
        border: 0.85px solid #244a7a;
        border-radius: var(--radius-sm);
        background: #2f5496;
        color: var(--header-text);
        font-size: 0.875rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.1),
          inset 0 0.85px 0 rgba(255, 255, 255, 0.15);
        transition:
          background 0.15s ease,
          border-color 0.15s ease,
          box-shadow 0.15s ease;
      }
      .header-btn-reset:focus {
        outline: none;
        border-color: var(--header-text);
        box-shadow:
          0 0 0 1.7px rgba(255, 255, 255, 0.3),
          0 1.7px 3.4px rgba(0, 0, 0, 0.1);
      }
      .header-btn-reset:hover {
        background: #244a7a;
        border-color: #244a7a;
        color: var(--header-text);
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 0 1.275rem 1.062rem 1.275rem;
        max-width: 100%;
      }
      .table-section {
        flex: 1 1 0%;
        min-height: 0;
        overflow: auto;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border: 0.85px solid var(--border);
        border-radius: var(--radius);
        box-shadow:
          0 3.4px 17px rgba(0, 0, 0, 0.1),
          0 1.7px 6.8px rgba(0, 0, 0, 0.06);
      }
      .table-section table {
        height: 100%;
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: var(--surface);
        border-radius: var(--radius);
      }
      th,
      td {
        padding: var(--cell-pad);
        text-align: left;
        border: 0.85px solid var(--border);
        vertical-align: middle;
      }
      thead th:first-child {
        border-top-left-radius: 0;
      }
      thead th:last-child {
        border-top-right-radius: 0;
      }
      thead tr {
        height: 40.8px;
      }
      thead th {
        height: 40.8px;
        box-sizing: border-box;
      }
      tbody {
        height: 100%;
      }
      tbody tr {
        height: 33.333%;
      }
      tbody td {
        height: 33.333%;
        box-sizing: border-box;
      }
      thead th {
        background: var(--header-bg);
        color: var(--header-text);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: none;
        letter-spacing: 0.02em;
        border-color: var(--header-border);
      }
      tbody tr {
        background: var(--surface);
      }
      tbody tr:nth-child(even) {
        background: var(--row-alt);
      }
      tbody tr:hover td {
        background: #f0f9f4;
      }
      tbody tr.row-inactive {
        opacity: 0.85;
      }
      tbody tr.row-inactive td:not(.op-name) {
        background: var(--row-alt);
      }
      tbody tr.row-inactive button:disabled,
      tbody tr.row-inactive input:disabled {
        cursor: not-allowed;
      }
      .op-name {
        width: 181.9px;
        min-width: 181.9px;
        max-width: 181.9px;
        font-weight: 600;
      }
      thead th.op-name {
        color: var(--header-text);
      }
      tbody td.op-name {
        background: var(--header-bg);
        color: #ffffff;
        border-color: var(--header-border);
      }
      tbody tr:hover td.op-name {
        background: var(--header-bg);
      }
      .limits-col {
        width: 156.35px;
        min-width: 156.35px;
        max-width: 156.35px;
      }
      .limits-cell {
        font-size: 0.85rem;
        color: var(--text-secondary);
        overflow: hidden;
        vertical-align: top;
      }
      .limits-cell .limit-row {
        display: grid;
        grid-template-columns: auto 70.5px;
        gap: 0.425rem 0.637rem;
        align-items: center;
        min-height: 1.87rem;
      }
      .limits-cell .limit-label {
        white-space: nowrap;
        font-weight: 500;
      }
      .limits-cell input[type="number"] {
        width: 70.5px;
        min-width: 70.5px;
        max-width: 70.5px;
        height: 28.05px;
        padding: 0.34rem 0.425rem;
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text);
        background: var(--surface);
        box-sizing: border-box;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.8);
        transition:
          border-color 0.15s ease,
          box-shadow 0.15s ease;
      }
      .limits-cell input[type="number"]::-webkit-inner-spin-button,
      .limits-cell input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
      }
      .limits-cell input[type="number"]:hover:not(:disabled) {
        border-color: var(--border-light);
        box-shadow:
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .limits-cell input[type="number"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .limits-cell input[type="number"]:disabled {
        background: var(--row-alt);
        box-shadow: inset 0 0.85px 1.7px rgba(0, 0, 0, 0.05);
      }
      .limits-cell .limit-hint {
        margin-top: 0.425rem;
        padding: 0.297rem 0.425rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary);
        background: var(--accent-light);
        border-radius: var(--radius-xs);
        border: 0.85px solid rgba(45, 157, 95, 0.25);
        display: inline-block;
      }
      .limits-cell .n/a {
        color: var(--muted);
        font-style: italic;
      }
      .run-cell {
        width: 136.85px;
        min-width: 136.85px;
        max-width: 136.85px;
        text-align: center;
        vertical-align: top;
      }
      .run-cell .btn-group {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.425rem;
        width: 100%;
        margin: 0 auto;
        min-width: 0;
        box-sizing: border-box;
      }
      .run-cell .btn-row {
        display: contents;
      }
      .run-cell .btn-group > .btn-row > button {
        min-width: 0;
      }
      button.run {
        background: var(--primary);
        color: #fff;
        border: 0.85px solid var(--header-border);
        border-radius: var(--radius-sm);
        padding: 0.552rem 1.062rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-btn);
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      button.run:hover:not(:disabled) {
        background: var(--primary-hover);
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.18);
      }
      button.run:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      button.reset-case {
        background: var(--surface);
        color: var(--text-secondary);
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.468rem 0.85rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      button.reset-case:hover {
        background: var(--row-alt);
        color: var(--text);
        box-shadow: 0 1.7px 3.4px rgba(0, 0, 0, 0.1);
      }
      button.reset-case.stop-btn {
        background: var(--fail);
        color: #fff;
        border-color: var(--fail);
        box-shadow: var(--shadow-btn);
      }
      button.reset-case.stop-btn:hover {
        background: #a00;
        border-color: #a00;
        color: #fff;
      }
      button.reset-case.resume-btn {
        background: var(--accent-light);
        border-color: var(--accent);
        color: var(--accent);
      }
      button.reset-case.resume-btn:hover {
        background: var(--accent);
        color: #fff;
      }
      button.reset-during-resume {
        display: none !important;
      }
      button.reset-during-resume.show-during-resume {
        display: block !important;
        width: 100%;
        min-height: 2.337rem;
        box-sizing: border-box;
        padding: 0.552rem 1.062rem;
        font-size: 0.9rem;
      }
      button.download-sync-report-btn,
      button.download-report-btn {
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.468rem 0.722rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-sizing: border-box;
        box-shadow: var(--shadow-btn);
        color: #fff;
        min-width: 180px;
      }
      button.download-sync-report-btn {
        background: #2f5496;
      }
      button.download-sync-report-btn:hover:not(:disabled) {
        background: #244a7a;
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.2);
      }
      button.download-report-btn.download-report-html-btn {
        background: #2f5496;
      }
      button.download-report-btn.download-report-html-btn:hover:not(:disabled) {
        background: #244a7a;
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.2);
      }
      button.download-report-btn.download-report-json-btn {
        background: #2f5496;
      }
      button.download-report-btn.download-report-json-btn:hover:not(:disabled) {
        background: #244a7a;
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.2);
      }
      button.download-report-btn.download-report-schedule-btn {
        background: #2f5496;
      }
      button.download-report-btn.download-report-schedule-btn:hover:not(
          :disabled
        ) {
        background: #244a7a;
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.2);
      }
      button.download-sync-report-btn:disabled,
      button.download-report-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .download-bar {
        display: flex;
        align-items: center;
        gap: 0.637rem;
        padding: 0.51rem 0.85rem;
        background: var(--surface);
        border: 0.85px solid var(--border-light);
        border-radius: 0;
        margin-bottom: 0;
        flex-wrap: wrap;
      }
      .download-bar-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .download-bar-btns {
        display: flex;
        align-items: center;
        gap: 0.425rem;
        flex-wrap: wrap;
      }
      .download-bar-btns .download-sync-report-btn,
      .download-bar-btns .download-report-btn {
        margin: 0;
      }
      .result-header {
        width: 402.9px;
        min-width: 402.9px;
        max-width: 402.9px;
      }
      .result-cell {
        width: 402.9px;
        min-width: 402.9px;
        max-width: 402.9px;
        vertical-align: top;
        overflow: hidden;
        position: relative;
      }
      .result {
        position: absolute;
        top: 0.722rem;
        left: 0.85rem;
        right: 0.85rem;
        bottom: 0.722rem;
        font-family: "JetBrains Mono", "Consolas", "Courier New", monospace;
        font-size: 0.8rem;
        padding: 0.51rem 0.637rem;
        white-space: pre-wrap;
        word-break: break-word;
        border: 0.85px solid var(--border-light);
        border-radius: var(--radius);
        background: #fafafa;
        overflow: auto;
        box-sizing: border-box;
        box-shadow: var(--shadow-sm);
      }
      .result.pass {
        background: var(--pass-bg);
        border-color: #b8e0c8;
      }
      .result.fail {
        background: var(--fail-bg);
        border-color: #f8d4d4;
      }
      .result.running {
        background: var(--accent-light);
        border-color: #b8e0c8;
      }
      .result.running .loading-dots::after {
        content: "";
        animation: loading-dots 1.2s steps(4, end) infinite;
      }
      @keyframes loading-dots {
        0%,
        20% {
          content: "";
        }
        40% {
          content: ".";
        }
        60% {
          content: "..";
        }
        80%,
        100% {
          content: "...";
        }
      }
      .result .sync-progress-wrap {
        margin-top: 0.51rem;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text);
      }
      .result .sync-progress-wrap:first-of-type {
        margin-top: 0.425rem;
      }
      .result .extraction-progress-wrap {
        margin-top: 0.637rem;
      }
      .result .skip-progress-wrap {
        margin-top: 0.425rem;
        color: var(--muted);
      }
      .result .sync-progress-fill.skip-fill {
        background: linear-gradient(180deg, #8b9da8 0%, #6b7c85 100%);
      }
      .result .sync-progress-bar {
        width: 100%;
        height: 18.7px;
        background: var(--border-light);
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-top: 0.425rem;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 1.7px rgba(0, 0, 0, 0.06);
        border: 0.85px solid var(--border);
      }
      .result .sync-progress-fill {
        height: 100%;
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--primary-hover) 100%
        );
        border-radius: calc(var(--radius-sm) - 0.85px);
        transition: width 0.2s ease-out;
        box-shadow: inset 0 0.85px 0 rgba(255, 255, 255, 0.25);
      }
      .result .sync-progress-fill.sync-progress-indeterminate {
        animation: sync-indeterminate 1.2s ease-in-out infinite;
      }
      @keyframes sync-indeterminate {
        0%,
        100% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(150%);
        }
      }
      .result.result-placeholder .result-placeholder-text {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: italic;
      }
      .result.result-validation-alert .result-placeholder-text {
        color: var(--fail);
        font-style: normal;
        padding: 0.425rem 0.637rem;
        background: var(--fail-bg);
        border: 0.85px solid rgba(198, 40, 40, 0.25);
        border-radius: var(--radius-sm);
        display: inline-block;
      }
      .result .exit {
        font-weight: 600;
        margin-bottom: 0.17rem;
        color: var(--text);
      }
      .result .out {
        color: var(--text-secondary);
      }
      .result-table-wrap {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8rem;
        table-layout: fixed;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-inset);
      }
      .result-table-wrap th,
      .result-table-wrap td {
        padding: 0.34rem 0.51rem;
        text-align: left;
        vertical-align: top;
        border: 0.85px solid var(--border-light);
        background: rgba(255, 255, 255, 0.5);
      }
      .result-table-wrap th {
        font-weight: 600;
        color: var(--text);
        width: 195.5px;
        min-width: 195.5px;
      }
      .result-table-wrap td {
        color: var(--text-secondary);
        word-break: break-word;
        white-space: pre-wrap;
      }
      .result-table-wrap tr:first-child th:first-child,
      .result-table-wrap tr:first-child td:first-child {
        border-top-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:first-child th:last-child,
      .result-table-wrap tr:first-child td:last-child {
        border-top-right-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:first-child,
      .result-table-wrap tr:last-child td:first-child {
        border-bottom-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:last-child,
      .result-table-wrap tr:last-child td:last-child {
        border-bottom-right-radius: var(--radius-sm);
      }
      .info-icon {
        display: inline-block;
        margin-left: 0.15rem;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid var(--primary);
        color: var(--primary);
        font-size: 0.8rem;
        font-weight: 700;
        line-height: 14px;
        text-align: center;
        cursor: default;
        background: var(--accent-light);
        vertical-align: middle;
      }
      .info-icon:hover {
        border-color: var(--primary-hover);
        color: var(--primary-hover);
      }
      .result-table-wrap tr.status-row th {
        border-top: none;
      }
      .result-table-wrap tr.status-row td {
        font-weight: 600;
      }
      .result.pass .result-table-wrap tr.status-row td {
        color: var(--pass);
      }
      .result.fail .result-table-wrap tr.status-row td {
        color: var(--fail);
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        border: 0.85px solid var(--border);
        width: 800px;
        max-width: 90vw;
        height: 650px;
        max-height: 85vh;
        padding: 1.062rem 1.275rem 0.85rem;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.85rem;
        padding-bottom: 0.51rem;
        border-bottom: 0.85px solid var(--border-light);
        background: var(--row-alt);
      }
      .modal-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
      }
      .modal-close-icon {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1rem;
        color: var(--muted);
        padding: 0.17rem;
      }
      .modal-close-icon:hover {
        color: var(--fail);
      }
      .modal-body {
        flex: 1;
        overflow-y: auto;
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
      }
      .modal-footer {
        margin-top: 0.85rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.51rem;
        padding-top: 0.51rem;
        border-top: 0.85px solid var(--border-light);
        background: var(--row-alt);
      }
      .btn-secondary {
        background: var(--surface);
        color: var(--text-secondary);
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.46rem 0.85rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
      }
      .btn-secondary:hover {
        background: var(--row-alt);
        color: var(--text);
      }
      .schedule-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.85rem;
        gap: 0.85rem;
      }
      .schedule-empty {
        color: var(--muted);
        text-align: center;
        padding: 2rem 1rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .schedule-list {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }
      .schedule-list th,
      .schedule-list td {
        padding: 0.34rem 0.51rem;
        border: 0.85px solid var(--border-light);
        text-align: left;
        vertical-align: top;
      }
      .schedule-form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 0.68rem 0.85rem;
        margin-top: 0.34rem;
      }
      .schedule-field {
        display: flex;
        flex-direction: column;
        gap: 0.21rem;
      }
      .schedule-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
      }
      .schedule-hint {
        font-size: 0.78rem;
        color: var(--muted);
      }
      .schedule-select,
      .schedule-input {
        width: 100%;
        height: 27.2px;
        padding: 0.297rem 0.51rem;
        border: 0.85px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-size: 0.85rem;
        font-family: inherit;
        box-sizing: border-box;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.8);
      }
      .schedule-select:focus,
      .schedule-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .schedule-error {
        margin-top: 0.34rem;
        font-size: 0.78rem;
        color: var(--fail);
      }
      .schedule-field .filter-dropdown {
        width: 100%;
        min-width: 100%;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <img
          src="/assets/logo.png"
          alt="intellirevenue"
          class="logo"
          id="logo-img"
        />
        <span class="logo-placeholder" style="display: none"
          >intellirevenue</span
        >
        <div class="header-right">
          <div class="header-filter-row">
            <div class="header-field-wrap">
              <label class="header-label" for="brand-dropdown-trigger"
                >Brand</label
              >
              <div id="brand-dropdown" class="filter-dropdown">
                <button
                  type="button"
                  id="brand-dropdown-trigger"
                  class="filter-dropdown-trigger"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  title="Select one or more brands"
                >
                  Select brand
                </button>
                <div
                  id="brand-dropdown-panel"
                  class="filter-dropdown-panel"
                  role="listbox"
                >
                  <!-- brand options populated dynamically from /api/config -->
                </div>
              </div>
              <div
                id="brand-error"
                class="header-field-error"
                role="alert"
              ></div>
            </div>
            <div class="header-field-wrap">
              <label class="header-label" for="purchaser-dropdown-trigger"
                >Purchaser</label
              >
              <div id="purchaser-dropdown" class="filter-dropdown">
                <button
                  type="button"
                  id="purchaser-dropdown-trigger"
                  class="filter-dropdown-trigger"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  title="Select one or more purchasers"
                >
                  Select purchaser
                </button>
                <div
                  id="purchaser-dropdown-panel"
                  class="filter-dropdown-panel"
                  role="listbox"
                >
                  <!-- options filled by JS based on selected brands -->
                </div>
              </div>
              <div
                id="purchaser-error"
                class="header-field-error"
                role="alert"
              ></div>
            </div>
            <div class="header-field-wrap header-filter-reset-wrap">
              <label class="header-label" style="visibility: hidden"
                >Reset</label
              >
              <button
                type="button"
                id="filter-reset-btn"
                class="header-btn-reset"
                title="Clear brand and purchaser filter"
              >
                Reset Filter
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="table-section">
        <div class="download-bar" id="download-bar">
          <span class="download-bar-label">Reports & downloads</span>
          <div class="download-bar-btns" id="download-bar-btns"></div>
        </div>
        <table>
          <thead>
            <tr>
              <th class="op-name">Operations</th>
              <th class="limits-col">Batch limits</th>
              <th class="run-cell">Run controls</th>
              <th class="result-header">Run output</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>

    <div id="schedule-modal-overlay" class="modal-overlay" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="schedule-modal-title"
      >
        <div class="modal-header">
          <div class="modal-title" id="schedule-modal-title">
            Schedule automatic sync &amp; extraction
          </div>
          <button
            type="button"
            id="schedule-modal-close-icon"
            class="modal-close-icon"
            aria-label="Close schedule dialog"
          >
            &#10005;
          </button>
        </div>
        <div class="modal-body" id="schedule-modal-body"></div>
      </div>
    </div>

    <script type="module">
      (function () {
        var logo = document.getElementById("logo-img");
        var placeholder = logo && logo.nextElementSibling;
        if (logo) {
          if (location.protocol === "file:") logo.src = "assets/logo.png";
          logo.addEventListener("error", function () {
            logo.style.display = "none";
            if (placeholder) placeholder.style.display = "flex";
          });
        }
      })();
      const ROWS = [
        {
          id: "P1",
          scenario: "S3 Sync — Download files to staging.",
          limits: { sync: true, extract: false },
        },
        {
          id: "P2",
          scenario: "Extract — Run extraction with staging files (No S3 sync).",
          limits: { sync: false, extract: true },
        },
        {
          id: "PIPE",
          scenario: "Sync & Extract — Sync from S3 then extract in one run.",
          limits: { pipeline: true },
        },
      ];

      function renderLimitsCell(c) {
        const lim = c.limits || {
          sync: false,
          extract: false,
          pipeline: false,
        };
        if (!lim.sync && !lim.extract && !lim.pipeline) {
          return '<td class="limits-cell"><span class="n/a">—</span></td>';
        }
        var html = '<td class="limits-cell"><div class="limit-row">';
        if (lim.pipeline) {
          html +=
            '<span class="limit-label">Limit:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to sync; each is extracted in background as it is synced. 0 = no limit">';
        } else {
          if (lim.sync) {
            html +=
              '<span class="limit-label">Sync:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to download. 0 = no limit">';
          }
          if (lim.extract) {
            html +=
              '<span class="limit-label">Extract:</span><input type="number" class="limit-extract" min="0" step="1" value="0" title="Max files to extract. 0 = no limit">';
          }
        }
        html += '</div><div class="limit-hint">0 = no limit</div></td>';
        return html;
      }

      function getRunButtonLabel(caseId) {
        if (caseId === "P1") return "Start Sync";
        if (caseId === "P2") return "Start Extraction";
        if (caseId === "PIPE") return "Sync & Extract";
        return "Run";
      }

      function renderRow(c, sectionId) {
        const tr = document.createElement("tr");
        const resultCell = document.createElement("td");
        resultCell.className = "result-cell";
        const resultDiv = document.createElement("div");
        resultDiv.className = "result result-placeholder";
        resultDiv.id = "result-" + c.id;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
        resultCell.appendChild(resultDiv);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "run";
        btn.textContent = getRunButtonLabel(c.id);
        btn.title = btn.textContent;
        btn.onclick = function () {
          runCase(c.id, btn, resultDiv, null);
        };
        const resetBtn = document.createElement("button");
        resetBtn.type = "button";
        resetBtn.className = "reset-case";
        resetBtn.textContent = "Reset";
        resetBtn.onclick = function () {
          resetCase(resultDiv);
        };
        const resetDuringResumeBtn = document.createElement("button");
        resetDuringResumeBtn.type = "button";
        resetDuringResumeBtn.className = "reset-case reset-during-resume";
        resetDuringResumeBtn.textContent = "Reset";
        resetDuringResumeBtn.title = "Clear result and exit resume mode";
        resetDuringResumeBtn.onclick = function () {
          resetCase(resultDiv);
          resetDuringResumeBtn.classList.remove("show-during-resume");
          resetBtn.textContent = "Reset";
          resetBtn.classList.remove("resume-btn");
          resetBtn.onclick = function () {
            resetCase(resultDiv);
          };
          if (tr._resumeSync !== undefined) delete tr._resumeSync;
          if (tr._resumeExtract !== undefined) delete tr._resumeExtract;
        };
        tr.innerHTML =
          '<td class="op-name">' +
          escapeHtml(c.scenario) +
          "</td>" +
          renderLimitsCell(c) +
          '<td class="run-cell"><div class="btn-group"><div class="btn-row"></div></div></td>';
        tr.querySelector(".btn-row").appendChild(btn);
        tr.querySelector(".btn-row").appendChild(resetBtn);
        tr.querySelector(".btn-row").appendChild(resetDuringResumeBtn);
        tr.appendChild(resultCell);
        tr.setAttribute("data-case-id", c.id);
        return tr;
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showResult(
        div,
        data,
        pass,
        progress,
        syncProgress,
        extractionProgress,
        caseId,
        resumeSkipSyncProgress,
        resumeSkipExtractProgress,
      ) {
        div.style.display = "block";
        var resultClass = "running";
        if (data) resultClass = pass ? "pass" : "fail";
        div.className = "result " + resultClass;
        var row = div.closest("tr");
        if (!data) {
          var label;
          var extra = "";
          var hasResumeSkipSync =
            resumeSkipSyncProgress != null &&
            (resumeSkipSyncProgress.skipped != null ||
              resumeSkipSyncProgress.total != null);
          var hasResumeSkipExtract =
            resumeSkipExtractProgress != null &&
            (resumeSkipExtractProgress.skipped != null ||
              resumeSkipExtractProgress.total != null);
          var hasSync =
            syncProgress != null &&
            (syncProgress.done != null || syncProgress.total != null);
          var hasExtraction =
            extractionProgress != null &&
            (extractionProgress.done != null ||
              extractionProgress.total != null);
          if (hasResumeSkipSync && caseId !== "PIPE") {
            var skipSync = Number(resumeSkipSyncProgress.skipped) || 0;
            var skipSyncTotal = Number(resumeSkipSyncProgress.total) || 0;
            var skipSyncPct =
              skipSyncTotal > 0
                ? Math.min(100, Math.round((100 * skipSync) / skipSyncTotal))
                : 100;
            extra +=
              '<div class="sync-progress-wrap skip-progress-wrap">Skipping synced files: ' +
              skipSync +
              " / " +
              skipSyncTotal +
              " skipped</div>" +
              '<div class="sync-progress-bar"><div class="sync-progress-fill skip-fill" style="width:' +
              skipSyncPct +
              '%"></div></div>';
          }
          if (hasResumeSkipExtract) {
            var skipExt = Number(resumeSkipExtractProgress.skipped) || 0;
            var skipExtTotal = Number(resumeSkipExtractProgress.total) || 0;
            var skipExtPct =
              skipExtTotal > 0
                ? Math.min(100, Math.round((100 * skipExt) / skipExtTotal))
                : 100;
            extra +=
              '<div class="sync-progress-wrap skip-progress-wrap">Skipping extracted files: ' +
              skipExt +
              " / " +
              skipExtTotal +
              " skipped</div>" +
              '<div class="sync-progress-bar"><div class="sync-progress-fill skip-fill" style="width:' +
              skipExtPct +
              '%"></div></div>';
          }
          if (hasSync) {
            var done = Number(syncProgress.done) || 0;
            var total = Number(syncProgress.total) || 0;
            var pct =
              total > 0 ? Math.min(100, Math.round((100 * done) / total)) : 0;
            extra +=
              '<div class="sync-progress-wrap">Downloading: ' +
              (total > 0 ? done + " / " + total : done + " file(s)") +
              "</div>" +
              (total > 0
                ? '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' +
                  pct +
                  '%"></div></div>'
                : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          }
          if (hasExtraction) {
            var extDone = Number(extractionProgress.done) || 0;
            var extTotal = Number(extractionProgress.total) || 0;
            var extPct =
              extTotal > 0
                ? Math.min(100, Math.round((100 * extDone) / extTotal))
                : 0;
            extra +=
              '<div class="sync-progress-wrap extraction-progress-wrap">Extracting: ' +
              (extTotal > 0
                ? extDone + " / " + extTotal
                : extDone + " file(s)") +
              "</div>" +
              (extTotal > 0
                ? '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' +
                  extPct +
                  '%"></div></div>'
                : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          }
          var showDots = true;
          if (
            hasResumeSkipSync ||
            hasResumeSkipExtract ||
            hasSync ||
            hasExtraction
          ) {
            showDots = false;
            var showSyncSkipLabel = hasResumeSkipSync && caseId !== "PIPE";
            label = showSyncSkipLabel
              ? "Skipping synced files…"
              : hasResumeSkipExtract && !hasSync && !hasExtraction
                ? "Skipping extracted files…"
                : hasResumeSkipExtract && (hasSync || hasExtraction)
                  ? "Skipped extract, syncing/extracting…"
                  : hasSync && hasExtraction
                    ? "Sync & extract…"
                    : hasSync
                      ? "Syncing…"
                      : "Extracting…";
          } else {
            var pctVal =
              progress && progress.percent != null
                ? Number(progress.percent)
                : null;
            var doneVal =
              progress && progress.done != null ? Number(progress.done) : null;
            var totalVal =
              progress && progress.total != null
                ? Number(progress.total)
                : null;
            if (
              pctVal != null &&
              totalVal != null &&
              totalVal > 0 &&
              doneVal != null
            ) {
              label =
                "Running… " + pctVal + "% (" + doneVal + " / " + totalVal + ")";
              showDots = false;
            } else if (pctVal != null) {
              label = "Running… " + pctVal + "%";
              showDots = false;
            } else {
              label = "Running…";
            }
          }
          div.innerHTML =
            '<span class="exit">' +
            escapeHtml(label) +
            (showDots ? '<span class="loading-dots"></span>' : "") +
            "</span>" +
            extra;
          return;
        }
        var stdoutStr = (data.stdout && String(data.stdout).trim()) || "";
        var stderrStr = (data.stderr && String(data.stderr).trim()) || "";
        var syncProgressPrefix = "SYNC_PROGRESS\t";
        function filterResultLine(line) {
          if (line.indexOf(syncProgressPrefix) === 0) return false;
          if (
            line.indexOf("RESUME_SKIP\t") === 0 ||
            line.indexOf("RESUME_SKIP_SYNC\t") === 0
          )
            return false;
          if (line.indexOf("Report(s) written:") !== -1) return false;
          if (/Run run_\S+ finished\./.test(line)) return false;
          return true;
        }
        var stdoutFiltered = stdoutStr
          ? stdoutStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var stderrFiltered = stderrStr
          ? stderrStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var statusLabel = pass ? "Pass" : "Fail";
        var parsed = {};
        var lines = stdoutFiltered ? stdoutFiltered.split("\n") : [];
        for (var i = 0; i < lines.length; i++) {
          var line = (lines[i] || "").trim().replace(/\r$/, "");
          var m;
          if ((m = /^Download limit:\s*(.+)$/.exec(line)))
            parsed.downloadLimit = m[1].trim();
          else if ((m = /^Downloaded \(new\):\s*(\d+)\s*$/.exec(line)))
            parsed.downloadedNew = m[1];
          else if (
            (m = /^Skipped \(already present[^:]*:\s*(\d+)\s*$/.exec(line))
          )
            parsed.skipped = m[1];
          else if ((m = /^Errors:\s*(\d+)\s*$/.exec(line)))
            parsed.errors = m[1];
          else if ((m = /^\s+Staging path:\s*(.+)$/.exec(line))) {
            if (!parsed.stagingPaths) parsed.stagingPaths = [];
            parsed.stagingPaths.push(m[1].trim());
          } else if (
            (m = /^Scoped to tenant:\s*([^,]+),\s*purchaser:\s*(.+)$/.exec(
              line,
            ))
          ) {
            parsed.brandAndPurchaser = (
              m[1].trim() +
              " / " +
              m[2].trim()
            ).trim();
          } else if (
            (m = /^\s{2}([^:\s][^:]*)\s*$/.exec(line)) &&
            line.indexOf("/") !== -1 &&
            !/Staging path|Downloaded:|Skipped:|Errors:/.test(line)
          ) {
            if (!parsed.brandAndPurchaserList)
              parsed.brandAndPurchaserList = [];
            parsed.brandAndPurchaserList.push(line.trim());
          } else if (
            (m =
              /^Extraction metrics:\s*success=(\d+),\s*skipped=(\d+),\s*failed=(\d+)\s*$/.exec(
                line,
              ))
          ) {
            // Match CLI output: "Extraction metrics: success=X, skipped=Y, failed=Z"
            parsed.extractSuccess = m[1];
            parsed.extractSkipped = m[2];
            parsed.extractFailed = m[3];
          } else if (
            (m = /^Extraction result\(s\):\s*(.+?)\s*\(full/.exec(line))
          )
            parsed.extractionResultsPath = m[1].trim();
          else if ((m = /^Reports path:\s*(.+)$/.exec(line)))
            parsed.reportsPath = m[1].trim();
        }
        var syncCases = ["P1", "PIPE", "P5"];
        var extractCases = ["P2", "PIPE", "P5", "P3"];
        var hasSync =
          caseId &&
          syncCases.indexOf(caseId) !== -1 &&
          (parsed.downloadLimit != null || parsed.downloadedNew != null);
        var hasExtract =
          caseId &&
          extractCases.indexOf(caseId) !== -1 &&
          (parsed.extractSuccess != null ||
            parsed.extractionResultsPath != null ||
            parsed.reportsPath != null);
        var allExtractZero =
          (parsed.extractSuccess === "0" || parsed.extractSuccess === 0) &&
          (parsed.extractFailed === "0" || parsed.extractFailed === 0) &&
          (parsed.extractSkipped === "0" || parsed.extractSkipped === 0);
        var noSyncDownloaded =
          parsed.downloadedNew == null || parsed.downloadedNew === "0";
        var hasExtractionMetrics =
          parsed.extractSuccess != null ||
          parsed.extractFailed != null ||
          parsed.extractSkipped != null;
        var syncOnlyNoFiles =
          hasSync && noSyncDownloaded && !hasExtractionMetrics;
        var extractOrPipelineNoFiles =
          hasExtractionMetrics &&
          allExtractZero &&
          (noSyncDownloaded || !hasSync);
        var pipelineNoFiles =
          caseId === "PIPE" &&
          pass &&
          (allExtractZero || (hasSync && noSyncDownloaded));
        var noFilesFound =
          pass &&
          (syncOnlyNoFiles || extractOrPipelineNoFiles || pipelineNoFiles);
        var rows = [];
        rows.push(["Status", statusLabel]);
        if (noFilesFound) {
          rows.push(["Message", "No files found to sync or extract."]);
        } else {
          if (hasSync) {
            var brandPurchaser =
              parsed.brandAndPurchaser ||
              (parsed.brandAndPurchaserList &&
              parsed.brandAndPurchaserList.length
                ? parsed.brandAndPurchaserList.join("\n")
                : null);
            if (brandPurchaser)
              rows.push(["Brand and purchaser", brandPurchaser]);
            if (parsed.stagingPaths && parsed.stagingPaths.length)
              rows.push(["Staging path", parsed.stagingPaths.join("\n")]);
            var overview = [];
            if (parsed.downloadedNew != null)
              overview.push("Downloaded: " + escapeHtml(parsed.downloadedNew));
            if (parsed.skipped != null) {
              var skippedLabel = escapeHtml(parsed.skipped);
              var skippedHtml =
                'Skipped<span class="info-icon" title="These files were already synced in a previous run and are unchanged, so they were skipped.">i</span>: ' +
                skippedLabel;
              overview.push(skippedHtml);
            }
            if (parsed.errors != null)
              overview.push("Errors: " + escapeHtml(parsed.errors));
            if (overview.length)
              rows.push(["Download overview", overview.join(", ")]);
          }
          if (hasExtract) {
            if (parsed.brandAndPurchaser && !hasSync)
              rows.push(["Brand and purchaser", parsed.brandAndPurchaser]);
            if (
              parsed.extractSuccess != null ||
              parsed.extractFailed != null ||
              parsed.extractSkipped != null
            ) {
              var successVal = parsed.extractSuccess || "0";
              var skippedVal = parsed.extractSkipped || "0";
              var failedVal = parsed.extractFailed || "0";
              var skippedLabel2 = escapeHtml(skippedVal);
              var detail =
                "Success: " +
                escapeHtml(successVal) +
                ', Skipped<span class="info-icon" title="These files were already extracted in a previous run, so they were skipped this time.">i</span>: ' +
                skippedLabel2 +
                ", Failed: " +
                escapeHtml(failedVal);
              rows.push(["Extraction overview", detail]);
            }
            if (parsed.extractionResultsPath)
              rows.push(["Extraction path", parsed.extractionResultsPath]);
            if (parsed.reportsPath)
              rows.push(["Reports path", parsed.reportsPath]);
          }
          if (!hasSync && !hasExtract && stdoutFiltered) {
            rows.push([
              "Output",
              escapeHtml(stdoutFiltered.slice(0, 1500)) +
                (stdoutFiltered.length > 1500 ? "…" : ""),
            ]);
          } else if (rows.length === 1) {
            var noOutput = !stdoutFiltered && !stderrFiltered;
            rows.push([
              "Output",
              noOutput && data.exitCode === 0
                ? "Command completed successfully with no console output."
                : noOutput
                  ? "Command produced no output. Check server logs or run in a terminal for details."
                  : "—",
            ]);
          }
        }
        if (stderrFiltered)
          rows.push([
            "Standard error",
            escapeHtml(stderrFiltered.slice(0, 2000)) +
              (stderrFiltered.length > 2000 ? "…" : ""),
          ]);
        var tableRows = rows.map(function (r) {
          return (
            "<tr" +
            (r[0] === "Status" ? ' class="status-row"' : "") +
            "><th>" +
            escapeHtml(r[0]) +
            "</th><td>" +
            (r[0] === "Standard error" ||
            r[0] === "Output" ||
            r[0] === "Download overview" ||
            r[0] === "Extraction overview"
              ? r[1]
              : escapeHtml(r[1]).replace(/\n/g, "<br>")) +
            "</td></tr>"
          );
        });
        div.innerHTML =
          '<table class="result-table-wrap">' + tableRows.join("") + "</table>";
      }

      function resetCase(resultDiv, options) {
        if (!resultDiv) return;
        var row = resultDiv.closest("tr");
        // If this row has an active controller (in-flight run), abort it so reset truly stops execution.
        if (
          row &&
          row._activeController &&
          !row._activeController.signal.aborted
        ) {
          row._abortedByHardReset = true;
          try {
            row._activeController.abort();
          } catch (_) {}
        }
        var clearLimits = !options || options.clearLimits !== false;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
        resultDiv.className = "result result-placeholder";
        if (row) {
          var inputs = row.querySelectorAll(".limit-sync, .limit-extract");
          inputs.forEach(function (input) {
            input.disabled = false;
          });
          if (clearLimits) {
            inputs.forEach(function (input) {
              input.value = "0";
            });
          }
          if (row._resumeSyncLimit !== undefined) delete row._resumeSyncLimit;
          if (row._resumeExtractLimit !== undefined)
            delete row._resumeExtractLimit;
          var runBtn = row.querySelector("button.run");
          if (runBtn) {
            runBtn.disabled = false;
            runBtn.title = runBtn.textContent || "";
          }
          setOtherRowsActive();
        }
      }

      var OTHER_RUN_DISABLED_TITLE =
        "Please stop the other run to execute this.";
      var RESUME_OTHER_DISABLED_TITLE =
        "Please reset the other case to execute this.";
      var ROW_INACTIVE_HOVER_TITLE =
        "Please stop and reset the current process to execute this.";
      function setOtherRowsInactive(currentRow, title) {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var msg = title != null ? title : OTHER_RUN_DISABLED_TITLE;
        var rows = tbody.querySelectorAll("tr");
        rows.forEach(function (tr) {
          if (tr === currentRow) return;
          tr.classList.add("row-inactive");
          tr.setAttribute("title", ROW_INACTIVE_HOVER_TITLE);
          var runBtn = tr.querySelector("button.run");
          if (runBtn) {
            runBtn.disabled = true;
            runBtn.title = msg;
          }
          tr.querySelectorAll("button.reset-case").forEach(function (b) {
            b.disabled = true;
          });
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = true;
            },
          );
        });
      }
      function setOtherRowsActive() {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var rows = tbody.querySelectorAll("tr");
        rows.forEach(function (tr) {
          tr.classList.remove("row-inactive");
          tr.removeAttribute("title");
          var runBtn = tr.querySelector("button.run");
          if (runBtn) {
            runBtn.disabled = false;
            runBtn.title = runBtn.textContent || "";
          }
          tr.querySelectorAll("button.reset-case").forEach(function (b) {
            b.disabled = false;
          });
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = false;
            },
          );
        });
      }

      function getParamsFromRow(row) {
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncLimit = syncInput ? Number.parseInt(syncInput.value, 10) : 0;
        var extractLimit = extractInput
          ? Number.parseInt(extractInput.value, 10)
          : 0;
        return {
          syncLimit: Number.isNaN(syncLimit) ? 0 : Math.max(0, syncLimit),
          extractLimit: Number.isNaN(extractLimit)
            ? 0
            : Math.max(0, extractLimit),
        };
      }

      function getSelectedBrands() {
        var panel = document.getElementById("brand-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll("input[type=checkbox]:checked"),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function getSelectedPurchasers() {
        var panel = document.getElementById("purchaser-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll("input[type=checkbox]:checked"),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function hasFilterSelection() {
        return (
          getSelectedBrands().length > 0 || getSelectedPurchasers().length > 0
        );
      }
      function clearValidationAlertWhenFilterSelected() {
        if (!hasFilterSelection()) return;
        var rows = document.getElementById("rows");
        if (!rows) return;
        rows
          .querySelectorAll(".result.result-validation-alert")
          .forEach(function (div) {
            div.className = "result result-placeholder";
            div.innerHTML =
              '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
          });
      }
      function getTenantPurchaserPairs() {
        var brands = getSelectedBrands();
        var purchasers = getSelectedPurchasers();
        if (brands.length === 0 && purchasers.length === 0) return [];
        if (brands.length === 0) brands = Object.keys(BRAND_PURCHASERS || {});
        if (purchasers.length === 0) {
          var set = new Set();
          brands.forEach(function (b) {
            (BRAND_PURCHASERS[b] || []).forEach(function (p) {
              set.add(p);
            });
          });
          purchasers = Array.from(set);
        }
        var pairs = [];
        brands.forEach(function (tenant) {
          var allowed = BRAND_PURCHASERS[tenant];
          if (!allowed) return;
          purchasers.forEach(function (purchaser) {
            if (allowed.indexOf(purchaser) !== -1)
              pairs.push({ tenant: tenant, purchaser: purchaser });
          });
        });
        return pairs;
      }
      function getTenantPurchaser() {
        var pairs = getTenantPurchaserPairs();
        if (pairs.length === 0)
          return { tenant: undefined, purchaser: undefined, pairs: [] };
        if (pairs.length === 1)
          return {
            tenant: pairs[0].tenant,
            purchaser: pairs[0].purchaser,
            pairs: pairs,
          };
        return { tenant: undefined, purchaser: undefined, pairs: pairs };
      }

      async function runCase(caseId, btn, resultDiv, runOptions) {
        var isResume = runOptions && runOptions.resume === true;
        var row = btn.closest("tr");
        if (row && isResume) {
          row._aborted = false;
        }
        if (!hasFilterSelection()) {
          resultDiv.className =
            "result result-placeholder result-validation-alert";
          resultDiv.innerHTML =
            '<span class="result-placeholder-text">Please select at least one brand or purchaser from filter.</span>';
          return;
        }
        var pairs = getTenantPurchaserPairs();
        var brands = getSelectedBrands();
        var purchasers = getSelectedPurchasers();
        if (brands.length > 0 && purchasers.length > 0 && pairs.length === 0) {
          resultDiv.className =
            "result result-placeholder result-validation-alert";
          resultDiv.innerHTML =
            '<span class="result-placeholder-text">No valid brand/purchaser combination for the selected filter. Use Reset filter and try again.</span>';
          return;
        }
        clearBrandError();
        clearPurchaserError();
        var tp = getTenantPurchaser();
        if (!row) row = btn.closest("tr");
        var resetBtn = row ? row.querySelector(".reset-case") : null;
        var controller = new AbortController();
        if (row) {
          row._activeController = controller;
          row._abortedByHardReset = false;
        }
        function restoreResetBtn() {
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.classList.remove("stop-btn", "resume-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
          if (row) {
            var limitInputs = row.querySelectorAll(
              ".limit-sync, .limit-extract",
            );
            limitInputs.forEach(function (input) {
              input.disabled = false;
            });
          }
        }
        if (isResume) row._aborted = false;
        if (row && !isResume && row._activeController) {
          if (resetBtn) {
            resetBtn.textContent = "Resume";
            resetBtn.classList.remove("stop-btn");
            resetBtn.classList.add("resume-btn");
            resetBtn.onclick = function () {
              runCase(caseId, btn, resultDiv, { resume: true });
            };
            var limitInputs = row.querySelectorAll(
              ".limit-sync, .limit-extract",
            );
            if (limitInputs) {
              limitInputs.forEach(function (input) {
                input.disabled = false;
              });
            }
          }
        }

        // Save state to localStorage as backup
        try {
          localStorage.setItem(
            "intelliextract-run-state-" + caseId,
            JSON.stringify({
              startTime: new Date().toISOString(),
              params: params,
              status: "running",
            }),
          );
        } catch (_) {}

        if (resetBtn) {
          resetBtn.textContent = "Pause";
          resetBtn.classList.remove("resume-btn");
          resetBtn.classList.add("stop-btn");
          resetBtn.onclick = function () {
            controller.abort();
          };
        }
        btn.disabled = true;
        setOtherRowsInactive(row, OTHER_RUN_DISABLED_TITLE);
        showResult(
          resultDiv,
          null,
          false,
          null,
          null,
          null,
          caseId,
          null,
          null,
        );
        var params;
        if (
          isResume &&
          row &&
          (row._resumeSyncLimit != null || row._resumeExtractLimit != null)
        ) {
          params = {
            syncLimit: row._resumeSyncLimit != null ? row._resumeSyncLimit : 0,
            extractLimit:
              row._resumeExtractLimit != null ? row._resumeExtractLimit : 0,
          };
        } else {
          params = getParamsFromRow(row);
          if (row && !isResume) {
            row._resumeSyncLimit = params.syncLimit;
            row._resumeExtractLimit = params.extractLimit;
          }
        }
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncIsZero =
          syncInput && Number.parseInt(syncInput.value, 10) === 0;
        var extractIsZero =
          extractInput && Number.parseInt(extractInput.value, 10) === 0;
        if (!isResume) {
          syncIsZero = params.syncLimit === 0;
          extractIsZero = params.extractLimit === 0;
        }
        var hasSyncLimit = !!syncInput;
        var hasExtractLimit = !!extractInput;
        var isNoLimit =
          (hasSyncLimit && syncIsZero) || (hasExtractLimit && extractIsZero);
        if (isNoLimit && !isResume) {
          var proceed = window.confirm(
            "Limit is set to 0 (no limit). This will process all files and may take a long time. Continue?",
          );
          if (!proceed) {
            btn.disabled = false;
            resetCase(resultDiv, { clearLimits: false });
            restoreResetBtn();
            return;
          }
        }
        try {
          var body = {
            caseId: caseId,
            syncLimit: params.syncLimit,
            extractLimit: params.extractLimit,
          };
          if (isResume) {
            body.resume = true;
            if (
              row &&
              (row._resumeSync != null || row._resumeExtract != null)
            ) {
              if (row._resumeSync != null)
                body.lastSyncDone = row._resumeSync.done;
              if (row._resumeExtract != null)
                body.lastExtractDone = row._resumeExtract.done;
            }
          }
          if (tp.pairs && tp.pairs.length > 0) {
            body.pairs = tp.pairs;
            if (tp.pairs.length === 1) {
              body.tenant = tp.pairs[0].tenant;
              body.purchaser = tp.pairs[0].purchaser;
            }
          } else {
            body.tenant = tp.tenant;
            body.purchaser = tp.purchaser;
          }
          var r = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
            signal: controller.signal,
          });
          if (!r.ok || !r.body) {
            var errText = await r.text();
            try {
              var errJson = JSON.parse(errText);
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: errText },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
            );
            return;
          }
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buffer = "";
          var data = null;
          var lastSyncProgress = null;
          var lastExtractionProgress = null;
          var lastResumeSkipSync = null;
          var lastResumeSkipExtract = null;
          while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split("\n");
            buffer = lines.pop() || "";
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (!line) continue;
              try {
                var msg = JSON.parse(line);
                if (msg.type === "progress" && msg.percent != null) {
                  showResult(
                    resultDiv,
                    null,
                    false,
                    { percent: msg.percent, done: msg.done, total: msg.total },
                    null,
                    null,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "resume_skip_sync") {
                  lastResumeSkipSync = {
                    skipped: msg.skipped,
                    total: msg.total,
                  };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "resume_skip") {
                  lastResumeSkipExtract = {
                    skipped: msg.skipped,
                    total: msg.total,
                  };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "sync_progress") {
                  lastSyncProgress = { done: msg.done, total: msg.total };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "extraction_progress") {
                  lastExtractionProgress = { done: msg.done, total: msg.total };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "result") {
                  data = msg;
                } else if (msg.error) {
                  data = { exitCode: 1, stdout: "", stderr: msg.error };
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              var msg = JSON.parse(buffer.trim());
              if (msg.type === "result") data = msg;
              else if (msg.error)
                data = { exitCode: 1, stdout: "", stderr: msg.error };
            } catch (_) {}
          }
          if (!data) {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: "No result from server" },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
            );
            return;
          }
          var expectFail = caseId.indexOf("N") === 0;
          var pass = expectFail ? data.exitCode !== 0 : data.exitCode === 0;
          showResult(
            resultDiv,
            data,
            pass,
            null,
            null,
            null,
            caseId,
            null,
            null,
          );
        } catch (e) {
          if (e.name === "AbortError") {
            // If abort was triggered via a hard reset, fully reset UI/state and do not enter resume mode.
            if (row && row._abortedByHardReset) {
              row._abortedByHardReset = false;
              if (row._resumeSync !== undefined) delete row._resumeSync;
              if (row._resumeExtract !== undefined) delete row._resumeExtract;
              if (row._resumeSyncLimit !== undefined)
                delete row._resumeSyncLimit;
              if (row._resumeExtractLimit !== undefined)
                delete row._resumeExtractLimit;
              resetCase(resultDiv);
            } else {
              if (row) {
                row._aborted = true;
                row._resumeSync = lastSyncProgress;
                row._resumeExtract = lastExtractionProgress;
                var limitInputs = row.querySelectorAll(
                  ".limit-sync, .limit-extract",
                );
                limitInputs.forEach(function (input) {
                  input.disabled = true;
                });
              }
              if (resetBtn) {
                resetBtn.textContent = "Resume";
                resetBtn.classList.remove("stop-btn");
                resetBtn.classList.add("resume-btn");
                resetBtn.onclick = function () {
                  runCase(caseId, btn, resultDiv, { resume: true });
                };
              }
              var resetDuringResumeBtn = row
                ? row.querySelector(".reset-during-resume")
                : null;
              if (resetDuringResumeBtn)
                resetDuringResumeBtn.classList.add("show-during-resume");
              var syncDone = row && row._resumeSync ? row._resumeSync.done : 0;
              var extDone =
                row && row._resumeExtract ? row._resumeExtract.done : 0;
              var msg =
                "Stopped. Click Resume to continue from where you left off.";
              if (syncDone > 0 || extDone > 0) {
                msg =
                  "Stopped (sync: " +
                  syncDone +
                  ", extract: " +
                  extDone +
                  "). Click Resume to continue from the next file.";
              }
              resultDiv.className = "result result-placeholder";
              resultDiv.innerHTML =
                '<span class="result-placeholder-text">' +
                escapeHtml(msg) +
                "</span>";
            }
          } else {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: e.message },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
            );
            // Clear localStorage on error
            try {
              localStorage.removeItem("intelliextract-run-state-" + caseId);
            } catch (_) {}
          }
        } finally {
          if (row) row._activeController = null;
          if (row && row._aborted) {
            row._aborted = false;
            btn.disabled = false;
            setOtherRowsInactive(row, RESUME_OTHER_DISABLED_TITLE);
          } else {
            setOtherRowsActive();
            restoreResetBtn();
            var resetDuringResumeBtn = row
              ? row.querySelector(".reset-during-resume")
              : null;
            if (resetDuringResumeBtn)
              resetDuringResumeBtn.classList.remove("show-during-resume");
            // Clear localStorage on successful completion
            try {
              localStorage.removeItem("intelliextract-run-state-" + caseId);
            } catch (_) {}
          }
        }
      }

      var tbody = document.getElementById("rows");
      ROWS.forEach(function (c) {
        tbody.appendChild(renderRow(c, "rows"));
      });

      (function restoreAllCasesOnLoad() {
        // Step 1: Check for actively running processes
        fetch("/api/active-runs")
          .then(function (r) {
            return r.ok ? r.json() : null;
          })
          .then(function (data) {
            if (!data || !data.activeRuns || data.activeRuns.length === 0)
              return;

            // Restore running state for active processes
            data.activeRuns.forEach(function (run) {
              var caseRow = tbody
                ? tbody.querySelector('tr[data-case-id="' + run.caseId + '"]')
                : null;
              if (!caseRow) return;

              var runBtn = caseRow.querySelector("button.run");
              var resultDiv = document.getElementById("result-" + run.caseId);
              var resetBtn = caseRow.querySelector(
                "button.reset-case:not(.reset-during-resume)",
              );

              // Handle Scheduled Runs (Non-blocking)
              if (run.origin === "scheduled") {
                // Show just a "Running in background" chip in the output cell — no stop button here
                if (resultDiv) {
                  resultDiv.className = "result result-placeholder";
                  resultDiv.innerHTML =
                    '<span style="background:#e0f2f1;color:#00695c;padding:3px 10px;border-radius:14px;font-size:0.85em;font-weight:600;border:1px solid #b2dfdb;white-space:nowrap;">Running in background</span>';
                }
                // Move "Stop Auto Extraction" to the actions column (resetBtn)
                if (resetBtn) {
                  resetBtn.textContent = "Stop Auto Extraction";
                  resetBtn.classList.remove("resume-btn");
                  resetBtn.classList.add("stop-btn");
                  resetBtn.onclick = function () {
                    window.stopBackgroundJob(run.caseId);
                  };
                }
                if (runBtn) runBtn.disabled = true;
                setOtherRowsInactive(
                  caseRow,
                  "Background auto extraction is running. Stop it to run another case.",
                );
                return; // processing done for scheduled run
              }

              // Handle Manual Runs (Blocking - Existing Logic)
              if (runBtn) runBtn.disabled = true;
              if (resetBtn) {
                resetBtn.textContent = "Pause";
                resetBtn.classList.remove("resume-btn");
                resetBtn.classList.add("stop-btn");
                // Note: We can't set onclick to actually stop since the process is in memory
                // User will need to manually refresh or the process will complete
              }

              if (resultDiv) {
                resultDiv.className = "result running";
                var msg = "Running";
                if (run.progress) {
                  msg +=
                    "… " +
                    run.progress.percent +
                    "% (" +
                    run.progress.done +
                    " / " +
                    run.progress.total +
                    ")";
                } else if (run.syncProgress) {
                  msg +=
                    "… Syncing (" +
                    run.syncProgress.done +
                    " / " +
                    run.syncProgress.total +
                    ")";
                } else if (run.extractProgress) {
                  msg +=
                    "… Extracting (" +
                    run.extractProgress.done +
                    " / " +
                    run.extractProgress.total +
                    ")";
                } else {
                  msg += "…";
                }
                resultDiv.innerHTML =
                  '<span class="exit">' +
                  escapeHtml(msg) +
                  '<span class="loading-dots"></span></span>';
              }

              setOtherRowsInactive(caseRow, "A process is already running");
            });
          })
          .catch(function () {});

        // Step 2: Check for resumable stopped processes
        var resumableCases = ["P1", "P2", "PIPE", "P5", "P6"];

        resumableCases.forEach(function (caseId) {
          fetch("/api/run-status?caseId=" + caseId)
            .then(function (r) {
              return r.ok ? r.json() : null;
            })
            .then(function (status) {
              if (!status || !status.canResume || status.isRunning) return;

              var caseRow = tbody
                ? tbody.querySelector('tr[data-case-id="' + caseId + '"]')
                : null;
              if (!caseRow) return;

              var runBtn = caseRow.querySelector("button.run");
              var resultDiv = document.getElementById("result-" + caseId);
              var resetBtn = caseRow.querySelector(
                "button.reset-case:not(.reset-during-resume)",
              );

              // Set up resume state from saved state
              var savedState = status.state || {};

              if (savedState.params) {
                if (savedState.params.syncLimit != null) {
                  caseRow._resumeSyncLimit = savedState.params.syncLimit;
                }
                if (savedState.params.extractLimit != null) {
                  caseRow._resumeExtractLimit = savedState.params.extractLimit;
                }
              }

              if (savedState.syncProgress) {
                caseRow._resumeSync = savedState.syncProgress;
              }
              if (savedState.extractProgress) {
                caseRow._resumeExtract = savedState.extractProgress;
              }

              caseRow._aborted = true;

              // Disable limit inputs
              var limitInputs = caseRow.querySelectorAll(
                ".limit-sync, .limit-extract",
              );
              limitInputs.forEach(function (input) {
                input.disabled = true;
              });

              if (runBtn) runBtn.disabled = true;

              if (resetBtn) {
                resetBtn.textContent = "Resume";
                resetBtn.classList.remove("stop-btn");
                resetBtn.classList.add("resume-btn");
                resetBtn.onclick = function () {
                  runCase(caseId, runBtn, resultDiv, { resume: true });
                };
              }

              var resetDuringResumeBtn = caseRow.querySelector(
                ".reset-during-resume",
              );
              if (resetDuringResumeBtn) {
                resetDuringResumeBtn.classList.add("show-during-resume");
              }

              if (resultDiv) {
                resultDiv.className = "result result-placeholder";
                var msg = "Stopped";
                if (savedState.syncProgress && savedState.extractProgress) {
                  msg +=
                    " (sync: " +
                    savedState.syncProgress.done +
                    ", extract: " +
                    savedState.extractProgress.done +
                    ")";
                } else if (savedState.syncProgress) {
                  msg += " (sync: " + savedState.syncProgress.done + ")";
                } else if (savedState.extractProgress) {
                  msg += " (extract: " + savedState.extractProgress.done + ")";
                }
                msg += ". Click Resume to continue from the next file.";
                resultDiv.innerHTML =
                  '<span class="result-placeholder-text">' +
                  escapeHtml(msg) +
                  "</span>";
              }

              setOtherRowsInactive(
                caseRow,
                "Resume the stopped process or reset it to enable other runs",
              );
            })
            .catch(function () {});
        });
      })();
      (function initDownloadBar() {
        var container = document.getElementById("download-bar-btns");
        if (!container) return;
        var syncBtn = document.createElement("button");
        syncBtn.className = "download-sync-report-btn";
        syncBtn.textContent = "Staging Report";
        syncBtn.type = "button";
        syncBtn.title = "Download staging report (files in staging)";
        syncBtn.onclick = function () {
          downloadSyncReport(syncBtn);
        };
        container.appendChild(syncBtn);
        function addReportBtn(label, format) {
          var b = document.createElement("button");
          b.className =
            "download-report-btn download-report-" + format + "-btn";
          b.textContent = label;
          b.type = "button";
          b.setAttribute("data-format", format);
          b.onclick = function () {
            if (format === "json") downloadExtractionsZip(b);
            else downloadLatestReport(b, format);
          };
          container.appendChild(b);
        }
        addReportBtn("Summary Report", "html");
        addReportBtn("Extraction Results", "json");
      })();

      (function initScheduleButton() {
        var bar = document.getElementById("download-bar");
        if (!bar) return;
        var btns = document.getElementById("download-bar-btns");
        var scheduleBtn = document.createElement("button");
        scheduleBtn.type = "button";
        scheduleBtn.textContent = "Schedule Extraction";
        scheduleBtn.className =
          "download-report-btn download-report-schedule-btn";
        scheduleBtn.style.marginLeft = "auto";
        scheduleBtn.onclick = function () {
          openScheduleModal();
        };
        bar.appendChild(scheduleBtn);
        initScheduleModal();
      })();
      document
        .querySelectorAll(".limit-sync, .limit-extract")
        .forEach(function (input) {
          input.addEventListener("input", function () {
            var val = Number(this.value, 10);
            if (this.value !== "" && !Number.isNaN(val) && val < 0)
              this.value = "0";
          });
          input.addEventListener("change", function () {
            var val = Number(this.value, 10);
            if (this.value === "" || Number.isNaN(val) || val < 0)
              this.value = "0";
          });
        });

      function downloadSyncReport(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/sync-report")
          .then(function (r) {
            return r.blob();
          })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "sync-report.html";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadExtractionsZip(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/extractions-zip")
          .then(function (r) {
            if (!r.ok)
              return r.json().then(function (err) {
                throw new Error(err.error || "Download failed");
              });
            return r.blob();
          })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "extractions.zip";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function (err) {
            if (typeof err.message === "string") alert(err.message);
          })
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadLatestReport(btn, format) {
        if (btn) btn.disabled = true;
        fetch("/api/reports")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load report list");
            return r.json();
          })
          .then(function (list) {
            var reports = list[format] || [];
            if (reports.length === 0) {
              alert(
                "No " +
                  (format === "html" ? "summary" : "extraction") +
                  " report found. Run a case first to generate reports.",
              );
              if (btn) btn.disabled = false;
              return;
            }
            var latest = reports[0];
            var filename = latest.name;
            var url =
              "/api/reports/" + format + "/" + encodeURIComponent(filename);
            var a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          })
          .catch(function (err) {
            alert(
              "Download failed: " +
                (err && err.message
                  ? err.message
                  : "Could not fetch report list."),
            );
          })
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      var BRAND_PURCHASERS = {};
      var ALL_PURCHASERS = [];
      function renderBrandOptions() {
        var panel = document.getElementById("brand-dropdown-panel");
        if (!panel) return;
        var brands = Object.keys(BRAND_PURCHASERS);
        panel.innerHTML = brands
          .map(function (b) {
            return (
              '<label class="filter-dropdown-option"><input type="checkbox" value="' +
              b +
              '"> ' +
              b +
              "</label>"
            );
          })
          .join("");
        panel.querySelectorAll("input[type=checkbox]").forEach(function (cb) {
          cb.addEventListener("change", function () {
            updateFilterDropdownTrigger("brand");
            clearBrandError();
            refreshPurchaserOptions();
          });
        });
      }
      function fetchConfig() {
        return fetch("/api/config")
          .then(function (r) {
            return r.json();
          })
          .then(function (data) {
            if (data && data.brandPurchasers) {
              BRAND_PURCHASERS = data.brandPurchasers;
              var set = new Set();
              Object.values(BRAND_PURCHASERS).forEach(function (arr) {
                arr.forEach(function (p) {
                  set.add(p);
                });
              });
              ALL_PURCHASERS = Array.from(set).sort();
              renderBrandOptions();
              refreshPurchaserOptions();
            }
          })
          .catch(function (err) {
            console.error("Failed to load config:", err);
          });
      }
      function refreshPurchaserOptions() {
        var panel = document.getElementById("purchaser-dropdown-panel");
        var trigger = document.getElementById("purchaser-dropdown-trigger");
        if (!panel || !trigger) return;
        var brands = getSelectedBrands();
        var opts =
          brands.length === 0
            ? ALL_PURCHASERS
            : (function () {
                var set = new Set();
                brands.forEach(function (b) {
                  (BRAND_PURCHASERS[b] || []).forEach(function (p) {
                    set.add(p);
                  });
                });
                return Array.from(set).sort();
              })();
        var currentChecked = getSelectedPurchasers();
        panel.innerHTML = opts
          .map(function (p) {
            var checked = currentChecked.indexOf(p) !== -1 ? " checked" : "";
            return (
              '<label class="filter-dropdown-option"><input type="checkbox" value="' +
              p +
              '"' +
              checked +
              "> " +
              p +
              "</label>"
            );
          })
          .join("");
        panel.querySelectorAll("input[type=checkbox]").forEach(function (cb) {
          cb.addEventListener("change", function () {
            updateFilterDropdownTrigger("purchaser");
          });
        });
        updateFilterDropdownTrigger("purchaser");
      }

      function initScheduleModal() {
        var overlay = document.getElementById("schedule-modal-overlay");
        var body = document.getElementById("schedule-modal-body");
        var closeIcon = document.getElementById("schedule-modal-close-icon");
        if (!overlay || !body) return;
        function close() {
          overlay.classList.remove("open");
          overlay.setAttribute("aria-hidden", "true");
        }
        if (closeIcon) closeIcon.onclick = close;
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay) close();
        });
      }

      function openScheduleModal() {
        var overlay = document.getElementById("schedule-modal-overlay");
        var body = document.getElementById("schedule-modal-body");
        if (!overlay || !body) return;
        overlay.classList.add("open");
        overlay.setAttribute("aria-hidden", "false");
        loadSchedulesIntoModal();
      }

      function renderScheduleListView(state) {
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;
        var schedules =
          state && Array.isArray(state.schedules) ? state.schedules : [];
        var tz = state && Array.isArray(state.timezones) ? state.timezones : [];
        var html =
          '<div class="schedule-header-row"><div>Manage scheduled sync &amp; extraction jobs.</div><div style="display:flex;gap:0.51rem;flex-wrap:wrap;"><button type="button" id="schedule-history-btn" class="btn-secondary">History</button><button type="button" id="schedule-create-btn" class="download-report-btn download-report-schedule-btn">Create a Schedule</button></div></div><div style="flex:1;display:flex;flex-direction:column;min-height:0;">';
        if (!schedules.length) {
          html +=
            '<div class="schedule-empty">No schedules created. Please create a schedule.</div>';
        } else {
          html +=
            '<div style="flex:1;overflow-y:auto;"><table class="schedule-list"><thead><tr><th>Brand</th><th>Purchaser</th><th>Time (cron)</th><th>Timezone</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
          schedules.forEach(function (s) {
            var brands =
              s.brands && s.brands.length ? s.brands.join(", ") : "All";
            var purchasers =
              s.purchasers && s.purchasers.length
                ? s.purchasers.join(", ")
                : "All";
            html +=
              "<tr data-sched-id='" +
              escapeHtml(s.id || "") +
              "'><td>" +
              escapeHtml(brands) +
              "</td><td>" +
              escapeHtml(purchasers) +
              "</td><td>" +
              escapeHtml(s.cron) +
              "</td><td>" +
              escapeHtml(s.timezone) +
              "</td><td>" +
              escapeHtml(s.createdAt || "") +
              '</td><td><div style="display:flex;flex-wrap:wrap;gap:0.51rem;">' +
              '<button type="button" class="btn-secondary" data-sched-edit>Edit</button>' +
              '<button type="button" class="btn-secondary" data-sched-delete>Delete</button>' +
              "</div></td></tr>";
          });
          html += "</tbody></table></div>";
        }
        html += "</div>";
        body.innerHTML = html;
        var createBtn = document.getElementById("schedule-create-btn");
        if (createBtn) {
          createBtn.onclick = function () {
            renderScheduleCreateForm(tz);
          };
        }
        var historyBtn = document.getElementById("schedule-history-btn");
        if (historyBtn) {
          historyBtn.onclick = function () {
            renderReportsHistoryView();
          };
        }
        body.querySelectorAll("[data-sched-edit]").forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tr = btn.closest("tr");
            var id = tr && tr.getAttribute("data-sched-id");
            if (!id) return;
            var sched = schedules.find(function (s) {
              return s.id === id;
            });
            if (!sched) return;
            renderScheduleCreateForm(tz, sched);
          });
        });
        body.querySelectorAll("[data-sched-delete]").forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tr = btn.closest("tr");
            var id = tr && tr.getAttribute("data-sched-id");
            if (!id) return;
            if (!window.confirm("Delete this schedule? This cannot be undone."))
              return;
            deleteSchedule(id);
          });
        });
      }

      function getSelectedScheduleBrands() {
        var panel = document.getElementById("sched-brand-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll("input[type=checkbox]:checked"),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function getSelectedSchedulePurchasers() {
        var panel = document.getElementById("sched-purchaser-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll("input[type=checkbox]:checked"),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function updateScheduleDropdownTrigger(type) {
        var trigger = document.getElementById(
          type === "brand"
            ? "sched-brand-dropdown-trigger"
            : "sched-purchaser-dropdown-trigger",
        );
        if (!trigger) return;
        var selected =
          type === "brand"
            ? getSelectedScheduleBrands()
            : getSelectedSchedulePurchasers();
        if (selected.length === 0) {
          trigger.textContent =
            type === "brand" ? "Select brand" : "Select purchaser";
        } else if (selected.length === 1) {
          trigger.textContent = selected[0];
        } else {
          trigger.textContent = selected.length + " selected";
        }
      }
      function refreshSchedulePurchaserOptions() {
        var panel = document.getElementById("sched-purchaser-dropdown-panel");
        var trigger = document.getElementById(
          "sched-purchaser-dropdown-trigger",
        );
        if (!panel || !trigger) return;
        var brands = getSelectedScheduleBrands();
        var opts =
          brands.length === 0
            ? ALL_PURCHASERS
            : (function () {
                var set = new Set();
                brands.forEach(function (b) {
                  (BRAND_PURCHASERS[b] || []).forEach(function (p) {
                    set.add(p);
                  });
                });
                return Array.from(set).sort();
              })();
        var currentChecked = getSelectedSchedulePurchasers();
        panel.innerHTML = opts
          .map(function (p) {
            var checked = currentChecked.indexOf(p) !== -1 ? " checked" : "";
            return (
              '<label class="filter-dropdown-option"><input type="checkbox" value="' +
              escapeHtml(p) +
              '"' +
              checked +
              "> " +
              escapeHtml(p) +
              "</label>"
            );
          })
          .join("");
        panel.querySelectorAll("input[type=checkbox]").forEach(function (cb) {
          cb.addEventListener("change", function () {
            updateScheduleDropdownTrigger("purchaser");
          });
        });
        updateScheduleDropdownTrigger("purchaser");
      }
      function renderScheduleCreateForm(timezones, schedule) {
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;
        var brands = Object.keys(BRAND_PURCHASERS || {});
        var tz =
          Array.isArray(timezones) && timezones.length ? timezones : ["UTC"];
        var brandOptions = brands
          .map(function (b) {
            return (
              '<label class="filter-dropdown-option"><input type="checkbox" value="' +
              escapeHtml(b) +
              '"> ' +
              escapeHtml(b) +
              "</label>"
            );
          })
          .join("");
        var cronOptions = "";
        for (var h = 0; h < 24; h++) {
          for (var m = 0; m < 60; m += 5) {
            var displayHour = ((h + 11) % 12) + 1; // 0 -> 12, 13 -> 1
            var ampm = h < 12 ? "AM" : "PM";
            var minLabel = String(m).padStart(2, "0");
            var label = displayHour + ":" + minLabel + " " + ampm;
            var cronVal = String(m) + " " + String(h) + " * * *";
            cronOptions +=
              '<option value="' +
              cronVal +
              '">' +
              escapeHtml(label) +
              "</option>";
          }
        }
        var tzOptions = tz
          .map(function (z) {
            return (
              '<option value="' +
              escapeHtml(z) +
              '">' +
              escapeHtml(z) +
              "</option>"
            );
          })
          .join("");
        body.innerHTML =
          '<div class="schedule-header-row"><div>' +
          (schedule ? "Edit schedule." : "Create a new schedule.") +
          "</div></div>" +
          '<div style="flex:1;display:flex;flex-direction:column;min-height:0;overflow-y:auto;">' +
          '<div class="schedule-form-grid">' +
          '<div class="schedule-field"><label class="schedule-label" for="sched-brand-dropdown-trigger">Brand (optional)</label><div id="sched-brand-dropdown" class="filter-dropdown"><button type="button" id="sched-brand-dropdown-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false" title="Select one or more brands">Select brand</button><div id="sched-brand-dropdown-panel" class="filter-dropdown-panel" role="listbox">' +
          brandOptions +
          '</div></div><div class="schedule-hint">Leave empty to include all brands.</div></div>' +
          '<div class="schedule-field"><label class="schedule-label" for="sched-purchaser-dropdown-trigger">Purchaser (optional)</label><div id="sched-purchaser-dropdown" class="filter-dropdown"><button type="button" id="sched-purchaser-dropdown-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false" title="Select one or more purchasers">Select purchaser</button><div id="sched-purchaser-dropdown-panel" class="filter-dropdown-panel" role="listbox"></div></div><div class="schedule-hint">Leave empty to include all purchasers. Options update based on selected brands.</div></div>' +
          '<div class="schedule-field"><label class="schedule-label" for="sched-cron">Run time (daily)</label><select id="sched-cron" class="schedule-select">' +
          cronOptions +
          '</select><div class="schedule-hint">Runs once per day at the selected time (every minute interval options).</div></div>' +
          '<div class="schedule-field"><label class="schedule-label" for="sched-tz">Timezone</label><select id="sched-tz" class="schedule-select">' +
          tzOptions +
          '</select><div class="schedule-hint">All runs use this timezone for the cron schedule.</div></div>' +
          "</div>" +
          '<div id="schedule-error" class="schedule-error"></div>' +
          "</div>" +
          '<div class="modal-footer" style="margin-top:0.85rem;"><button type="button" id="schedule-cancel-btn" class="btn-secondary">Cancel</button><button type="button" id="schedule-save-btn" class="download-report-btn download-report-schedule-btn">' +
          (schedule ? "Update schedule" : "Save schedule") +
          "</button></div>";
        refreshSchedulePurchaserOptions();
        var brandTrigger = document.getElementById(
          "sched-brand-dropdown-trigger",
        );
        var brandPanel = document.getElementById("sched-brand-dropdown-panel");
        var brandDropdown = document.getElementById("sched-brand-dropdown");
        var purchaserTrigger = document.getElementById(
          "sched-purchaser-dropdown-trigger",
        );
        var purchaserPanel = document.getElementById(
          "sched-purchaser-dropdown-panel",
        );
        var purchaserDropdown = document.getElementById(
          "sched-purchaser-dropdown",
        );
        function closeScheduleDropdowns() {
          if (brandPanel) brandPanel.classList.remove("open");
          if (purchaserPanel) purchaserPanel.classList.remove("open");
          if (brandTrigger) brandTrigger.setAttribute("aria-expanded", "false");
          if (purchaserTrigger)
            purchaserTrigger.setAttribute("aria-expanded", "false");
        }
        function toggleScheduleDropdown(panel, trigger) {
          var isOpen = panel && panel.classList.contains("open");
          closeScheduleDropdowns();
          if (!isOpen && panel && trigger) {
            panel.classList.add("open");
            trigger.setAttribute("aria-expanded", "true");
          }
        }
        if (brandTrigger && brandPanel) {
          brandTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(brandPanel, brandTrigger);
          });
        }
        if (purchaserTrigger && purchaserPanel) {
          purchaserTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(purchaserPanel, purchaserTrigger);
          });
        }
        if (brandDropdown) {
          brandDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
        if (purchaserDropdown) {
          purchaserDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
        document.addEventListener("click", function () {
          closeScheduleDropdowns();
        });
        brandPanel
          .querySelectorAll("input[type=checkbox]")
          .forEach(function (cb) {
            cb.addEventListener("change", function () {
              updateScheduleDropdownTrigger("brand");
              refreshSchedulePurchaserOptions();
            });
          });
        var cancelBtn = document.getElementById("schedule-cancel-btn");
        if (cancelBtn) {
          cancelBtn.onclick = function () {
            loadSchedulesIntoModal();
          };
        }
        var saveBtn = document.getElementById("schedule-save-btn");
        if (saveBtn) {
          saveBtn.onclick = function () {
            submitScheduleForm(schedule);
          };
        }
        if (schedule) {
          var cronEl = document.getElementById("sched-cron");
          var tzEl = document.getElementById("sched-tz");
          if (schedule.brands && schedule.brands.length) {
            schedule.brands.forEach(function (b) {
              var cb = brandPanel.querySelector(
                'input[type=checkbox][value="' + escapeHtml(b) + '"]',
              );
              if (cb) cb.checked = true;
            });
            updateScheduleDropdownTrigger("brand");
            refreshSchedulePurchaserOptions();
          }
          if (schedule.purchasers && schedule.purchasers.length) {
            schedule.purchasers.forEach(function (p) {
              var cb = purchaserPanel.querySelector(
                'input[type=checkbox][value="' + escapeHtml(p) + '"]',
              );
              if (cb) cb.checked = true;
            });
            updateScheduleDropdownTrigger("purchaser");
          }
          if (cronEl && schedule.cron) {
            cronEl.value = schedule.cron;
          }
          if (tzEl && schedule.timezone) {
            tzEl.value = schedule.timezone;
          }
        }
      }

      function loadSchedulesIntoModal() {
        fetch("/api/schedules")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load schedules");
            return r.json();
          })
          .then(function (data) {
            renderScheduleListView({
              schedules: data.schedules || [],
              timezones: data.timezones || [],
            });
          })
          .catch(function () {
            renderScheduleListView({ schedules: [], timezones: ["UTC"] });
          });
      }

      function renderReportsHistoryView() {
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;
        fetch("/api/reports")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load reports");
            return r.json();
          })
          .then(function (list) {
            var html =
              '<div class="schedule-header-row">' +
              '<div style="display:flex;gap:0.51rem;flex-wrap:wrap;">' +
              '<button type="button" id="history-latest-summary" class="download-report-btn download-report-html-btn">Latest summary (HTML)</button>' +
              '<button type="button" id="history-extractions-zip" class="download-report-btn download-report-json-btn">Latest extractions ZIP</button>' +
              "</div>" +
              '<button type="button" id="history-back-btn" class="btn-secondary">Back to Schedules</button>' +
              "</div>" +
              '<div style="flex:1;display:flex;flex-direction:column;min-height:0;">';
            var runMap = {};
            function extractRunId(filename) {
              var match = filename.match(/^report_(.+?)_\d+\.(html|json)$/);
              return match ? match[1] : null;
            }
            (list.html || []).forEach(function (r) {
              var runId = extractRunId(r.name);
              if (runId) {
                if (
                  !runMap[runId] ||
                  (r.mtime || 0) < (runMap[runId].mtime || 0)
                ) {
                  runMap[runId] = {
                    runId: runId,
                    mtime: r.mtime || 0,
                    htmlName: r.name,
                    jsonName: null,
                  };
                } else if (runMap[runId]) {
                  runMap[runId].htmlName = r.name;
                  if ((r.mtime || 0) < (runMap[runId].mtime || 0)) {
                    runMap[runId].mtime = r.mtime || 0;
                  }
                }
              }
            });
            (list.json || []).forEach(function (r) {
              var runId = extractRunId(r.name);
              if (runId) {
                if (!runMap[runId]) {
                  runMap[runId] = {
                    runId: runId,
                    mtime: r.mtime || 0,
                    htmlName: null,
                    jsonName: r.name,
                  };
                } else {
                  runMap[runId].jsonName = r.name;
                  if ((r.mtime || 0) < (runMap[runId].mtime || 0)) {
                    runMap[runId].mtime = r.mtime || 0;
                  }
                }
              }
            });
            var items = Object.values(runMap);
            items.sort(function (a, b) {
              return (b.mtime || 0) - (a.mtime || 0);
            });
            if (!items.length) {
              html +=
                '<div class="schedule-empty">No reports available yet. Run or schedule an extraction to generate reports.</div>';
            } else {
              html +=
                '<div style="flex:1;overflow-y:auto;"><table class="schedule-list"><thead><tr><th>Run ID</th><th>Executed At</th></tr></thead><tbody>';
              items.forEach(function (it) {
                var dateLabel = it.mtime
                  ? new Date(it.mtime).toLocaleString()
                  : "";
                html +=
                  "<tr><td>" +
                  escapeHtml(it.runId) +
                  "</td><td>" +
                  escapeHtml(dateLabel) +
                  "</td></tr>";
              });
              html += "</tbody></table></div>";
            }
            html += "</div>";
            body.innerHTML = html;
            var backBtn = document.getElementById("history-back-btn");
            if (backBtn) {
              backBtn.onclick = function () {
                loadSchedulesIntoModal();
              };
            }
            var latestSummaryBtn = document.getElementById(
              "history-latest-summary",
            );
            if (latestSummaryBtn) {
              latestSummaryBtn.onclick = function () {
                downloadLatestReport(latestSummaryBtn, "html");
              };
            }
            var extractionsZipBtn = document.getElementById(
              "history-extractions-zip",
            );
            if (extractionsZipBtn) {
              extractionsZipBtn.onclick = function () {
                downloadExtractionsZip(extractionsZipBtn);
              };
            }
          })
          .catch(function () {
            body.innerHTML =
              '<div class="schedule-header-row"><div>Reports history</div><button type="button" id="history-back-btn" class="btn-secondary">Back to Schedules</button></div><div class="schedule-empty">Could not load reports.</div>';
            var backBtn = document.getElementById("history-back-btn");
            if (backBtn) {
              backBtn.onclick = function () {
                loadSchedulesIntoModal();
              };
            }
          });
      }

      function deleteSchedule(id) {
        fetch("/api/schedules/" + encodeURIComponent(id), {
          method: "DELETE",
        })
          .then(function (r) {
            if (!r.ok) {
              throw new Error("Failed to delete schedule");
            }
            loadSchedulesIntoModal();
          })
          .catch(function () {
            // Best effort; keep current view if delete fails.
          });
      }

      function submitScheduleForm(schedule) {
        var cronEl = document.getElementById("sched-cron");
        var tzEl = document.getElementById("sched-tz");
        var errorEl = document.getElementById("schedule-error");
        if (!cronEl || !tzEl || !errorEl) return;
        var brands = getSelectedScheduleBrands();
        var purchasers = getSelectedSchedulePurchasers();
        var cron = (cronEl.value || "").trim();
        var timezone = (tzEl.value || "").trim();
        errorEl.textContent = "";
        if (brands.length === 0 && purchasers.length === 0) {
          errorEl.textContent =
            "Please select at least one brand or purchaser.";
          return;
        }
        if (!cron) {
          errorEl.textContent = "Run time is required.";
          return;
        }
        if (!timezone) {
          errorEl.textContent = "Timezone is required.";
          return;
        }
        var url = "/api/schedules";
        var method = "POST";
        if (schedule && schedule.id) {
          url = "/api/schedules/" + encodeURIComponent(schedule.id);
          method = "PUT";
        }
        fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            brands: brands,
            purchasers: purchasers,
            cron: cron,
            timezone: timezone,
          }),
        })
          .then(function (r) {
            if (!r.ok) {
              return r.json().then(function (err) {
                throw new Error(
                  err && err.error ? err.error : "Failed to save schedule",
                );
              });
            }
            return r.json();
          })
          .then(function () {
            loadSchedulesIntoModal();
          })
          .catch(function (e) {
            errorEl.textContent =
              e && e.message ? e.message : "Failed to save schedule.";
          });
      }
      function clearResumeStateFromAllRows() {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var rows = tbody.querySelectorAll("tr[data-case-id]");
        rows.forEach(function (tr) {
          var runBtn = tr.querySelector("button.run");
          if (!runBtn || runBtn.textContent !== "Resume") return;
          var caseId = tr.getAttribute("data-case-id");
          var resultDiv = document.getElementById("result-" + caseId);
          runBtn.textContent = getRunButtonLabel(caseId);
          runBtn.title = runBtn.textContent || "";
          runBtn.classList.remove("resume-btn");
          runBtn.onclick = function () {
            runCase(caseId, runBtn, resultDiv, null);
          };
          if (tr._resumeSync !== undefined) delete tr._resumeSync;
          if (tr._resumeExtract !== undefined) delete tr._resumeExtract;
          if (tr._resumeSyncLimit !== undefined) delete tr._resumeSyncLimit;
          if (tr._resumeExtractLimit !== undefined)
            delete tr._resumeExtractLimit;
          if (resultDiv) {
            resultDiv.className = "result result-placeholder";
            resultDiv.innerHTML =
              '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
          }
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = false;
            },
          );
          var resetDuringResumeBtn = tr.querySelector(".reset-during-resume");
          if (resetDuringResumeBtn)
            resetDuringResumeBtn.classList.remove("show-during-resume");
          var resetBtn = tr.querySelector(
            "button.reset-case:not(.reset-during-resume)",
          );
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
        });
      }
      function updateFilterDropdownTrigger(which) {
        var trigger = document.getElementById(
          which === "brand"
            ? "brand-dropdown-trigger"
            : "purchaser-dropdown-trigger",
        );
        var selected =
          which === "brand" ? getSelectedBrands() : getSelectedPurchasers();
        if (!trigger) return;
        var defaultTitle =
          which === "brand"
            ? "Select one or more brands"
            : "Select one or more purchasers";
        if (selected.length === 0) {
          trigger.textContent =
            which === "brand" ? "Select brand" : "Select purchaser";
          trigger.title = defaultTitle;
        } else if (selected.length === 1) {
          trigger.textContent = selected[0];
          trigger.title = selected[0];
        } else {
          trigger.textContent = selected.length + " selected";
          trigger.title = selected.join(", ");
        }
        clearValidationAlertWhenFilterSelected();
        clearResumeStateFromAllRows();
      }
      function resetFilter() {
        var brandPanel = document.getElementById("brand-dropdown-panel");
        var purchaserPanel = document.getElementById(
          "purchaser-dropdown-panel",
        );
        if (brandPanel)
          brandPanel
            .querySelectorAll("input[type=checkbox]")
            .forEach(function (cb) {
              cb.checked = false;
            });
        if (purchaserPanel)
          purchaserPanel
            .querySelectorAll("input[type=checkbox]")
            .forEach(function (cb) {
              cb.checked = false;
            });
        updateFilterDropdownTrigger("brand");
        clearBrandError();
        clearPurchaserError();
        refreshPurchaserOptions();
      }
      function showBrandError(msg) {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = msg || "Please select a brand.";
      }
      function clearBrandError() {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = "";
      }
      function showPurchaserError(msg) {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = msg || "Please select a brand first.";
      }
      function clearPurchaserError() {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = "";
      }
      (function () {
        var brandTrigger = document.getElementById("brand-dropdown-trigger");
        var brandPanel = document.getElementById("brand-dropdown-panel");
        var brandDropdown = document.getElementById("brand-dropdown");
        var purchaserTrigger = document.getElementById(
          "purchaser-dropdown-trigger",
        );
        var purchaserPanel = document.getElementById(
          "purchaser-dropdown-panel",
        );
        var purchaserDropdown = document.getElementById("purchaser-dropdown");
        var resetBtn = document.getElementById("filter-reset-btn");

        function closeAllDropdowns() {
          if (brandPanel) brandPanel.classList.remove("open");
          if (purchaserPanel) purchaserPanel.classList.remove("open");
          if (brandTrigger) brandTrigger.setAttribute("aria-expanded", "false");
          if (purchaserTrigger)
            purchaserTrigger.setAttribute("aria-expanded", "false");
        }
        function toggleDropdown(panel, trigger) {
          var isOpen = panel && panel.classList.contains("open");
          closeAllDropdowns();
          if (!isOpen && panel && trigger) {
            panel.classList.add("open");
            trigger.setAttribute("aria-expanded", "true");
          }
        }
        if (brandTrigger && brandPanel) {
          brandTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleDropdown(brandPanel, brandTrigger);
          });
        }
        if (purchaserTrigger && purchaserPanel) {
          purchaserTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleDropdown(purchaserPanel, purchaserTrigger);
          });
        }
        document.addEventListener("click", function () {
          closeAllDropdowns();
        });
        if (brandDropdown)
          brandDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        if (purchaserDropdown)
          purchaserDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });

        if (resetBtn)
          resetBtn.addEventListener("click", function () {
            resetFilter();
          });
        fetchConfig();
      })();
      window.stopBackgroundJob = function (caseId) {
        if (confirm("Are you sure you want to stop auto extraction?")) {
          var resultDiv = document.getElementById("result-" + caseId);
          var tbody = document.getElementById("rows");
          var caseRow = tbody
            ? tbody.querySelector('tr[data-case-id="' + caseId + '"]')
            : null;
          var resetBtn = caseRow
            ? caseRow.querySelector(
                "button.reset-case:not(.reset-during-resume)",
              )
            : null;

          if (resetBtn) {
            resetBtn.disabled = true;
            resetBtn.textContent = "Stopping...";
          }

          fetch("/api/stop-run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ caseId: caseId, origin: "scheduled" }),
          })
            .then(function (r) {
              return r.json();
            })
            .then(function (data) {
              if (data.error) {
                alert("Error stopping auto extraction: " + data.error);
                if (resetBtn) {
                  resetBtn.disabled = false;
                  resetBtn.textContent = "Stop Auto Extraction";
                }
              } else {
                // Success — reset UI back to default state
                if (resultDiv) {
                  resultDiv.className = "result result-placeholder";
                  resultDiv.innerHTML =
                    '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
                }
                if (resetBtn) {
                  resetBtn.disabled = false;
                  resetBtn.textContent = "Reset";
                  resetBtn.classList.remove("stop-btn");
                  resetBtn.onclick = function () {
                    resetCase(resultDiv);
                  };
                }
                var runBtn = caseRow
                  ? caseRow.querySelector("button.run")
                  : null;
                if (runBtn) runBtn.disabled = false;
                setOtherRowsActive();
              }
            })
            .catch(function (e) {
              alert("Network error: " + e.message);
              if (resetBtn) {
                resetBtn.disabled = false;
                resetBtn.textContent = "Stop Auto Extraction";
              }
            });
        }
      };
    </script>
  </body>
</html>
