<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelliExtract Runner â€” intellirevenue</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f5f7f9;
        --surface: #ffffff;
        --text: #2c2c2c;
        --text-secondary: #5a5a5a;
        --border: #b0bfc9;
        --border-light: #cbd5e1;
        --header-bg: #216c6d;
        --header-text: #ffffff;
        --header-border: #1a5758;
        --accent: #2d9d5f;
        --accent-light: #e8f5ee;
        --primary: #2d9d5f;
        --primary-hover: #248f54;
        --pass: #248f54;
        --pass-bg: #e8f5ee;
        --fail: #c62828;
        --fail-bg: #ffebee;
        --muted: #6b7c85;
        --row-alt: #fafbfc;
        --cell-pad: 0.722rem 0.85rem;
        --radius: 6.8px;
        --radius-sm: 5.1px;
        --radius-xs: 3.4px;
        --shadow-sm: 0 0.85px 2.55px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 1.7px 6.8px rgba(0, 0, 0, 0.1);
        --shadow-lg:
          0 12px 30px -10px rgba(0, 0, 0, 0.15),
          0 4px 15px -5px rgba(0, 0, 0, 0.1);
        --shadow-inset: inset 0 0.85px 1.7px rgba(0, 0, 0, 0.06);
        --shadow-btn: 0 0.85px 2.55px rgba(0, 0, 0, 0.12);
        --warning: #f59e0b;
        --warning-hover: #d97706;
      }
      * {
        box-sizing: border-box;
      }
      button,
      input,
      select,
      textarea {
        font-family: inherit;
      }
      /* Universal Button Sliding & Hover Effects */
      button:not(:disabled):not(.modal-close-icon):not(
          .filter-dropdown-trigger
        ) {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      button:not(:disabled):not(.modal-close-icon):not(
          .filter-dropdown-trigger
        )::after {
        content: "";
        position: absolute;
        top: 0;
        left: -150%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          rgba(45, 157, 95, 0.15),
          rgba(255, 255, 255, 0.4),
          transparent
        );
        transform: skewX(-20deg);
        z-index: 10;
        pointer-events: none;
      }
      button:not(:disabled):not(.modal-close-icon):not(
          .filter-dropdown-trigger
        ):hover::after {
        left: 150%;
        transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      button:active:not(:disabled) {
        transform: scale(0.97);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "JetBrains Mono", "Consolas", "Courier New", monospace;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
        /* Slightly smaller base font size for better fit on lower resolutions */
        font-size: 12px;
        display: flex;
        flex-direction: column;
      }
      .header {
        flex-shrink: 0;
        background: var(--surface);
        border: 1px solid rgba(176, 191, 201, 0.55);
        border-radius: var(--radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin: 0.75rem 1.25rem 0.5rem 1.25rem;
        box-sizing: border-box;
      }
      .header-inner {
        max-width: 100%;
        margin: 0;
        padding: 0.6rem 1.25rem;
        box-sizing: border-box;
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
      }
      .header-status-panel {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f1f5f9;
        padding: 0.4rem 0.85rem;
        border-radius: 100px;
        border: 1px solid rgba(203, 213, 225, 0.5);
        margin-left: 1rem;
        margin-top: 17px;
        flex: 0 1 auto;
        min-width: 0;
      }
      .header-status-label {
        font-size: 0.65rem;
        font-weight: 800;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
      }
      .header-status-value {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        justify-content: flex-end;
      }
      .header-filter-row {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
        width: 100%;
        margin-top: 14px;
      }
      .header-field-wrap {
        display: flex;
        flex-direction: column;
        gap: 0.17rem;
        align-items: center;
        margin-right: 0.5rem;
      }
      .filter-chip .header-label {
        font-size: 0.725rem;
        color: var(--primary);
        white-space: nowrap;
        font-weight: 800;
        background: var(--pass-bg);
        padding: 0 0.85rem;
        height: 100%;
        display: flex;
        align-items: center;
        border-right: 1.2px solid rgba(45, 157, 95, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .header-field-wrap > .header-label {
        grid-column: 1;
        grid-row: 1;
      }
      .header-field-wrap > .header-select {
        grid-column: 2;
        grid-row: 1;
      }
      .header-field-wrap > .header-field-error {
        grid-column: 2;
        grid-row: 2;
      }
      .header-field-error {
        color: var(--fail);
        font-size: 0.75rem;
        min-height: 1.062em;
        line-height: 1.2;
      }
      .logo-link {
        text-decoration: none;
        display: block;
        transition: opacity 0.2s ease;
      }
      .logo-link:hover {
        opacity: 0.85;
      }
      .header .logo {
        height: 32px;
        width: auto;
        display: block;
        object-fit: contain;
        margin-top: 14px;
        cursor: pointer;
      }
      .header .logo-placeholder {
        height: 32px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1rem;
        margin-top: 14px;
      }
      .header-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        white-space: nowrap;
        font-weight: 600;
      }
      .filter-chip {
        display: flex;
        align-items: center;
        height: 34px;
        background: var(--surface);
        border: 0.85px solid rgba(176, 191, 201, 0.6);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        box-shadow: 0 0.85px 1.7px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }
      .filter-chip:hover {
        border-color: rgba(176, 191, 201, 0.7);
      }
      .filter-chip:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 1.7px rgba(45, 157, 95, 0.2);
      }
      .header-select {
        width: 180px;
        min-width: 180px;
        max-width: 180px;
        height: 34px;
        padding: 0.297rem 1.7rem 0.297rem 0.51rem;
        border: 0.85px solid rgba(176, 191, 201, 0.6);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.425rem center;
        box-sizing: border-box;
      }
      .filter-chip .header-select {
        width: 140px;
        height: 100%;
        border: none;
        background-color: transparent;
        box-shadow: none;
      }
      .header-select:focus {
        outline: none;
      }
      .header-select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .filter-dropdown {
        position: relative;
        width: 180px;
        min-width: 180px;
      }
      .header-filter-row .filter-dropdown {
        width: 180px;
        min-width: 180px;
      }
      .filter-dropdown-trigger {
        width: 100%;
        height: 34px;
        padding: 0.297rem 1.7rem 0.297rem 0.51rem;
        border: 1px solid rgba(45, 157, 95, 0.2);
        border-radius: var(--radius-sm);
        background: var(--accent-light);
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-family: inherit;
        text-align: center;
        cursor: pointer;
        box-sizing: border-box;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232d9d5f' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.425rem center;
      }
      .filter-chip .filter-dropdown-trigger {
        width: 180px;
        height: 100%;
        border: none;
        background-color: transparent;
        box-shadow: none;
        padding: 0 1.5rem;
        justify-content: center;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
      }
      .filter-dropdown-trigger:hover {
        border-color: rgba(176, 191, 201, 0.7);
        box-shadow:
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .filter-dropdown-trigger:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .filter-dropdown-panel {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 1.7px;
        min-width: 100%;
        max-height: 300px;
        overflow-y: auto;
        border: 0.85px solid rgba(176, 191, 201, 0.35);
        border-radius: var(--radius-sm);
        background: var(--surface);
        box-shadow: var(--shadow-md);
        z-index: 100;
        padding: 0.297rem 0;
      }
      .filter-dropdown-panel.open {
        display: block;
        animation: dropdownSlideDown 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: top;
      }
      @keyframes dropdownSlideDown {
        from {
          opacity: 0;
          transform: translateY(-8px) scaleY(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scaleY(1);
        }
      }
      .filter-dropdown-option {
        display: flex;
        align-items: center;
        gap: 0.425rem;
        padding: 0.34rem 0.51rem;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
      }
      .filter-dropdown-option:hover {
        background: var(--row-alt);
      }
      .filter-dropdown-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--row-alt);
      }
      .filter-dropdown-option input {
        margin: 0;
        cursor: pointer;
      }
      /* Brand & Purchaser Dropdown Width Customization */
      .brand-field-wrap {
        flex: 0 0 auto;
      }
      .purchaser-field-wrap {
        flex: 0 0 auto;
      }
      #brand-dropdown,
      #purchaser-dropdown {
        width: auto;
        max-width: none;
      }
      #brand-dropdown .filter-chip,
      #purchaser-dropdown .filter-chip {
        width: auto !important;
      }
      #brand-dropdown .filter-dropdown-trigger {
        width: 162px !important;
      }
      #purchaser-dropdown .filter-dropdown-trigger {
        width: 187px !important;
      }
      .header-filter-reset-wrap {
        margin-right: 0 !important;
      }
      .header-filter-reset-wrap .header-btn-reset {
        margin-top: 0;
      }
      .header-btn-reset {
        height: 34px;
        padding: 0 0.5rem;
        width: 180px;
        border: 0.85px solid var(--header-border);
        border-radius: var(--radius-sm);
        background: var(--header-bg);
        color: var(--header-text);
        font-size: 0.875rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        box-shadow: var(--shadow-btn);
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .header-btn-reset:focus {
        outline: none;
        border-color: var(--header-text);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      .header-btn-reset:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 0 1.275rem 1.062rem 1.275rem;
        max-width: 100%;
      }
      .table-section {
        flex: 1 1 0%;
        min-height: 0;
        overflow: auto;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border: 1px solid rgba(176, 191, 201, 0.65);
        border-radius: var(--radius);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08);
      }
      .table-section table {
        height: 100%;
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: var(--surface);
        border-radius: var(--radius);
      }
      th,
      td {
        padding: var(--cell-pad);
        text-align: center;
        border: 1px solid rgba(176, 191, 201, 0.55);
        vertical-align: middle;
      }
      .op-name {
        text-align: center;
      }
      thead th:first-child {
        border-top-left-radius: 0;
      }
      thead th:last-child {
        border-top-right-radius: 0;
      }
      thead tr {
        height: 40.8px;
      }
      thead th {
        height: 40.8px;
        box-sizing: border-box;
      }
      tbody {
        height: 100%;
      }
      tbody tr {
        height: 33.333%;
      }
      tbody td {
        height: 33.333%;
        box-sizing: border-box;
      }
      thead th {
        background: var(--header-bg);
        color: var(--header-text);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: none;
        letter-spacing: 0.02em;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
        text-align: center;
      }
      tbody tr {
        background: #f0f9f4;
      }
      tbody tr.row-inactive {
        opacity: 0.85;
      }
      tbody tr.row-inactive td {
        border-color: rgba(33, 108, 109, 0.45);
      }
      tbody tr.row-inactive td:not(.op-name) {
        background: var(--row-alt);
      }
      tbody tr.row-inactive button:disabled,
      tbody tr.row-inactive input:disabled {
        cursor: not-allowed;
      }
      .op-name {
        width: 181.9px;
        min-width: 181.9px;
        max-width: 181.9px;
        font-weight: 600;
      }
      .op-content-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.425rem;
        line-height: 1.25;
        text-align: center;
        width: 100%;
        margin: 0 auto;
      }
      .op-icon-wrap {
        width: 1.8rem;
        height: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        color: var(--primary);
      }
      .op-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 0.2rem;
        display: block;
      }
      .op-description {
        font-size: 0.85rem;
        font-weight: 400;
        opacity: 0.9;
        display: block;
      }
      .op-icon-wrap svg {
        width: 100%;
        height: 100%;
        fill: none;
      }
      thead th.op-name {
        color: var(--header-text);
      }
      tbody td.op-name {
        background: var(--header-bg);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      tbody td.op-name .op-icon-wrap {
        color: #ffffff;
      }
      .limits-col {
        width: 143px;
        min-width: 143px;
        max-width: 143px;
      }
      .limits-cell {
        font-size: 0.85rem;
        color: var(--text-secondary);
        overflow: hidden;
        vertical-align: top;
      }
      .limits-cell .limit-row {
        display: flex;
        flex-direction: column;
        gap: 0.425rem;
        min-height: 1.87rem;
      }
      .limit-chip {
        display: flex;
        align-items: center;
        height: 38px;
        background: var(--surface);
        border: 1px solid rgba(176, 191, 201, 0.6);
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
      }
      .limit-chip:hover:not(:has(input:disabled)) {
        border-color: rgba(176, 191, 201, 0.7);
      }
      .limit-chip:has(input:focus) {
        border-color: var(--primary);
        box-shadow: 0 0 0 1.7px rgba(45, 157, 95, 0.2);
      }
      .limits-cell .limit-label {
        background: var(--bg);
        padding: 0 0.637rem;
        height: 100%;
        display: flex;
        align-items: center;
        border-right: 1px solid rgba(176, 191, 201, 0.55);
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        min-width: 60px;
        white-space: nowrap;
      }
      .limits-cell input[type="number"] {
        flex: 1;
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        padding: 0 0.51rem;
        font-size: 0.9rem;
        font-weight: 600;
        font-family: inherit;
        color: var(--text);
        box-shadow: none;
        text-align: center;
        transition: all 0.2s ease;
      }
      .limits-cell input[type="number"]::-webkit-inner-spin-button,
      .limits-cell input[type="number"]::-webkit-outer-spin-button {
        opacity: 0.5;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      .limits-cell input:hover::-webkit-inner-spin-button {
        opacity: 1;
      }
      .limits-cell input[type="number"]:focus {
        outline: none;
      }
      .limits-cell input[type="number"]:disabled {
        opacity: 0.6;
      }
      .limit-chip:has(input:disabled) {
        background: var(--row-alt);
        box-shadow: none;
      }
      .limits-cell .limit-hint {
        margin-top: 0.425rem;
        padding: 0.552rem 1.062rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--primary);
        background: var(--accent-light);
        border-radius: var(--radius-sm);
        border: 0.85px solid rgba(45, 157, 95, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        height: 38px;
        box-sizing: border-box;
        width: 100%;
        text-align: center;
      }
      .limits-cell .n/a {
        color: var(--muted);
        font-style: italic;
      }
      .run-cell {
        width: 143px;
        min-width: 143px;
        max-width: 143px;
        text-align: center;
        vertical-align: top;
      }
      .run-cell .btn-group {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.425rem;
        width: 100%;
        margin: 0 auto;
        min-width: 0;
        box-sizing: border-box;
      }
      .run-cell .btn-row {
        display: contents;
      }
      .run-cell .btn-group > .btn-row > button {
        min-width: 0;
      }
      button.run {
        background: var(--primary);
        color: #fff;
        border: 1px solid rgba(45, 157, 95, 0.25);
        border-radius: var(--radius-sm);
        height: 38px;
        padding: 0 1.062rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-btn);
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button.run:hover:not(:disabled) {
        background: var(--primary-hover);
        box-shadow: 0 1.7px 5.1px rgba(0, 0, 0, 0.18);
      }
      button.run:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      button.reset-case {
        background: var(--surface);
        color: var(--text-secondary);
        border: 0.85px solid rgba(176, 191, 201, 0.45);
        border-radius: var(--radius-sm);
        height: 38px;
        padding: 0 0.85rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button.reset-case:hover {
        background: var(--row-alt);
        color: var(--text);
        box-shadow: 0 1.7px 3.4px rgba(0, 0, 0, 0.1);
      }
      button.reset-case.stop-btn {
        background: var(--fail);
        color: #fff;
        border-color: var(--fail);
        box-shadow: var(--shadow-btn);
      }
      button.reset-case.stop-btn:hover {
        background: #a00;
        border-color: #a00;
        color: #fff;
      }
      button.reset-case.pause-btn {
        background: #379c9d;
        color: #fff;
        border: 0.85px solid #2a7a7b;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      button.reset-case.pause-btn:hover {
        background: #2a7a7b;
        border-color: #1e5859;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        color: #fff;
      }
      button.reset-case.resume-btn {
        background: var(--accent-light);
        border-color: var(--accent);
        color: var(--accent);
      }
      button.reset-case.resume-btn:hover {
        background: var(--accent);
        color: #fff;
      }
      button.reset-during-resume {
        display: none !important;
      }
      button.reset-during-resume.show-during-resume {
        display: block !important;
        width: 100%;
        min-height: 2.337rem;
        box-sizing: border-box;
        padding: 0.552rem 1.062rem;
        font-size: 0.9rem;
      }
      button.download-sync-report-btn,
      button.download-report-btn {
        height: 34px;
        border: none;
        border-radius: var(--radius-sm);
        padding: 0 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-sizing: border-box;
        box-shadow: var(--shadow-btn);
        color: #fff;
        width: 180px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .download-bar-btns button.download-sync-report-btn,
      .download-bar-btns button.download-report-btn {
        background: transparent;
        color: var(--text-secondary);
        box-shadow: none;
      }
      /* Specifically restore 'Add a Schedule' button colors */
      button.download-report-schedule-btn {
        background: var(--primary) !important;
        color: #fff !important;
        box-shadow: var(--shadow-btn) !important;
      }
      button.download-report-schedule-btn:hover:not(:disabled) {
        background: var(--primary-hover) !important;
      }
      button.download-sync-report-btn:disabled,
      button.download-report-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .download-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.75rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid rgba(176, 191, 201, 0.55);
        border-radius: 0;
        margin-bottom: 0;
        flex-wrap: wrap;
      }
      .download-chip {
        display: flex;
        align-items: center;
        height: 36px;
        background: white;
        border: 1px solid rgba(176, 191, 201, 0.6);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }
      .download-bar-label {
        font-size: 0.65rem;
        font-weight: 800;
        color: var(--primary);
        background: #f0fdf4;
        padding: 0 1rem;
        height: 100%;
        display: flex;
        align-items: center;
        border-right: 1.2px solid rgba(45, 157, 95, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        white-space: nowrap;
        margin: 0;
      }
      .download-bar-btns {
        display: flex;
        align-items: center;
        height: 100%;
        gap: 0;
      }
      .download-bar-btns .download-sync-report-btn,
      .download-bar-btns .download-report-btn {
        height: 100%;
        width: auto;
        min-width: 150px;
        border: none;
        border-radius: 0;
        background: transparent !important;
        color: var(--text-secondary) !important;
        padding: 0 1.25rem;
        font-size: 0.8rem;
        font-weight: 700;
        box-shadow: none;
        border-right: 1px solid rgba(203, 213, 225, 0.5);
        margin: 0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .download-bar-btns .download-sync-report-btn:hover,
      .download-bar-btns .download-report-btn:hover:not(:disabled) {
        background: #f1f5f9 !important;
        color: var(--primary) !important;
      }
      .download-bar-btns .download-sync-report-btn:hover svg,
      .download-bar-btns .download-report-btn:hover:not(:disabled) svg {
        transform: translateY(-1px);
        color: var(--primary);
      }
      .download-bar-btns button:last-child {
        border-right: none;
      }
      .system-status-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        padding: 0.4rem 0.85rem;
        border-radius: 100px;
        border: 1px solid rgba(203, 213, 225, 0.5);
        margin-left: auto;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-secondary);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
      }
      .system-status-pill.busy {
        background: #fffbeb;
        border-color: #fcd34d;
        color: #92400e;
      }
      .pulse-dot {
        width: 8px;
        height: 8px;
        background: var(--primary);
        border-radius: 50%;
        box-shadow: 0 0 0 0 rgba(45, 157, 95, 0.4);
        animation: pulse 2s infinite;
      }
      .busy .pulse-dot {
        background: #f59e0b;
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        animation: pulse-busy 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(45, 157, 95, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 6px rgba(45, 157, 95, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(45, 157, 95, 0);
        }
      }
      @keyframes pulse-busy {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 6px rgba(245, 158, 11, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
        }
      }
      .sync-progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 0.5rem;
        position: relative;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .sync-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), #4ade80);
        border-radius: 10px;
        transition: width 0.3s ease;
        position: relative;
      }
      .sync-progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
      }
      .sync-progress-indeterminate {
        width: 40%;
        animation: flow 1.5s infinite ease-in-out;
      }
      @keyframes flow {
        0% {
          left: -40%;
        }
        100% {
          left: 100%;
        }
      }
      .btn-icon-inline {
        width: 14px;
        height: 14px;
        margin-right: 6px;
        vertical-align: text-bottom;
      }
      .result.result-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        border: 1px dashed rgba(176, 191, 201, 0.5);
        color: var(--muted);
        text-align: center;
        padding: 1rem;
        padding-bottom: calc(1rem + 5%);
        height: calc(100% - 1.444rem);
        box-sizing: border-box;
      }
      .result.result-validation-alert {
        background: #fffbeb !important;
        border-color: #fcd34d !important;
        color: #92400e !important;
        border-style: solid;
      }
      .result-placeholder-text {
        font-size: 0.825rem;
        font-weight: 500;
        line-height: 1.4;
        opacity: 0.9;
        display: block;
        width: 100%;
      }
      .result-placeholder::before {
        content: "ðŸ“¡";
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        filter: grayscale(1);
        opacity: 0.3;
      }
      .result-header {
        width: 402.9px;
        min-width: 402.9px;
        max-width: 402.9px;
      }
      .result-cell {
        width: 402.9px;
        min-width: 402.9px;
        max-width: 402.9px;
        vertical-align: top;
        overflow: hidden;
        position: relative;
      }
      .result {
        position: absolute;
        top: 0.722rem;
        left: 0.85rem;
        right: 0.85rem;
        bottom: 0.722rem;
        font-family: "JetBrains Mono", "Consolas", "Courier New", monospace;
        font-size: 0.8rem;
        padding: 0.51rem 0.637rem;
        white-space: pre-wrap;
        word-break: break-word;
        border: 1px solid rgba(203, 213, 225, 0.25);
        border-radius: var(--radius);
        background: #fafafa;
        overflow: auto;
        box-sizing: border-box;
        box-shadow: var(--shadow-sm);
        text-align: center;
      }
      .result.pass {
        background: var(--pass-bg);
        border-color: #b8e0c8;
      }
      .result.fail {
        background: var(--fail-bg);
        border-color: #f8d4d4;
      }
      .result.running {
        background: var(--accent-light);
        border-color: #b8e0c8;
      }
      .result.running .loading-dots::after {
        content: "";
        animation: loading-dots 1.2s steps(4, end) infinite;
      }
      @keyframes loading-dots {
        0%,
        20% {
          content: "";
        }
        40% {
          content: ".";
        }
        60% {
          content: "..";
        }
        80%,
        100% {
          content: "...";
        }
      }
      .result .sync-progress-wrap {
        margin-top: 0.51rem;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text);
      }
      .result .sync-progress-wrap:first-of-type {
        margin-top: 0.425rem;
      }
      .result .extraction-progress-wrap {
        margin-top: 0.637rem;
      }
      .result .skip-progress-wrap {
        margin-top: 0.425rem;
        color: var(--muted);
      }
      .result .sync-progress-fill.skip-fill {
        background: linear-gradient(180deg, #8b9da8 0%, #6b7c85 100%);
      }
      .result .sync-progress-bar {
        width: 100%;
        height: 18.7px;
        background: rgba(203, 213, 225, 0.3);
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-top: 0.425rem;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 1.7px rgba(0, 0, 0, 0.06);
        border: 0.85px solid rgba(176, 191, 201, 0.3);
      }
      .result .sync-progress-fill {
        height: 100%;
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--primary-hover) 100%
        );
        border-radius: calc(var(--radius-sm) - 0.85px);
        transition: width 0.2s ease-out;
        box-shadow: inset 0 0.85px 0 rgba(255, 255, 255, 0.25);
      }
      .result .sync-progress-fill.sync-progress-indeterminate {
        animation: sync-indeterminate 1.2s ease-in-out infinite;
      }
      @keyframes sync-indeterminate {
        0%,
        100% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(150%);
        }
      }
      .result.result-placeholder .result-placeholder-text {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: normal;
      }
      .result.result-validation-alert .result-placeholder-text {
        color: var(--fail);
        font-style: normal;
        padding: 0.425rem 0.637rem;
        background: var(--fail-bg);
        border: 0.85px solid rgba(198, 40, 40, 0.25);
        border-radius: var(--radius-sm);
        display: inline-block;
      }
      .result .exit {
        font-weight: 600;
        margin-bottom: 0.17rem;
        color: var(--text);
      }
      .result .out {
        color: var(--text-secondary);
      }
      .result-table-wrap {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8rem;
        table-layout: fixed;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: var(--shadow-inset);
      }
      .result-table-wrap th,
      .result-table-wrap td {
        padding: 0.34rem 0.51rem;
        text-align: left;
        vertical-align: top;
        border: 1px solid rgba(203, 213, 225, 0.2);
      }
      .result-table-wrap th {
        background: var(--header-bg) !important;
        color: #ffffff !important;
        font-weight: 600;
        width: 195.5px;
        min-width: 195.5px;
        border-bottom: none;
      }
      .result-table-wrap td {
        background: var(--surface);
        color: var(--text-secondary);
        word-break: break-word;
        white-space: pre-wrap;
      }
      .result-table-wrap tr:nth-child(even) td {
        background: var(--row-alt);
      }
      .result-table-wrap tr:first-child th:first-child,
      .result-table-wrap tr:first-child td:first-child {
        border-top-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:first-child th:last-child,
      .result-table-wrap tr:first-child td:last-child {
        border-top-right-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:first-child,
      .result-table-wrap tr:last-child td:first-child {
        border-bottom-left-radius: var(--radius-sm);
      }
      .result-table-wrap tr:last-child th:last-child,
      .result-table-wrap tr:last-child td:last-child {
        border-bottom-right-radius: var(--radius-sm);
      }
      .info-icon {
        display: inline-block;
        margin-left: 0.15rem;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid var(--primary);
        color: var(--primary);
        font-size: 0.8rem;
        font-weight: 700;
        line-height: 14px;
        text-align: center;
        cursor: default;
        background: var(--accent-light);
        vertical-align: middle;
      }
      .info-icon:hover {
        border-color: var(--primary-hover);
        color: var(--primary-hover);
      }
      .result-table-wrap tr.status-row th {
        border-top: none;
      }
      .result-table-wrap tr.status-row td {
        font-weight: 600;
      }
      .result.pass .result-table-wrap tr.status-row td {
        color: var(--pass);
      }
      .result.fail .result-table-wrap tr.status-row td {
        color: var(--fail);
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-overlay.open {
        display: flex;
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      .modal {
        background: var(--surface);
        border-radius: calc(var(--radius) * 1.5);
        box-shadow:
          var(--shadow-2xl),
          0 0 0 1px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 1152px;
        max-width: 90vw;
        height: 786px;
        max-height: 85vh;
        padding: 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        animation: modalScaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
      }
      @keyframes modalScaleUp {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      @keyframes modalScaleDown {
        from {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
        to {
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
      }
      .modal-overlay.closing {
        animation: fadeOut 0.25s ease-in forwards;
      }
      .modal-overlay.closing .modal {
        animation: modalScaleDown 0.25s cubic-bezier(0.34, 1.56, 0.64, 1)
          forwards;
      }
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .modal-screen-animate {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: visible;
      }
      .modal-screen-animate.slide-right {
        animation: slideInRight 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      }
      .modal-screen-animate.slide-left {
        animation: slideInLeft 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.75rem;
        background: white;
        border-bottom: 1px solid rgba(203, 213, 225, 0.4);
      }
      .modal-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--header-bg);
      }
      .title-badge {
        background: var(--primary);
        color: white;
        font-size: 0.625rem;
        font-weight: 800;
        padding: 0.35rem 1.25rem 0.35rem 0.75rem;
        clip-path: polygon(
          0% 0%,
          calc(100% - 12px) 0%,
          100% 50%,
          calc(100% - 12px) 100%,
          0% 100%
        );
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }
      .modal-body {
        padding: 1.75rem;
        flex: 1;
        overflow-y: visible;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
        display: flex;
        flex-direction: column;
      }
      .modal-body::-webkit-scrollbar {
        width: 6px;
      }
      .modal-body::-webkit-scrollbar-track {
        background: transparent;
      }
      .modal-body::-webkit-scrollbar-thumb {
        background-color: rgba(176, 191, 201, 0.6);
        border-radius: 20px;
      }
      .modal-footer {
        padding: 1.25rem 1.8rem;
        background: #f8fafc;
        border-top: 1px solid rgba(203, 213, 225, 0.45);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      }
      .schedule-list {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid rgba(203, 213, 225, 0.4);
        border-radius: var(--radius);
        overflow: hidden;
      }
      .schedule-list th {
        background: #f1f5f9;
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 0.85px solid rgba(203, 213, 225, 0.3);
      }
      .schedule-list td {
        padding: 1rem;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(203, 213, 225, 0.4);

        transition: background 0.2s;
      }
      .schedule-list tr:hover td {
        background: #f8fafc;
      }
      .schedule-list tr:last-child td {
        border-bottom: none;
      }
      .schedule-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        color: var(--muted);
        text-align: center;
        background: #f8fafc;
        border: 2px dashed rgba(203, 213, 225, 0.4);
        border-radius: var(--radius);
      }
      .schedule-empty::before {
        content: "";
        display: block;
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        opacity: 0.45;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23216c6d' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
      }
      .modal-close-icon {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1rem;
        color: var(--muted);
        padding: 0.17rem;
      }
      .modal-close-icon:hover {
        color: var(--fail);
      }
      .schedule-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.1rem;
        gap: 0.85rem;
        padding: 0.6rem 0.34rem 0.6rem 0.68rem;
        background: linear-gradient(
          90deg,
          rgba(33, 108, 109, 0.07) 0%,
          rgba(33, 108, 109, 0.02) 100%
        );
        border-left: 3.5px solid var(--header-bg);
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }
      .subtitle-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: transparent;
        color: var(--header-bg);
        font-size: 0.8rem;
        font-weight: 800;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        padding: 0;
      }
      .btn-secondary {
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-light);
        color: var(--primary);
        border: 1px solid rgba(45, 157, 95, 0.2);
        border-radius: var(--radius-sm);
        padding: 0 1.25rem;
        font-size: 0.875rem;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }
      .btn-secondary:hover {
        background: #dcf2e6;
        color: var(--primary-hover);
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .schedule-empty {
        color: var(--muted);
        text-align: center;
        padding: 2rem 1rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .schedule-list {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8rem;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid rgba(203, 213, 225, 0.4);
      }
      .schedule-list th {
        padding: 0.34rem 0.51rem;
        border-right: 1px solid rgba(203, 213, 225, 0.4);
        border-bottom: none;
        text-align: left;
        vertical-align: top;
        background: var(--header-bg) !important;
        color: #ffffff !important;
        font-weight: 600;
      }
      .schedule-list td {
        padding: 0.34rem 0.51rem;
        border-bottom: 1px solid rgba(203, 213, 225, 0.45);
        border-right: 1px solid rgba(203, 213, 225, 0.45);
        text-align: left;
        vertical-align: top;
        background: var(--surface);
        color: var(--text-secondary);
      }
      .schedule-list tr:nth-child(even) td {
        background: var(--row-alt);
      }
      .schedule-list tr:last-child td {
        border-bottom: none;
      }
      .schedule-list tr th:last-child,
      .schedule-list tr td:last-child {
        border-right: none;
      }
      .schedule-outcome-skipped {
        display: inline-block;
        padding: 0.17rem 0.4rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.75rem;
        background: #fef3c7;
        color: #92400e;
      }
      .schedule-outcome-executed {
        display: inline-block;
        padding: 0.17rem 0.4rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.75rem;
        background: #d1fae5;
        color: #065f46;
      }
      .schedule-form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 0.68rem 0.85rem;
        margin-top: 0.34rem;
      }
      .schedule-field {
        display: flex;
        flex-direction: column;
        gap: 0.21rem;
      }
      .schedule-label {
        font-size: 0.65rem;
        font-weight: 800;
        color: white;
        background: var(--header-bg);
        padding: 0.25rem 1.1rem 0.25rem 0.65rem;
        clip-path: polygon(
          0% 0%,
          calc(100% - 10px) 0%,
          100% 50%,
          calc(100% - 10px) 100%,
          0% 100%
        );
        width: fit-content;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0.2rem;
        filter: drop-shadow(0 0 1px rgba(0, 0, 0, 0.6));
      }
      .schedule-hint {
        font-size: 0.75rem;
        color: var(--muted);
        line-height: 1.3;
      }
      .schedule-note-card {
        background: #f8fafc;
        border: 1px solid rgba(176, 191, 201, 0.35);
        border-radius: var(--radius-sm);
        padding: 0.85rem 1rem;
        margin-top: 1rem;
        margin-right: 0.34rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.5;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }
      .schedule-note-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--header-bg);
      }
      .schedule-select,
      .schedule-input {
        width: 100%;
        height: 34px;
        padding: 0.297rem 1.7rem 0.297rem 0.51rem;
        border: 0.85px solid rgba(176, 191, 201, 0.4);

        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        box-sizing: border-box;
        box-shadow:
          0 0.85px 1.7px rgba(0, 0, 0, 0.06),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.8);
      }
      .schedule-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.85rem center;
      }
      .schedule-select:focus,
      .schedule-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1.7px rgba(45, 157, 95, 0.2),
          0 1.7px 3.4px rgba(0, 0, 0, 0.08),
          inset 0 0.85px 0.85px rgba(255, 255, 255, 0.9);
      }
      .schedule-error {
        margin-top: 0.34rem;
        font-size: 0.78rem;
        color: var(--fail);
      }
      .schedule-field .filter-dropdown {
        width: 100%;
        min-width: 100%;
      }
      .btn-group .retry-failed-btn {
        background: var(--header-bg);
        color: #ffffff;
        border: 1px solid var(--header-border);
      }
      .btn-group .retry-failed-btn:hover {
        background: #1a5758;
        color: #ffffff;
        border-color: #1a5758;
        box-shadow: 0 2px 5px rgba(33, 108, 109, 0.2);
      }
      .btn-group .retry-failed-btn:disabled {
        background: var(--surface);
        color: var(--muted);
        border-color: var(--border-light);
        box-shadow: none;
      }

      /* Data Explorer & Pagination Styles */
      .pagination-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.25rem;
        padding: 0.5rem 0;
      }
      .pagination-btn {
        min-width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .pagination-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--pass-bg);
      }
      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .pagination-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      /* Report Header Styles */
      .report-header {
        background: var(--surface);
        color: var(--header-bg);
        padding: 1.25rem 1.75rem;
        border-radius: var(--radius) var(--radius) 0 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-light);
        min-height: 64px;
      }
      .report-header-left {
        display: flex;
        align-items: center;
        gap: 1.25rem;
      }
      .report-header .logo {
        height: 28px;
        width: auto;
        object-fit: contain;
      }
      .report-header-title {
        margin: 0;
        font-size: 0.78rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #ffffff;
        background: var(--header-bg);
        padding: 0.4rem 1rem;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        line-height: 1.3;
      }
      .report-header .meta {
        color: var(--text-secondary);
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-align: right;
      }
      .report-header .meta p {
        margin: 2px 0;
      }

      .modal-tabs {
        display: flex;
        gap: 1.5rem;
        border-bottom: 1px solid rgba(203, 213, 225, 0.4);
        margin-bottom: 1.25rem;
      }
      .modal-tab-btn {
        background: none;
        border: none;
        padding: 0.75rem 0.25rem;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--muted);
        cursor: pointer;
        position: relative;
        transition: color 0.2s;
      }
      .modal-tab-btn::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--primary);
        transform: scaleX(0);
        transition: transform 0.2s;
        border-radius: 100px;
      }
      .modal-tab-btn:hover {
        color: var(--text);
      }
      .modal-tab-btn.active {
        color: var(--primary);
      }
      .modal-tab-btn.active::after {
        transform: scaleX(1);
      }
      .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .stat-card {
        background: var(--surface);
        border: 1px solid rgba(203, 213, 225, 0.5);
        border-radius: var(--radius);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        box-shadow: var(--shadow-sm);
      }
      .stat-card .stat-label {
        font-size: 0.7rem;
        font-weight: 800;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--header-bg);
      }
      .stat-card.success-card .stat-value {
        color: var(--pass);
      }
      .stat-card.failed-card .stat-value {
        color: var(--fail);
      }

      .search-container {
        position: relative;
        margin-bottom: 1.25rem;
        width: 100%;
      }
      .search-input {
        width: 100%;
        height: 40px;
        padding: 0 1rem 0 2.5rem;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.9rem;
        background: var(--surface);
      }
      .search-icon {
        position: absolute;
        left: 0.85rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
      }
      .data-table tr.row-failed td {
        color: var(--fail);
      }
      .data-table tr.row-success td {
        color: var(--pass);
      }
      .badge {
        font-size: 0.65rem;
        font-weight: 800;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
      }
      .badge-success {
        background: var(--pass-bg);
        color: var(--pass);
      }
      .badge-failed {
        background: var(--fail-bg);
        color: var(--fail);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <a href="/" class="logo-link" title="Go to Home">
          <img
            src="/assets/logo.png"
            alt="intellirevenue"
            class="logo"
            id="logo-img"
          />
          <span class="logo-placeholder" style="display: none"
            >intellirevenue</span
          >
        </a>
        <div class="header-status-panel">
          <span class="header-status-label" title="Current mission filter"
            >Current Scope:</span
          >
          <span class="header-status-value" id="header-status-scope"
            >All Assets</span
          >
        </div>
        <div class="header-right">
          <div class="header-filter-row">
            <div class="header-field-wrap brand-field-wrap">
              <div id="brand-dropdown" class="filter-dropdown">
                <div class="filter-chip">
                  <label class="header-label" for="brand-dropdown-trigger"
                    >Brand</label
                  >
                  <button
                    type="button"
                    id="brand-dropdown-trigger"
                    class="filter-dropdown-trigger"
                    aria-haspopup="listbox"
                    aria-expanded="false"
                    title="Select one or more brands"
                  >
                    Select brand
                  </button>
                </div>
                <div
                  id="brand-dropdown-panel"
                  class="filter-dropdown-panel"
                  role="listbox"
                >
                  <!-- brand options populated dynamically from /api/config -->
                </div>
              </div>
              <div
                id="brand-error"
                class="header-field-error"
                role="alert"
              ></div>
            </div>
            <div class="header-field-wrap purchaser-field-wrap">
              <div id="purchaser-dropdown" class="filter-dropdown">
                <div class="filter-chip">
                  <label class="header-label" for="purchaser-dropdown-trigger"
                    >Purchaser</label
                  >
                  <button
                    type="button"
                    id="purchaser-dropdown-trigger"
                    class="filter-dropdown-trigger"
                    aria-haspopup="listbox"
                    aria-expanded="false"
                    title="Select one or more purchasers"
                  >
                    Select purchaser
                  </button>
                </div>
                <div
                  id="purchaser-dropdown-panel"
                  class="filter-dropdown-panel"
                  role="listbox"
                >
                  <!-- options filled by JS based on selected brands -->
                </div>
              </div>
              <div
                id="purchaser-error"
                class="header-field-error"
                role="alert"
              ></div>
            </div>
            <div class="header-field-wrap header-filter-reset-wrap">
              <button
                type="button"
                id="filter-reset-btn"
                class="header-btn-reset"
                title="Clear brand and purchaser filter"
              >
                Reset Filter
              </button>
              <div class="header-field-error"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="table-section">
        <div class="download-bar" id="download-bar">
          <div class="download-chip">
            <span class="download-bar-label">Reports</span>
            <div class="download-bar-btns" id="download-bar-btns"></div>
          </div>
          <div class="system-status-pill">
            <span class="pulse-dot"></span>
            <span id="system-status-text">System Active</span>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th class="op-name">Operations</th>
              <th class="limits-col">Operation limits</th>
              <th class="run-cell">Operation controls</th>
              <th class="result-header">Operation output</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>

    <div id="schedule-modal-overlay" class="modal-overlay" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="schedule-modal-title"
      >
        <div class="modal-header">
          <div class="modal-title" id="schedule-modal-title">
            <span class="title-badge">SCHEDULE</span>
            <span id="modal-title-text">Dashboard</span>
          </div>
          <button
            type="button"
            id="schedule-modal-close-icon"
            class="modal-close-icon"
            aria-label="Close schedule dialog"
          >
            &#10005;
          </button>
        </div>
        <div class="modal-body" id="schedule-modal-body"></div>
      </div>
    </div>

    <div
      id="notification-modal-overlay"
      class="modal-overlay"
      aria-hidden="true"
    >
      <div
        class="modal"
        style="width: 450px; height: auto; max-height: 90vh"
        role="dialog"
        aria-modal="true"
        aria-labelledby="notification-modal-title"
      >
        <div class="modal-header">
          <div class="modal-title" id="notification-modal-title">
            <span class="title-badge" style="background: #c62828">NOTIFY</span>
            <span>Automated Alert Setup</span>
          </div>
          <button
            type="button"
            id="notification-modal-close-icon"
            class="modal-close-icon"
            aria-label="Close dialog"
          >
            &#10005;
          </button>
        </div>
        <div class="modal-body">
          <p
            style="
              font-size: 0.85rem;
              color: var(--text-secondary);
              margin-bottom: 1.25rem;
            "
          >
            Configure who should be notified when an extractions operation
            encounters issues. Recipients will receive automated emails
            detailing any failures or files requiring manual review.
          </p>

          <div
            class="header-label"
            style="margin-bottom: 0.5rem; display: block"
          >
            Recipient Email IDs
          </div>
          <input
            type="text"
            id="recipient-email-input"
            style="
              width: 100%;
              height: 42px;
              padding: 0 1rem;
              border: 1px solid var(--border-light);
              border-radius: 8px;
              font-family: inherit;
              font-size: 0.95rem;
              margin-bottom: 0.4rem;
              box-sizing: border-box;
            "
            placeholder="e.g. alerts@company.com, admin@site.com"
          />
          <div
            style="
              font-size: 0.75rem;
              color: var(--text-secondary);
              margin-bottom: 0.5rem;
            "
          >
            Separate multiple emails with commas.
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn-secondary"
            id="notification-modal-cancel"
          >
            Cancel
          </button>
          <button
            type="button"
            class="download-report-btn download-report-schedule-btn"
            id="notification-save-btn"
          >
            <span>Save</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Operation Data Explorer Modal -->
    <div
      id="extraction-data-modal-overlay"
      class="modal-overlay"
      aria-hidden="true"
    >
      <div
        class="modal"
        style="
          width: 1000px;
          height: 85vh;
          max-height: 95vh;
          display: flex;
          flex-direction: column;
        "
        role="dialog"
        aria-modal="true"
        aria-labelledby="extraction-data-modal-title"
      >
        <div class="report-header">
          <div class="report-header-left">
            <img src="/assets/logo.png" alt="logo" class="logo" />
            <h1 class="report-header-title" id="extraction-data-modal-title">
              Operation Data Explorer
            </h1>
          </div>
          <button
            type="button"
            id="extraction-data-modal-close-icon"
            class="modal-close-icon"
            style="margin-left: 1rem"
            aria-label="Close dialog"
          >
            &#10005;
          </button>
        </div>
        <div
          class="modal-body"
          id="extraction-data-modal-body"
          style="
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
          "
        >
          <!-- Dashboard Section -->
          <div class="dashboard-stats" id="extraction-stats">
            <!-- Dynamic stats cards will be injected here -->
          </div>

          <!-- Tabs and Search -->
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 2rem;
              border-bottom: 1px solid rgba(203, 213, 225, 0.4);
              margin-bottom: 1rem;
            "
          >
            <div class="modal-tabs" style="margin-bottom: 0; border: none">
              <button class="modal-tab-btn active" data-tab="all">
                All Results
              </button>
              <button class="modal-tab-btn" data-tab="success">
                Succeeded
              </button>
              <button class="modal-tab-btn" data-tab="failed">Failed</button>
            </div>
            <div
              class="search-container"
              style="max-width: 320px; margin-bottom: 0"
            >
              <span class="search-icon"
                ><svg
                  style="width: 16px; height: 16px"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
              ></span>
              <input
                type="text"
                id="extraction-search"
                class="search-input"
                placeholder="Search filenames or patterns..."
              />
            </div>
          </div>

          <!-- Table Content -->
          <div
            id="extraction-table-container"
            style="
              flex: 1;
              overflow-y: auto;
              border: 1px solid var(--border-light);
              border-radius: var(--radius-sm);
            "
          >
            <!-- Dynamic table will be injected here -->
            <div class="schedule-empty">Loading operation data...</div>
          </div>

          <!-- Pagination -->
          <div id="extraction-pagination" class="pagination-wrap">
            <!-- Dynamic pagination buttons will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      (function () {
        var logo = document.getElementById("logo-img");
        var placeholder = logo && logo.nextElementSibling;
        if (logo) {
          if (location.protocol === "file:") logo.src = "assets/logo.png";
          logo.addEventListener("error", function () {
            logo.style.display = "none";
            if (placeholder) placeholder.style.display = "flex";
          });
        }
      })();

      const ICON_DOWNLOAD = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
      const ICON_EXTRACT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 8h8"/><path d="M7 12h10"/><path d="M7 16h6"/></svg>`;
      const ICON_PIPELINE = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h4"/><path d="M14 12h4"/><circle cx="12" cy="12" r="2"/></svg>`;

      const ICON_PLAY = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" style="width:14px;height:14px;margin-right:6px"><path d="M5 3l14 9-14 9V3z"/></svg>`;
      const ICON_RESUME = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:6px"><polygon points="5 3 19 12 5 21 5 3"></polygon><line x1="5" y1="3" x2="5" y2="21"></line></svg>`;
      const ICON_RETRY = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:6px"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`;
      const ICON_RESET = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:6px"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`;
      const ICON_STOP = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" style="width:14px;height:14px;margin-right:6px"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>`;
      const ICON_PAUSE = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" style="width:14px;height:14px;margin-right:6px"><rect x="6" y="4" width="4" height="16" rx="1" /><rect x="14" y="4" width="4" height="16" rx="1" /></svg>`;
      const ICON_PLUS = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
      const ICON_HISTORY = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
      const ICON_EDIT = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
      const ICON_DELETE = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
      const ICON_BACK = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>`;
      const ICON_CHECK = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
      const ICON_MAIL = `<svg class="btn-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="width:14px;height:14px;margin-right:8px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;

      const ICON_SEARCH = `<svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`;
      const ICON_CHEVRON_LEFT = `<svg style="width:14px;height:14px;display:inline-block;vertical-align:middle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`;
      const ICON_CHEVRON_RIGHT = `<svg style="width:14px;height:14px;display:inline-block;vertical-align:middle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

      function setSystemStatus(isBusy, text) {
        var pill = document.querySelector(".system-status-pill");
        var statusText = document.getElementById("system-status-text");
        if (!pill || !statusText) return;
        var newText = text || (isBusy ? "System Busy" : "System Active");
        if (statusText.textContent !== newText) {
          statusText.textContent = newText;
        }
        if (isBusy) {
          if (!pill.classList.contains("busy")) pill.classList.add("busy");
        } else {
          if (pill.classList.contains("busy")) pill.classList.remove("busy");
        }
      }

      const ROWS = [
        {
          id: "P1",
          title: "Cloud Download",
          description: "Download files to staging",
          limits: { sync: true, extract: false },
          iconHtml: ICON_DOWNLOAD,
        },
        {
          id: "P2",
          title: "Extract",
          description: "Run extraction with staging files and no Cloud sync",
          limits: { sync: false, extract: true },
          iconHtml: ICON_EXTRACT,
        },
        {
          id: "PIPE",
          title: "Sync & Extract",
          description: "Sync from Cloud then extract in one run",
          limits: { pipeline: true },
          iconHtml: ICON_PIPELINE,
        },
      ];

      function renderLimitsCell(c) {
        const lim = c.limits || {
          sync: false,
          extract: false,
          pipeline: false,
        };
        if (!lim.sync && !lim.extract && !lim.pipeline) {
          return '<td class="limits-cell"><span class="n/a">â€”</span></td>';
        }
        var html = '<td class="limits-cell"><div class="limit-row">';
        if (lim.pipeline) {
          html +=
            '<div class="limit-chip"><span class="limit-label">Limit:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to sync; each is extracted in background as it is synced. 0 = no limit"></div>';
        } else {
          if (lim.sync) {
            html +=
              '<div class="limit-chip"><span class="limit-label">Sync:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to download. 0 = no limit"></div>';
          }
          if (lim.extract) {
            html +=
              '<div class="limit-chip"><span class="limit-label">Extract:</span><input type="number" class="limit-extract" min="0" step="1" value="0" title="Max files to extract. 0 = no limit"></div>';
          }
        }
        html += '</div><div class="limit-hint">0 = no limit</div></td>';
        return html;
      }

      function getRunButtonLabel(caseId) {
        if (caseId === "P1") return "Start Download";
        if (caseId === "P2") return "Start Operation";
        if (caseId === "PIPE") return "Sync & Operation";
        return "Run";
      }

      function renderRow(c, sectionId) {
        const tr = document.createElement("tr");
        const resultCell = document.createElement("td");
        resultCell.className = "result-cell";
        const resultDiv = document.createElement("div");
        resultDiv.className = "result result-placeholder";
        resultDiv.id = "result-" + c.id;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Ready to extract. Configure filters and click Run.</span>';
        resultCell.appendChild(resultDiv);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "run";
        btn.innerHTML =
          ICON_PLAY + "<span>" + getRunButtonLabel(c.id) + "</span>";
        btn.title = getRunButtonLabel(c.id);
        btn.onclick = function () {
          runCase(c.id, btn, resultDiv, null);
        };
        const resetBtn = document.createElement("button");
        resetBtn.type = "button";
        resetBtn.className = "reset-case";
        resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
        resetBtn.onclick = function () {
          resetCase(resultDiv);
        };
        // Add Retry Failed button for extraction-related cases
        let retryBtn = null;
        if (c.id === "P2") {
          retryBtn = document.createElement("button");
          retryBtn.type = "button";
          retryBtn.className = "run retry-failed-btn";
          retryBtn.innerHTML = ICON_RETRY + "<span>Retry Failed</span>";
          retryBtn.title = "Only retry extractions that previously failed";
          retryBtn.onclick = function () {
            runCase(c.id, retryBtn, resultDiv, { retryFailed: true });
          };
        }
        const resetDuringResumeBtn = document.createElement("button");
        resetDuringResumeBtn.type = "button";
        resetDuringResumeBtn.className = "reset-case reset-during-resume";
        resetDuringResumeBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
        resetDuringResumeBtn.title = "Clear result and exit resume mode";
        resetDuringResumeBtn.onclick = function () {
          resetCase(resultDiv);
          resetDuringResumeBtn.classList.remove("show-during-resume");
          resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
          resetBtn.classList.remove("resume-btn");
          resetBtn.onclick = function () {
            resetCase(resultDiv);
          };
          if (tr._resumeSync !== undefined) delete tr._resumeSync;
          if (tr._resumeExtract !== undefined) delete tr._resumeExtract;
        };
        tr.innerHTML =
          '<td class="op-name">' +
          '<div class="op-content-wrap">' +
          '<div class="op-icon-wrap">' +
          c.iconHtml +
          "</div>" +
          '<span class="op-title">' +
          escapeHtml(c.title) +
          "</span>" +
          '<span class="op-description">' +
          escapeHtml(c.description) +
          "</span>" +
          "</div>" +
          "</td>" +
          renderLimitsCell(c) +
          '<td class="run-cell"><div class="btn-group"><div class="btn-row"></div></div></td>';
        tr.querySelector(".btn-row").appendChild(btn);
        if (retryBtn) tr.querySelector(".btn-row").appendChild(retryBtn);
        tr.querySelector(".btn-row").appendChild(resetBtn);
        tr.querySelector(".btn-row").appendChild(resetDuringResumeBtn);
        tr.appendChild(resultCell);
        tr.setAttribute("data-case-id", c.id);
        return tr;
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showResult(
        div,
        data,
        pass,
        progress,
        syncProgress,
        extractionProgress,
        caseId,
        resumeSkipSyncProgress,
        resumeSkipExtractProgress,
        logMessage,
      ) {
        var resultClass = "running";
        if (data) resultClass = pass ? "pass" : "fail";
        div.className = "result " + resultClass;
        var row = div.closest("tr");
        if (!data) {
          var label;
          var extra = "";
          if (logMessage) {
            label = logMessage;
            // If there's a specific log message, we don't need the default loading dots or progress bars
            // unless they are explicitly part of the log message.
            // For now, let's assume logMessage replaces the primary label.
            // We might want to keep progress bars if logMessage is just an additional detail.
            // For this change, I'll make logMessage override the main label.
            var showDots = false; // Override default showDots behavior if logMessage is present
          } else {
            var showDots = true; // Default behavior if no logMessage
          }

          var hasResumeSkipSync =
            resumeSkipSyncProgress != null &&
            (resumeSkipSyncProgress.skipped != null ||
              resumeSkipSyncProgress.total != null);
          var hasResumeSkipExtract =
            resumeSkipExtractProgress != null &&
            (resumeSkipExtractProgress.skipped != null ||
              resumeSkipExtractProgress.total != null);
          var hasSync =
            syncProgress != null &&
            (syncProgress.done != null || syncProgress.total != null);
          var hasExtraction =
            extractionProgress != null &&
            (extractionProgress.done != null ||
              extractionProgress.total != null);
          if (hasResumeSkipSync && caseId !== "PIPE") {
            var skipSync = Number(resumeSkipSyncProgress.skipped) || 0;
            var skipSyncTotal = Number(resumeSkipSyncProgress.total) || 0;
            var skipSyncPct =
              skipSyncTotal > 0
                ? Math.min(100, Math.round((100 * skipSync) / skipSyncTotal))
                : 100;
            extra +=
              '<div class="sync-progress-wrap skip-progress-wrap">Skipping synced files: ' +
              skipSync +
              " / " +
              skipSyncTotal +
              " skipped</div>" +
              '<div class="sync-progress-bar"><div class="sync-progress-fill skip-fill" style="width:' +
              skipSyncPct +
              '%"></div></div>';
          }
          if (hasResumeSkipExtract) {
            var skipExt = Number(resumeSkipExtractProgress.skipped) || 0;
            var skipExtTotal = Number(resumeSkipExtractProgress.total) || 0;
            var skipExtPct =
              skipExtTotal > 0
                ? Math.min(100, Math.round((100 * skipExt) / skipExtTotal))
                : 100;
            extra +=
              '<div class="sync-progress-wrap skip-progress-wrap">Skipping extracted files: ' +
              skipExt +
              " / " +
              skipExtTotal +
              " skipped</div>" +
              '<div class="sync-progress-bar"><div class="sync-progress-fill skip-fill" style="width:' +
              skipExtPct +
              '%"></div></div>';
          }
          if (hasSync) {
            var done = Number(syncProgress.done) || 0;
            var total = Number(syncProgress.total) || 0;
            var pct =
              total > 0 ? Math.min(100, Math.round((100 * done) / total)) : 0;
            extra +=
              '<div class="sync-progress-wrap">Downloading: ' +
              (total > 0 ? done + " / " + total : done + " file(s)") +
              "</div>" +
              (total > 0
                ? done === 0
                  ? '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>'
                  : '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' +
                    pct +
                    '%"></div></div>'
                : done === 0
                  ? '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>'
                  : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          }
          if (hasExtraction) {
            var extDone = Number(extractionProgress.done) || 0;
            var extTotal = Number(extractionProgress.total) || 0;
            var extPct =
              extTotal > 0
                ? Math.min(100, Math.round((100 * extDone) / extTotal))
                : 0;
            extra +=
              '<div class="sync-progress-wrap extraction-progress-wrap">Extracting: ' +
              (extTotal > 0
                ? extDone + " / " + extTotal
                : extDone + " file(s)") +
              "</div>" +
              (extTotal > 0
                ? extDone === 0
                  ? '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>'
                  : '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' +
                    extPct +
                    '%"></div></div>'
                : extDone === 0
                  ? '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>'
                  : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          }
          // Only set label if not already set by logMessage
          if (!logMessage) {
            if (
              hasResumeSkipSync ||
              hasResumeSkipExtract ||
              hasSync ||
              hasExtraction
            ) {
              showDots = false;
              var showSyncSkipLabel = hasResumeSkipSync && caseId !== "PIPE";
              label = showSyncSkipLabel
                ? "Skipping synced filesâ€¦"
                : hasResumeSkipExtract && !hasSync && !hasExtraction
                  ? "Skipping extracted filesâ€¦"
                  : hasResumeSkipExtract && (hasSync || hasExtraction)
                    ? "Skipped extract, syncing/extractingâ€¦"
                    : hasSync && hasExtraction
                      ? "Sync & extractâ€¦"
                      : hasSync
                        ? "Syncingâ€¦"
                        : "Extractingâ€¦";
            } else {
              var pctVal =
                progress && progress.percent != null
                  ? Number(progress.percent)
                  : null;
              var doneVal =
                progress && progress.done != null
                  ? Number(progress.done)
                  : null;
              var totalVal =
                progress && progress.total != null
                  ? Number(progress.total)
                  : null;
              if (
                pctVal != null &&
                totalVal != null &&
                totalVal > 0 &&
                doneVal != null
              ) {
                label =
                  "Runningâ€¦ " +
                  pctVal +
                  "% (" +
                  doneVal +
                  " / " +
                  totalVal +
                  ")";
                showDots = false;
              } else if (pctVal != null) {
                label = "Runningâ€¦ " + pctVal + "%";
                showDots = false;
              } else {
                label = "Runningâ€¦";
              }
            }
          }
          div.innerHTML =
            '<span class="exit">' +
            escapeHtml(label) +
            (showDots ? '<span class="loading-dots"></span>' : "") +
            "</span>" +
            (showDots
              ? '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>'
              : "") +
            extra;
          return;
        }
        var stdoutStr = (data.stdout && String(data.stdout).trim()) || "";
        var stderrStr = (data.stderr && String(data.stderr).trim()) || "";
        var syncProgressPrefix = "SYNC_PROGRESS\t";
        function filterResultLine(line) {
          if (line.indexOf(syncProgressPrefix) === 0) return false;
          if (
            line.indexOf("RESUME_SKIP\t") === 0 ||
            line.indexOf("RESUME_SKIP_SYNC\t") === 0
          )
            return false;
          if (line.indexOf("Report(s) written:") !== -1) return false;
          if (/Run (?:run_|RUN|SKIP-)\S+ finished\./.test(line)) return false;
          return true;
        }
        var stdoutFiltered = stdoutStr
          ? stdoutStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var stderrFiltered = stderrStr
          ? stderrStr.split("\n").filter(filterResultLine).join("\n").trim()
          : "";
        var statusLabel = pass ? "Success" : "Failed";
        var parsed = {};
        var lines = stdoutFiltered ? stdoutFiltered.split("\n") : [];
        for (var i = 0; i < lines.length; i++) {
          var line = (lines[i] || "").trim().replace(/\r$/, "");
          var m;
          if ((m = /^Download limit:\s*(.+)$/.exec(line)))
            parsed.downloadLimit = m[1].trim();
          else if ((m = /^Downloaded \(new\):\s*(\d+)\s*$/.exec(line)))
            parsed.downloadedNew = m[1];
          else if (
            (m = /^Skipped \(already present[^:]*:\s*(\d+)\s*$/.exec(line))
          )
            parsed.skipped = m[1];
          else if ((m = /^Errors:\s*(\d+)\s*$/.exec(line)))
            parsed.errors = m[1];
          else if ((m = /^\s+Staging path:\s*(.+)$/.exec(line))) {
            if (!parsed.stagingPaths) parsed.stagingPaths = [];
            parsed.stagingPaths.push(m[1].trim());
          } else if (
            (m = /^Scoped to tenant:\s*([^,]+),\s*purchaser:\s*(.+)$/.exec(
              line,
            ))
          ) {
            parsed.brandAndPurchaser = (
              m[1].trim() +
              " / " +
              m[2].trim()
            ).trim();
          } else if (
            (m = /^\s{2}([^:\s][^:]*)\s*$/.exec(line)) &&
            line.indexOf("/") !== -1 &&
            !/Staging path|Downloaded:|Skipped:|Errors:/.test(line)
          ) {
            if (!parsed.brandAndPurchaserList)
              parsed.brandAndPurchaserList = [];
            parsed.brandAndPurchaserList.push(line.trim());
          } else if (
            (m =
              /^Extraction metrics:\s*success=(\d+),\s*skipped=(\d+),\s*failed=(\d+)\s*$/.exec(
                line,
              ))
          ) {
            // Match CLI output: "Extraction metrics: success=X, skipped=Y, failed=Z"
            parsed.extractSuccess = m[1];
            parsed.extractSkipped = m[2];
            parsed.extractFailed = m[3];
          } else if (
            (m = /^Extraction result\(s\):\s*(.+?)\s*\(full/.exec(line))
          )
            parsed.extractionResultsPath = m[1].trim();
          else if ((m = /^Reports path:\s*(.+)$/.exec(line)))
            parsed.reportsPath = m[1].trim();
          else if (
            (m =
              /^CUMULATIVE_METRICS\tsuccess=(\d+),failed=(\d+),total=(\d+)\s*$/.exec(
                line,
              ))
          ) {
            parsed.cumSuccess = m[1];
            parsed.cumFailed = m[2];
            parsed.cumTotal = m[3];
          }
        }
        var syncCases = ["P1", "PIPE", "P5"];
        var extractCases = ["P2", "PIPE", "P5", "P3"];
        var hasSync =
          caseId &&
          syncCases.indexOf(caseId) !== -1 &&
          (parsed.downloadLimit != null || parsed.downloadedNew != null);
        var hasExtract =
          caseId &&
          extractCases.indexOf(caseId) !== -1 &&
          (parsed.extractSuccess != null ||
            parsed.extractionResultsPath != null ||
            parsed.reportsPath != null);
        var allExtractZero =
          (parsed.extractSuccess === "0" || parsed.extractSuccess === 0) &&
          (parsed.extractFailed === "0" || parsed.extractFailed === 0) &&
          (parsed.extractSkipped === "0" || parsed.extractSkipped === 0);
        var noSyncDownloaded =
          parsed.downloadedNew == null || parsed.downloadedNew === "0";
        var hasExtractionMetrics =
          parsed.extractSuccess != null ||
          parsed.extractFailed != null ||
          parsed.extractSkipped != null;
        var noFilesFound =
          pass && allExtractZero && (noSyncDownloaded || !hasSync);
        // Special case: if we have cumulative data, it's not "no files" even if this run did nothing
        if (parsed.cumTotal != null && Number(parsed.cumTotal) > 0) {
          noFilesFound = false;
        }
        var rows = [];
        rows.push(["Status", statusLabel]);
        if (noFilesFound) {
          var msg = "No files found to sync or extract.";
          if (row && row._isRetryFailed) {
            msg = "No failed files found to retry.";
          }
          rows.push(["Message", msg]);
        } else {
          if (hasSync) {
            var brandPurchaser =
              parsed.brandAndPurchaser ||
              (parsed.brandAndPurchaserList &&
              parsed.brandAndPurchaserList.length
                ? parsed.brandAndPurchaserList.join("\n")
                : null);
            if (brandPurchaser)
              rows.push(["Brand and purchaser", brandPurchaser]);
            if (parsed.stagingPaths && parsed.stagingPaths.length)
              rows.push(["Staging path", parsed.stagingPaths.join("\n")]);
            var overview = [];
            if (parsed.downloadedNew != null)
              overview.push("Downloaded: " + escapeHtml(parsed.downloadedNew));
            if (parsed.skipped != null) {
              var skippedLabel = escapeHtml(parsed.skipped);
              var skippedHtml =
                'Skipped<span class="info-icon" title="These files were already synced in a previous run and are unchanged, so they were skipped.">i</span>: ' +
                skippedLabel;
              overview.push(skippedHtml);
            }
            if (parsed.errors != null)
              overview.push("Errors: " + escapeHtml(parsed.errors));
            if (overview.length)
              rows.push(["Download overview", overview.join(", ")]);
          }
          if (hasExtract) {
            if (parsed.brandAndPurchaser && !hasSync)
              rows.push(["Brand and purchaser", parsed.brandAndPurchaser]);
            if (
              parsed.extractSuccess != null ||
              parsed.extractFailed != null ||
              parsed.extractSkipped != null
            ) {
              var successVal = parsed.extractSuccess || "0";
              var skippedVal = parsed.extractSkipped || "0";
              var failedVal = parsed.extractFailed || "0";
              var skippedLabel2 = escapeHtml(skippedVal);
              var detail =
                "Success: " +
                escapeHtml(successVal) +
                ', Skipped<span class="info-icon" title="These files were already extracted in a previous run, so they were skipped this time.">i</span>: ' +
                skippedLabel2 +
                ", Failed: " +
                escapeHtml(failedVal);
              rows.push(["Extraction overview", detail]);
            }
            if (parsed.cumTotal != null) {
              var cumDetail =
                "Success: " +
                escapeHtml(parsed.cumSuccess) +
                ", Failed: " +
                escapeHtml(parsed.cumFailed) +
                ' <span class="info-icon" title="Aggregated status of all unique files found for this filter across all historical runs.">i</span> (Total: ' +
                escapeHtml(parsed.cumTotal) +
                ")";
              rows.push(["Overall status", cumDetail]);
            }
            if (parsed.extractionResultsPath || parsed.reportsPath) {
              rows.push([
                "Operation report",
                "Reports and extraction data are ready. View the summary from <b>Reports</b>.",
              ]);
            }
          }
          if (!hasSync && !hasExtract && stdoutFiltered) {
            rows.push([
              "Output",
              escapeHtml(stdoutFiltered.slice(0, 5000)) +
                (stdoutFiltered.length > 5000 ? "â€¦" : ""),
            ]);
          } else if (rows.length === 1) {
            var noOutput = !stdoutFiltered && !stderrFiltered;
            rows.push([
              "Output",
              noOutput && data.exitCode === 0
                ? "Command completed successfully with no console output."
                : noOutput
                  ? "Command produced no output. Check server logs or run in a terminal for details."
                  : "â€”",
            ]);
          }
        }
        if (stderrFiltered)
          rows.push([
            "Standard error",
            escapeHtml(stderrFiltered.slice(0, 5000)) +
              (stderrFiltered.length > 5000 ? "â€¦" : ""),
          ]);
        var tableRows = rows.map(function (r) {
          return (
            "<tr" +
            (r[0] === "Status" ? ' class="status-row"' : "") +
            "><th>" +
            escapeHtml(r[0]) +
            "</th><td>" +
            (r[0] === "Standard error" ||
            r[0] === "Output" ||
            r[0] === "Download overview" ||
            r[0] === "Extraction overview" ||
            r[0] === "Overall status" ||
            r[0] === "Operation report"
              ? r[1]
              : escapeHtml(r[1]).replace(/\n/g, "<br>")) +
            "</td></tr>"
          );
        });
        div.innerHTML =
          '<table class="result-table-wrap">' + tableRows.join("") + "</table>";
      }

      function resetCase(resultDiv, options) {
        if (!resultDiv) return;
        var row = resultDiv.closest("tr");
        var caseId = row ? row.getAttribute("data-case-id") : null;
        // If this row has an active controller (in-flight run), abort it so reset truly stops execution.
        if (
          row &&
          row._activeController &&
          !row._activeController.signal.aborted
        ) {
          row._abortedByHardReset = true;
          try {
            row._activeController.abort();
          } catch (_) {}
        }
        // Clear server and localStorage so reload shows clean state (reset = abort, user must re-run).
        if (caseId) {
          try {
            localStorage.removeItem("intelliextract-run-state-" + caseId);
          } catch (_) {}
          fetch("/api/run-state/clear", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ caseId: caseId }),
          }).catch(function () {});
        }
        var clearLimits = !options || options.clearLimits !== false;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Ready to extract. Configure filters and click Run.</span>';
        resultDiv.className = "result result-placeholder";
        if (row) {
          var inputs = row.querySelectorAll(".limit-sync, .limit-extract");
          inputs.forEach(function (input) {
            input.disabled = false;
          });
          if (clearLimits) {
            inputs.forEach(function (input) {
              input.value = "0";
            });
          }
          if (row._resumeSyncLimit !== undefined) delete row._resumeSyncLimit;
          if (row._resumeExtractLimit !== undefined)
            delete row._resumeExtractLimit;
          if (row._resumeSync !== undefined) delete row._resumeSync;
          if (row._resumeExtract !== undefined) delete row._resumeExtract;
          if (row._isRetryFailed !== undefined) delete row._isRetryFailed;
          var runBtn = row.querySelector("button.run");
          if (runBtn) {
            runBtn.disabled = false;
            runBtn.title = runBtn.textContent || "";
          }
          var resetBtn = row.querySelector(
            "button.reset-case:not(.reset-during-resume)",
          );
          if (resetBtn) {
            resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
            resetBtn.classList.remove("stop-btn", "resume-btn", "pause-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
          var resetDuringResumeBtn = row.querySelector(".reset-during-resume");
          if (resetDuringResumeBtn)
            resetDuringResumeBtn.classList.remove("show-during-resume");
          setOtherRowsActive();
        }
      }

      var OTHER_RUN_DISABLED_TITLE =
        "Please pause/stop the other run to execute this.";
      var RESUME_OTHER_DISABLED_TITLE =
        "Please reset the other case to execute this.";
      var ROW_INACTIVE_HOVER_TITLE =
        "Please pause/stop and reset the current process to execute this.";
      function setOtherRowsInactive(currentRow, title) {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var msg = title != null ? title : OTHER_RUN_DISABLED_TITLE;
        var rows = tbody.querySelectorAll("tr");
        rows.forEach(function (tr) {
          if (tr === currentRow) return;
          tr.classList.add("row-inactive");
          tr.setAttribute("title", ROW_INACTIVE_HOVER_TITLE);
          tr.querySelectorAll("button.run").forEach(function (btn) {
            btn.disabled = true;
            btn.title = msg;
          });
          tr.querySelectorAll("button.reset-case").forEach(function (b) {
            b.disabled = true;
          });
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = true;
            },
          );
        });
      }
      function setOtherRowsActive() {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var rows = tbody.querySelectorAll("tr");
        rows.forEach(function (tr) {
          tr.classList.remove("row-inactive");
          tr.removeAttribute("title");
          tr.querySelectorAll("button.run").forEach(function (btn) {
            btn.disabled = false;
            btn.title = btn.textContent || "";
          });
          tr.querySelectorAll("button.reset-case").forEach(function (b) {
            b.disabled = false;
          });
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = false;
            },
          );
        });
      }

      function getParamsFromRow(row) {
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncLimit = syncInput ? Number.parseInt(syncInput.value, 10) : 0;
        var extractLimit = extractInput
          ? Number.parseInt(extractInput.value, 10)
          : 0;
        return {
          syncLimit: Number.isNaN(syncLimit) ? 0 : Math.max(0, syncLimit),
          extractLimit: Number.isNaN(extractLimit)
            ? 0
            : Math.max(0, extractLimit),
        };
      }

      function attachSelectAll(panelId, onToggle) {
        var panel = document.getElementById(panelId);
        if (!panel) return;
        var allCb = panel.querySelector('input[value="ALL"]');
        if (!allCb) return;
        var otherCbs = Array.from(
          panel.querySelectorAll('input[type=checkbox]:not([value="ALL"])'),
        );
        allCb.onchange = function () {
          var checked = allCb.checked;
          otherCbs.forEach(function (cb) {
            cb.checked = checked;
          });
          if (onToggle) onToggle();
        };
        otherCbs.forEach(function (cb) {
          cb.onchange = function () {
            allCb.checked =
              otherCbs.length > 0 &&
              otherCbs.every(function (c) {
                return c.checked;
              });
            if (onToggle) onToggle();
          };
        });
        if (otherCbs.length > 0) {
          allCb.checked = otherCbs.every(function (c) {
            return c.checked;
          });
        }
      }

      function getSelectedBrands() {
        var panel = document.getElementById("brand-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll(
            "input[type=checkbox]:checked:not([value='ALL'])",
          ),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function getSelectedPurchasers() {
        var panel = document.getElementById("purchaser-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll(
            "input[type=checkbox]:checked:not([value='ALL'])",
          ),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function hasFilterSelection() {
        return (
          getSelectedBrands().length > 0 || getSelectedPurchasers().length > 0
        );
      }
      function clearValidationAlertWhenFilterSelected() {
        if (!hasFilterSelection()) return;
        var rows = document.getElementById("rows");
        if (!rows) return;
        rows
          .querySelectorAll(".result.result-validation-alert")
          .forEach(function (div) {
            div.className = "result result-placeholder";
            div.innerHTML =
              '<span class="result-placeholder-text">Ready to extract. Configure filters and click Run.</span>';
          });
      }
      function getTenantPurchaserPairs() {
        var brands = getSelectedBrands();
        var purchasers = getSelectedPurchasers();
        if (brands.length === 0 && purchasers.length === 0) return [];
        if (brands.length === 0) brands = Object.keys(BRAND_PURCHASERS || {});
        if (purchasers.length === 0) {
          var set = new Set();
          brands.forEach(function (b) {
            (BRAND_PURCHASERS[b] || []).forEach(function (p) {
              set.add(p);
            });
          });
          purchasers = Array.from(set);
        }
        var pairs = [];
        brands.forEach(function (tenant) {
          var allowed = BRAND_PURCHASERS[tenant];
          if (!allowed) return;
          purchasers.forEach(function (purchaser) {
            if (allowed.indexOf(purchaser) !== -1)
              pairs.push({ tenant: tenant, purchaser: purchaser });
          });
        });
        return pairs;
      }
      function getTenantPurchaser() {
        var pairs = getTenantPurchaserPairs();
        if (pairs.length === 0)
          return { tenant: undefined, purchaser: undefined, pairs: [] };
        if (pairs.length === 1)
          return {
            tenant: pairs[0].tenant,
            purchaser: pairs[0].purchaser,
            pairs: pairs,
          };
        return { tenant: undefined, purchaser: undefined, pairs: pairs };
      }

      async function runCase(caseId, btn, resultDiv, runOptions) {
        var isResume = runOptions && runOptions.resume === true;
        var row = btn.closest("tr");
        if (row && isResume) {
          row._aborted = false;
        }
        if (!hasFilterSelection()) {
          resultDiv.className =
            "result result-placeholder result-validation-alert";
          resultDiv.innerHTML =
            '<span class="result-placeholder-text">Please select at least one brand or purchaser from filter.</span>';
          return;
        }
        var pairs = getTenantPurchaserPairs();
        var brands = getSelectedBrands();
        var purchasers = getSelectedPurchasers();
        if (brands.length > 0 && purchasers.length > 0 && pairs.length === 0) {
          resultDiv.className =
            "result result-placeholder result-validation-alert";
          resultDiv.innerHTML =
            '<span class="result-placeholder-text">No valid brand/purchaser combination for the selected filter. Use Reset filter and try again.</span>';
          return;
        }
        clearBrandError();
        clearPurchaserError();
        var tp = getTenantPurchaser();
        if (!row) row = btn.closest("tr");
        var resetBtn = row ? row.querySelector(".reset-case") : null;
        var controller = new AbortController();
        if (row) {
          row._activeController = controller;
          row._abortedByHardReset = false;
        }
        function restoreResetBtn() {
          if (resetBtn) {
            resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
            resetBtn.classList.remove("stop-btn", "resume-btn", "pause-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
          if (row) {
            var limitInputs = row.querySelectorAll(
              ".limit-sync, .limit-extract",
            );
            limitInputs.forEach(function (input) {
              input.disabled = false;
            });
          }
          setSystemStatus(false);
        }
        if (isResume) row._aborted = false;
        if (row && !isResume && row._activeController) {
          if (resetBtn) {
            resetBtn.innerHTML = ICON_RESUME + "<span>Resume</span>";
            resetBtn.classList.remove("stop-btn", "pause-btn");
            resetBtn.classList.add("resume-btn");
            resetBtn.onclick = function () {
              runCase(caseId, btn, resultDiv, { resume: true });
            };
            var limitInputs = row.querySelectorAll(
              ".limit-sync, .limit-extract",
            );
            if (limitInputs) {
              limitInputs.forEach(function (input) {
                input.disabled = false;
              });
            }
          }
        }

        // Save state to localStorage as backup
        try {
          localStorage.setItem(
            "intelliextract-run-state-" + caseId,
            JSON.stringify({
              startTime: new Date().toISOString(),
              params: params,
              status: "running",
            }),
          );
        } catch (_) {}

        if (resetBtn) {
          resetBtn.innerHTML = ICON_PAUSE + "<span>Pause</span>";
          resetBtn.title = "Pause/Stop the execution";
          resetBtn.classList.remove("resume-btn");
          resetBtn.classList.add("pause-btn");
          resetBtn.onclick = function () {
            controller.abort();
          };
        }
        var isRetry = !!(runOptions && runOptions.retryFailed);
        var initStatus = isRetry
          ? "Retrying Failed Extractions..."
          : caseId === "P1" || caseId === "P4" || caseId === "E3"
            ? "Syncing Files..."
            : caseId === "P2" ||
                caseId === "P5" ||
                caseId === "P6" ||
                caseId === "E1" ||
                caseId === "E2" ||
                caseId === "E5"
              ? "Extracting Files..."
              : caseId === "PIPE"
                ? "Syncing Files..." // Starts with sync
                : "Running Operation...";
        setSystemStatus(true, initStatus);
        if (row) {
          row.querySelectorAll("button.run").forEach(function (b) {
            b.disabled = true;
          });
        } else {
          btn.disabled = true;
        }
        setOtherRowsInactive(row, OTHER_RUN_DISABLED_TITLE);
        if (row) {
          row._isRetryFailed = !!(runOptions && runOptions.retryFailed);
        }
        showResult(
          resultDiv,
          null,
          false,
          null,
          null,
          null,
          caseId,
          null,
          null,
          null, // logMessage
        );
        var params;
        if (
          isResume &&
          row &&
          (row._resumeSyncLimit != null || row._resumeExtractLimit != null)
        ) {
          params = {
            syncLimit: row._resumeSyncLimit != null ? row._resumeSyncLimit : 0,
            extractLimit:
              row._resumeExtractLimit != null ? row._resumeExtractLimit : 0,
          };
        } else {
          params = getParamsFromRow(row);
          if (row && !isResume) {
            row._resumeSyncLimit = params.syncLimit;
            row._resumeExtractLimit = params.extractLimit;
          }
        }
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncIsZero =
          syncInput && Number.parseInt(syncInput.value, 10) === 0;
        var extractIsZero =
          extractInput && Number.parseInt(extractInput.value, 10) === 0;
        if (!isResume) {
          syncIsZero = params.syncLimit === 0;
          extractIsZero = params.extractLimit === 0;
        }
        var hasSyncLimit = !!syncInput;
        var hasExtractLimit = !!extractInput;
        var isNoLimit =
          (hasSyncLimit && syncIsZero) || (hasExtractLimit && extractIsZero);
        if (isNoLimit && !isResume) {
          var proceed = window.confirm(
            "Limit is set to 0 (no limit). This will process all files and may take a long time. Continue?",
          );
          if (!proceed) {
            btn.disabled = false;
            resetCase(resultDiv, { clearLimits: false });
            restoreResetBtn();
            return;
          }
        }
        try {
          var body = {
            caseId: caseId,
            syncLimit: params.syncLimit,
            extractLimit: params.extractLimit,
            retryFailed: !!(runOptions && runOptions.retryFailed),
          };
          if (isResume) {
            body.resume = true;
            if (
              row &&
              (row._resumeSync != null || row._resumeExtract != null)
            ) {
              if (row._resumeSync != null)
                body.lastSyncDone = row._resumeSync.done;
              if (row._resumeExtract != null)
                body.lastExtractDone = row._resumeExtract.done;
            }
            if (row && row._resumeRunId) {
              body.runId = row._resumeRunId;
            }
          }
          if (tp.pairs && tp.pairs.length > 0) {
            body.pairs = tp.pairs;
            if (tp.pairs.length === 1) {
              body.tenant = tp.pairs[0].tenant;
              body.purchaser = tp.pairs[0].purchaser;
            }
          } else {
            body.tenant = tp.tenant;
            body.purchaser = tp.purchaser;
          }
          var r = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
            signal: controller.signal,
          });
          if (!r.ok || !r.body) {
            var errText = await r.text();
            try {
              var errJson = JSON.parse(errText);
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: errText },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
              null, // logMessage
            );
            return;
          }
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buffer = "";
          var data = null;
          var lastSyncProgress = null;
          var lastExtractionProgress = null;
          var lastResumeSkipSync = null;
          var lastResumeSkipExtract = null;
          var lastLogMessage = null;
          row._lastLogMessage = null;
          while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split("\n");
            buffer = lines.pop() || "";
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (!line) continue;
              try {
                var msg = JSON.parse(line);
                if (msg.type === "progress" && msg.percent != null) {
                  showResult(
                    resultDiv,
                    null,
                    false,
                    { percent: msg.percent, done: msg.done, total: msg.total },
                    null,
                    null,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                    lastLogMessage,
                  );
                } else if (msg.type === "log") {
                  lastLogMessage = msg.message;
                  if (row) row._lastLogMessage = msg.message;
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                    lastLogMessage,
                  );
                } else if (msg.type === "resume_skip_sync") {
                  setSystemStatus(true, "Skipping Synced Files...");
                  lastResumeSkipSync = {
                    skipped: msg.skipped,
                    total: msg.total,
                  };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                    lastLogMessage,
                  );
                } else if (msg.type === "resume_skip") {
                  setSystemStatus(true, "Skipping Extracted Files...");
                  lastResumeSkipExtract = {
                    skipped: msg.skipped,
                    total: msg.total,
                  };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "sync_progress") {
                  setSystemStatus(true, "Syncing Files...");
                  lastSyncProgress = { done: msg.done, total: msg.total };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "extraction_progress") {
                  setSystemStatus(true, "Extracting Files...");
                  lastExtractionProgress = { done: msg.done, total: msg.total };
                  showResult(
                    resultDiv,
                    null,
                    false,
                    null,
                    lastSyncProgress,
                    lastExtractionProgress,
                    caseId,
                    lastResumeSkipSync,
                    lastResumeSkipExtract,
                  );
                } else if (msg.type === "run_id") {
                  if (row) row._currentRunId = msg.runId;
                } else if (msg.type === "result") {
                  data = msg;
                } else if (msg.error) {
                  data = { exitCode: 1, stdout: "", stderr: msg.error };
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              var msg = JSON.parse(buffer.trim());
              if (msg.type === "result") data = msg;
              else if (msg.error)
                data = { exitCode: 1, stdout: "", stderr: msg.error };
            } catch (_) {}
          }
          if (!data) {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: "No result from server" },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
            );
            return;
          }
          var expectFail = caseId.indexOf("N") === 0;
          var pass = expectFail ? data.exitCode !== 0 : data.exitCode === 0;
          showResult(
            resultDiv,
            data,
            pass,
            null,
            null,
            null,
            caseId,
            null,
            null,
          );
        } catch (e) {
          if (e.name === "AbortError") {
            // If abort was triggered via a hard reset, fully reset UI/state and do not enter resume mode.
            if (row && row._abortedByHardReset) {
              row._abortedByHardReset = false;
              if (row._resumeSync !== undefined) delete row._resumeSync;
              if (row._resumeExtract !== undefined) delete row._resumeExtract;
              if (row._resumeSyncLimit !== undefined)
                delete row._resumeSyncLimit;
              if (row._resumeExtractLimit !== undefined)
                delete row._resumeExtractLimit;
              resetCase(resultDiv);
            } else {
              if (row) {
                row._aborted = true;
                row._resumeSync = lastSyncProgress;
                row._resumeExtract = lastExtractionProgress;
                if (row._currentRunId) row._resumeRunId = row._currentRunId;
                var limitInputs = row.querySelectorAll(
                  ".limit-sync, .limit-extract",
                );
                limitInputs.forEach(function (input) {
                  input.disabled = true;
                });
              }
              if (resetBtn) {
                resetBtn.innerHTML = ICON_RESUME + "<span>Resume</span>";
                resetBtn.classList.remove("stop-btn", "pause-btn");
                resetBtn.classList.add("resume-btn");
                resetBtn.onclick = function () {
                  runCase(caseId, btn, resultDiv, { resume: true });
                };
              }
              var resetDuringResumeBtn = row
                ? row.querySelector(".reset-during-resume")
                : null;
              if (resetDuringResumeBtn)
                resetDuringResumeBtn.classList.add("show-during-resume");
              var syncDone = row && row._resumeSync ? row._resumeSync.done : 0;
              var extDone =
                row && row._resumeExtract ? row._resumeExtract.done : 0;
              var msg =
                "Stopped. Click Resume to continue from where you left off.";
              if (syncDone > 0 || extDone > 0) {
                msg =
                  "Stopped (sync: " +
                  syncDone +
                  ", extract: " +
                  extDone +
                  "). Click Resume to continue from the next file.";
              }
              resultDiv.className = "result result-placeholder";
              resultDiv.innerHTML =
                '<span class="result-placeholder-text">' +
                escapeHtml(msg) +
                "</span>";
            }
          } else {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: e.message },
              false,
              null,
              null,
              null,
              caseId,
              null,
              null,
            );
            // Clear localStorage on error
            try {
              localStorage.removeItem("intelliextract-run-state-" + caseId);
            } catch (_) {}
          }
        } finally {
          setSystemStatus(false);
          if (row) row._activeController = null;
          if (row && row._aborted) {
            row._aborted = false;
            row.querySelectorAll("button.run").forEach(function (b) {
              b.disabled = true;
              b.title =
                "Please reset the download/extraction to start a new download/extraction";
            });
            setOtherRowsInactive(row, RESUME_OTHER_DISABLED_TITLE);
          } else {
            setOtherRowsActive();
            restoreResetBtn();
            var resetDuringResumeBtn = row
              ? row.querySelector(".reset-during-resume")
              : null;
            if (resetDuringResumeBtn)
              resetDuringResumeBtn.classList.remove("show-during-resume");
            // Clear localStorage on successful completion
            try {
              localStorage.removeItem("intelliextract-run-state-" + caseId);
            } catch (_) {}
          }
        }
      }

      var tbody = document.getElementById("rows");
      ROWS.forEach(function (c) {
        tbody.appendChild(renderRow(c, "rows"));
      });

      (function restoreAllCasesOnLoad() {
        function pollScheduledRun(caseId, row, resultDiv, resetBtn, runBtn) {
          setTimeout(function () {
            fetch("/api/active-runs")
              .then(function (r) {
                return r.json();
              })
              .then(function (data) {
                var run =
                  data.activeRuns &&
                  data.activeRuns.find(function (r) {
                    return r.caseId === caseId && r.origin === "scheduled";
                  });
                if (run) {
                  // Update progress
                  if (resultDiv) {
                    showResult(
                      resultDiv,
                      null,
                      false,
                      run.progress,
                      run.syncProgress,
                      run.extractProgress,
                      caseId,
                      null,
                      null,
                    );
                  }
                  // Schedule next poll
                  pollScheduledRun(caseId, row, resultDiv, resetBtn, runBtn);
                } else {
                  // Run finished
                  if (resetBtn) {
                    resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
                    resetBtn.classList.remove("stop-btn", "pause-btn");
                    resetBtn.disabled = false;
                    resetBtn.onclick = function () {
                      resetCase(resultDiv);
                    };
                  }
                  if (row) {
                    row.querySelectorAll("button.run").forEach(function (btn) {
                      btn.disabled = false;
                    });
                  }
                  setOtherRowsActive();
                  setSystemStatus(false);
                  if (resultDiv) {
                    resultDiv.className = "result result-placeholder";
                    resultDiv.innerHTML =
                      '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
                  }
                }
              })
              .catch(function () {
                // Retry on error
                pollScheduledRun(caseId, row, resultDiv, resetBtn, runBtn);
              });
          }, 2000);
        }
        // Step 1: Check for actively running processes
        fetch("/api/active-runs")
          .then(function (r) {
            return r.ok ? r.json() : null;
          })
          .then(function (data) {
            if (!data || !data.activeRuns || data.activeRuns.length === 0)
              return;

            setSystemStatus(true, "Operation in Progress...");
            data.activeRuns.forEach(function (run) {
              var caseRow = tbody
                ? tbody.querySelector('tr[data-case-id="' + run.caseId + '"]')
                : null;
              if (!caseRow) return;

              var runBtn = caseRow.querySelector("button.run");
              var resultDiv = document.getElementById("result-" + run.caseId);
              var resetBtn = caseRow.querySelector(
                "button.reset-case:not(.reset-during-resume)",
              );

              // Handle Scheduled Runs (Non-blocking)
              if (run.origin === "scheduled") {
                // Setup buttons for background job
                if (resetBtn) {
                  resetBtn.textContent = "Stop Auto Extraction";
                  resetBtn.classList.remove("resume-btn");
                  resetBtn.classList.add("pause-btn");
                  resetBtn.onclick = function () {
                    window.stopBackgroundJob(run.caseId);
                  };
                }
                caseRow.querySelectorAll("button.run").forEach(function (btn) {
                  btn.disabled = true;
                });
                setOtherRowsInactive(
                  caseRow,
                  "Background auto extraction is running. Pause/stop it to run another case.",
                );

                // Show initial progress and start polling
                if (resultDiv) {
                  // Initial render with data we already have
                  if (run.progress || run.syncProgress || run.extractProgress) {
                    showResult(
                      resultDiv,
                      null,
                      false,
                      run.progress,
                      run.syncProgress,
                      run.extractProgress,
                      run.caseId,
                    );
                  } else {
                    resultDiv.className = "result result-placeholder";
                    resultDiv.innerHTML =
                      '<span style="background:#e0f2f1;color:#00695c;padding:3px 10px;border-radius:14px;font-size:0.85em;font-weight:600;border:1px solid #b2dfdb;white-space:nowrap;">Initializing background run...</span>';
                  }
                }

                pollScheduledRun(
                  run.caseId,
                  caseRow,
                  resultDiv,
                  resetBtn,
                  runBtn,
                );

                return; // processing done for scheduled run
              }

              // Handle Manual Runs (Blocking - Existing Logic)
              caseRow.querySelectorAll("button.run").forEach(function (btn) {
                btn.disabled = true;
              });
              if (resetBtn) {
                resetBtn.textContent = "Pause";
                resetBtn.classList.remove("resume-btn");
                resetBtn.classList.add("pause-btn");
                // Note: We can't set onclick to actually stop since the process is in memory
                // User will need to manually refresh or the process will complete
              }

              if (resultDiv) {
                resultDiv.className = "result running";
                var msg = "Running";
                if (run.progress) {
                  msg +=
                    "â€¦ " +
                    run.progress.percent +
                    "% (" +
                    run.progress.done +
                    " / " +
                    run.progress.total +
                    ")";
                } else if (run.syncProgress) {
                  msg +=
                    "â€¦ Syncing (" +
                    run.syncProgress.done +
                    " / " +
                    run.syncProgress.total +
                    ")";
                } else if (run.extractProgress) {
                  msg +=
                    "â€¦ Extracting (" +
                    run.extractProgress.done +
                    " / " +
                    run.extractProgress.total +
                    ")";
                } else {
                  msg += "â€¦";
                }
                resultDiv.innerHTML =
                  '<span class="exit">' +
                  escapeHtml(msg) +
                  '<span class="loading-dots"></span></span>';
              }

              setOtherRowsInactive(caseRow, "A process is already running");
            });
          })
          .catch(function () {});

        // Step 2: Check for resumable stopped processes
        // Only restore the MOST RECENT one to avoid deadlock where multiple
        // Resume buttons each disable the other rows.
        var resumableCases = ["P1", "P2", "PIPE", "P5", "P6"];

        Promise.all(
          resumableCases.map(function (caseId) {
            return fetch("/api/run-status?caseId=" + caseId)
              .then(function (r) {
                return r.ok ? r.json() : null;
              })
              .then(function (status) {
                if (status && status.canResume && !status.isRunning) {
                  return { caseId: caseId, status: status };
                }
                return null;
              })
              .catch(function () {
                return null;
              });
          }),
        )
          .then(function (results) {
            var candidates = results.filter(Boolean);
            if (candidates.length === 0) return;

            // Pick the one with the latest stoppedTime
            candidates.sort(function (a, b) {
              var timeA =
                a.status.state && a.status.state.stoppedTime
                  ? new Date(a.status.state.stoppedTime).getTime()
                  : 0;
              var timeB =
                b.status.state && b.status.state.stoppedTime
                  ? new Date(b.status.state.stoppedTime).getTime()
                  : 0;
              return timeB - timeA;
            });

            var winner = candidates[0];
            var caseId = winner.caseId;
            var status = winner.status;

            var caseRow = tbody
              ? tbody.querySelector('tr[data-case-id="' + caseId + '"]')
              : null;
            if (!caseRow) return;

            var runBtn = caseRow.querySelector("button.run");
            var resultDiv = document.getElementById("result-" + caseId);
            var resetBtn = caseRow.querySelector(
              "button.reset-case:not(.reset-during-resume)",
            );

            // Set up resume state from saved state
            var savedState = status.state || {};

            if (savedState.params) {
              if (savedState.params.syncLimit != null) {
                caseRow._resumeSyncLimit = savedState.params.syncLimit;
              }
              if (savedState.params.extractLimit != null) {
                caseRow._resumeExtractLimit = savedState.params.extractLimit;
              }
            }

            if (savedState.syncProgress) {
              caseRow._resumeSync = savedState.syncProgress;
            }
            if (savedState.extractProgress) {
              caseRow._resumeExtract = savedState.extractProgress;
            }

            if (status.runId) {
              caseRow._resumeRunId = status.runId;
            }

            caseRow._aborted = true;

            // Disable limit inputs
            var limitInputs = caseRow.querySelectorAll(
              ".limit-sync, .limit-extract",
            );
            limitInputs.forEach(function (input) {
              input.disabled = true;
            });

            caseRow.querySelectorAll("button.run").forEach(function (btn) {
              btn.disabled = true;
              btn.title =
                "Please reset the download/extraction to start a new download/extraction";
            });

            if (resetBtn) {
              resetBtn.innerHTML = ICON_RESUME + "<span>Resume</span>";
              resetBtn.classList.remove("stop-btn", "pause-btn");
              resetBtn.classList.add("resume-btn");
              resetBtn.onclick = function () {
                runCase(caseId, runBtn, resultDiv, { resume: true });
              };
            }

            var resetDuringResumeBtn = caseRow.querySelector(
              ".reset-during-resume",
            );
            if (resetDuringResumeBtn) {
              resetDuringResumeBtn.classList.add("show-during-resume");
            }

            if (resultDiv) {
              resultDiv.className = "result result-placeholder";
              var msg = "Stopped";
              if (savedState.syncProgress && savedState.extractProgress) {
                msg +=
                  " (sync: " +
                  savedState.syncProgress.done +
                  ", extract: " +
                  savedState.extractProgress.done +
                  ")";
              } else if (savedState.syncProgress) {
                msg += " (sync: " + savedState.syncProgress.done + ")";
              } else if (savedState.extractProgress) {
                msg += " (extract: " + savedState.extractProgress.done + ")";
              }
              msg += ". Click Resume to continue from the next file.";
              resultDiv.innerHTML =
                '<span class="result-placeholder-text">' +
                escapeHtml(msg) +
                "</span>";
            }

            setOtherRowsInactive(
              caseRow,
              "Resume the paused/stopped process or reset it to enable other runs",
            );
          })
          .catch(function () {});
      })();
      (function initDownloadBar() {
        var container = document.getElementById("download-bar-btns");
        if (!container) return;

        const ICON_INVENTORY = `<svg style="width:14px;height:14px;margin-right:6px;vertical-align:text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8V20a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/></svg>`;
        const ICON_SUMMARY = `<svg style="width:14px;height:14px;margin-right:6px;vertical-align:text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>`;
        const ICON_DATA = `<svg style="width:14px;height:14px;margin-right:6px;vertical-align:text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`;

        function createBtn(label, className, title, onClick, iconHtml) {
          var b = document.createElement("button");
          b.className = className;
          b.innerHTML = iconHtml + "<span>" + label + "</span>";
          b.type = "button";
          b.title = title;
          b.onclick = function () {
            onClick(b);
          };
          container.appendChild(b);
        }

        createBtn(
          "View Inventory",
          "download-sync-report-btn",
          "View staging inventory report",
          function (b) {
            window.open("/api/sync-report", "_blank");
          },
          ICON_INVENTORY,
        );
        createBtn(
          "View Summary",
          "download-report-btn download-report-html-btn",
          "View latest operation summary report",
          function (b) {
            viewLatestReport("html");
          },
          ICON_SUMMARY,
        );
        createBtn(
          "Operation Data",
          "download-report-btn download-report-json-btn",
          "Explore extraction data â€” view full JSON responses",
          function (b) {
            window.open("/api/extraction-data-page", "_blank");
          },
          ICON_DATA,
        );
      })();

      function getTimestampForFilename() {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, "0");
        var day = String(now.getDate()).padStart(2, "0");
        var h = String(now.getHours()).padStart(2, "0");
        var m = String(now.getMinutes()).padStart(2, "0");
        var s = String(now.getSeconds()).padStart(2, "0");
        return year + month + day + "-" + h + m + "-" + s;
      }

      (function initActionButtons() {
        var bar = document.getElementById("download-bar");
        if (!bar) return;

        // Notification Button
        var notificationBtn = document.createElement("button");
        notificationBtn.type = "button";
        notificationBtn.id = "notification-settings-btn";
        notificationBtn.innerHTML = `<svg style="width:14px;height:14px;margin-right:6px;vertical-align:text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><span>Alert Recipients</span>`;
        notificationBtn.className = "download-report-btn";
        notificationBtn.style.marginLeft = "0.5rem";
        notificationBtn.style.width = "auto";
        notificationBtn.style.padding = "0 1rem";
        notificationBtn.style.setProperty("background", "#f1f5f9", "important");
        notificationBtn.style.setProperty(
          "color",
          "var(--text-secondary)",
          "important",
        );
        notificationBtn.style.setProperty(
          "border",
          "1px solid var(--border-light)",
          "important",
        );
        notificationBtn.title = "Configure email notifications for failures";
        bar.appendChild(notificationBtn);

        // Schedule Button
        var scheduleBtn = document.createElement("button");
        scheduleBtn.type = "button";
        scheduleBtn.innerHTML = `<svg style="width:14px;height:14px;margin-right:6px;vertical-align:text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Manage Schedules</span>`;
        scheduleBtn.className =
          "download-report-btn download-report-schedule-btn";
        scheduleBtn.style.marginLeft = "0.5rem";
        scheduleBtn.onclick = function () {
          openScheduleModal();
        };
        bar.appendChild(scheduleBtn);

        updateHeaderStatus();
        initScheduleModal();
      })();
      document
        .querySelectorAll(".limit-sync, .limit-extract")
        .forEach(function (input) {
          input.addEventListener("input", function () {
            var val = Number(this.value, 10);
            if (this.value !== "" && !Number.isNaN(val) && val < 0)
              this.value = "0";
          });
          input.addEventListener("change", function () {
            var val = Number(this.value, 10);
            if (this.value === "" || Number.isNaN(val) || val < 0)
              this.value = "0";
          });
        });

      function viewLatestReport(format) {
        fetch("/api/reports")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load report list");
            return r.json();
          })
          .then(function (list) {
            var reports = list[format] || [];
            if (reports.length === 0) {
              alert(
                "No " +
                  (format === "html" ? "summary" : "extraction") +
                  " report found. Run a case first to generate reports.",
              );
              return;
            }
            var latest = reports[0];
            var filename = latest.name;
            var url =
              "/api/reports/" + format + "/" + encodeURIComponent(filename);
            window.open(url, "_blank");
          })
          .catch(function (err) {
            alert("Failed to open report: " + err.message);
          });
      }

      function downloadSyncReport(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/sync-report")
          .then(function (r) {
            return r.blob();
          })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download =
              "Staging-Inventory-" + getTimestampForFilename() + ".html";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadExtractionsZip(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/extractions-zip")
          .then(function (r) {
            if (!r.ok)
              return r.json().then(function (err) {
                throw new Error(err.error || "Download failed");
              });
            return r.blob();
          })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Download-Data-" + getTimestampForFilename() + ".zip";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function (err) {
            if (typeof err.message === "string") alert(err.message);
          })
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadLatestReport(btn, format) {
        if (btn) btn.disabled = true;
        fetch("/api/reports")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load report list");
            return r.json();
          })
          .then(function (list) {
            var reports = list[format] || [];
            if (reports.length === 0) {
              alert(
                "No " +
                  (format === "html" ? "summary" : "extraction") +
                  " report found. Run a case first to generate reports.",
              );
              if (btn) btn.disabled = false;
              return;
            }
            var latest = reports[0];
            var filename = latest.name;
            var url =
              "/api/reports/" + format + "/" + encodeURIComponent(filename);

            fetch(url)
              .then(function (resp) {
                if (!resp.ok) throw new Error("Failed to fetch report file");
                return resp.blob();
              })
              .then(function (blob) {
                var a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                if (format === "html") {
                  a.download =
                    "Run-Summary-" + getTimestampForFilename() + ".html";
                } else {
                  a.download = filename;
                }
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                if (btn) btn.disabled = false;
              })
              .catch(function (err) {
                alert("Download failed: " + err.message);
                if (btn) btn.disabled = false;
              });
          })
          .catch(function (err) {
            alert(
              "Download failed: " +
                (err && err.message
                  ? err.message
                  : "Could not fetch report list."),
            );
          })
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      var BRAND_PURCHASERS = {};
      var ALL_PURCHASERS = [];
      var ALL_SCHEDULES = [];
      function formatBrandName(brandId) {
        if (!brandId) return "";
        if (brandId.includes("no-cow")) return "No Cow";
        if (brandId.includes("sundia")) return "Sundia";
        if (brandId.includes("tractor-beverage")) return "Tractor";
        return brandId;
      }

      function formatPurchaserName(purchaserId) {
        if (!purchaserId) return "";
        if (purchaserId.includes("8c03bc63-a173-49d2-9ef4-d3f4c540fae8"))
          return "Temp 1";
        if (purchaserId.includes("a451e439-c9d1-41c5-b107-868b65b596b8"))
          return "Temp 2";
        if (purchaserId.includes("DOT_FOODS")) return "DOT Foods";
        return purchaserId;
      }

      function renderBrandOptions() {
        var panel = document.getElementById("brand-dropdown-panel");
        if (!panel) return;
        var brands = Object.keys(BRAND_PURCHASERS).sort(function (a, b) {
          return formatBrandName(a).localeCompare(formatBrandName(b));
        });
        var allHtml =
          '<label class="filter-dropdown-option"><input type="checkbox" value="ALL"> <strong>All</strong></label>';
        panel.innerHTML =
          allHtml +
          brands
            .map(function (b) {
              return (
                '<label class="filter-dropdown-option"><input type="checkbox" value="' +
                escapeHtml(b) +
                '"> ' +
                escapeHtml(formatBrandName(b)) +
                "</label>"
              );
            })
            .join("");
        attachSelectAll("brand-dropdown-panel", function () {
          updateFilterDropdownTrigger("brand");
          clearBrandError();
          refreshPurchaserOptions();
        });
      }
      function fetchConfig() {
        return fetch("/api/config")
          .then(function (r) {
            return r.json();
          })
          .then(function (data) {
            if (data && data.brandPurchasers) {
              BRAND_PURCHASERS = data.brandPurchasers;
              var set = new Set();
              Object.values(BRAND_PURCHASERS).forEach(function (arr) {
                arr.forEach(function (p) {
                  set.add(p);
                });
              });
              ALL_PURCHASERS = Array.from(set).sort(function (a, b) {
                var nameA = formatPurchaserName(a).toLowerCase();
                var nameB = formatPurchaserName(b).toLowerCase();
                var isTempA = nameA.startsWith("temp");
                var isTempB = nameB.startsWith("temp");
                if (isTempA && !isTempB) return 1;
                if (!isTempA && isTempB) return -1;
                return nameA.localeCompare(nameB);
              });
              renderBrandOptions();
              refreshPurchaserOptions();
            }
          })
          .catch(function (err) {
            console.error("Failed to load config:", err);
          });
      }
      function refreshPurchaserOptions() {
        var panel = document.getElementById("purchaser-dropdown-panel");
        var trigger = document.getElementById("purchaser-dropdown-trigger");
        if (!panel || !trigger) return;
        var brands = getSelectedBrands();
        var opts =
          brands.length === 0
            ? ALL_PURCHASERS
            : (function () {
                var set = new Set();
                brands.forEach(function (b) {
                  (BRAND_PURCHASERS[b] || []).forEach(function (p) {
                    set.add(p);
                  });
                });
                return Array.from(set).sort();
              })();
        opts.sort(function (a, b) {
          var nameA = formatPurchaserName(a).toLowerCase();
          var nameB = formatPurchaserName(b).toLowerCase();
          var isTempA = nameA.startsWith("temp");
          var isTempB = nameB.startsWith("temp");
          if (isTempA && !isTempB) return 1;
          if (!isTempA && isTempB) return -1;
          return nameA.localeCompare(nameB);
        });
        var currentChecked = getSelectedPurchasers();
        var allChecked =
          opts.length > 0 &&
          opts.every(function (p) {
            return currentChecked.indexOf(p) !== -1;
          });
        var allHtml =
          '<label class="filter-dropdown-option"><input type="checkbox" value="ALL"' +
          (allChecked ? " checked" : "") +
          "> <strong>All</strong></label>";
        panel.innerHTML =
          allHtml +
          opts
            .map(function (p) {
              var checked = currentChecked.indexOf(p) !== -1 ? " checked" : "";
              return (
                '<label class="filter-dropdown-option"><input type="checkbox" value="' +
                p +
                '"' +
                checked +
                "> " +
                escapeHtml(formatPurchaserName(p)) +
                "</label>"
              );
            })
            .join("");
        attachSelectAll("purchaser-dropdown-panel", function () {
          updateFilterDropdownTrigger("purchaser");
        });
        updateFilterDropdownTrigger("purchaser");
      }

      function initScheduleModal() {
        var overlay = document.getElementById("schedule-modal-overlay");
        var body = document.getElementById("schedule-modal-body");
        var closeIcon = document.getElementById("schedule-modal-close-icon");
        if (!overlay || !body) return;
        function close() {
          if (overlay.classList.contains("closing")) return;
          overlay.classList.add("closing");
          overlay.setAttribute("aria-hidden", "true");
          // Wait for animation to finish (duration is 0.25s)
          setTimeout(function () {
            overlay.classList.remove("open");
            overlay.classList.remove("closing");
          }, 250);
        }
        window.closeScheduleModal = close;
        if (closeIcon) closeIcon.onclick = close;
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay) close();
        });
      }

      function openScheduleModal() {
        var overlay = document.getElementById("schedule-modal-overlay");
        var body = document.getElementById("schedule-modal-body");
        if (!overlay || !body) return;
        overlay.classList.remove("closing");
        overlay.classList.add("open");
        overlay.setAttribute("aria-hidden", "false");
        loadSchedulesIntoModal();
      }

      function getOrdinalSuffix(day) {
        if (day > 3 && day < 21) return "th";
        switch (day % 10) {
          case 1:
            return "st";
          case 2:
            return "nd";
          case 3:
            return "rd";
          default:
            return "th";
        }
      }

      function renderWithTransition(body, html, direction) {
        if (!body) return;
        var dirClass = direction === "left" ? "slide-left" : "slide-right";
        body.innerHTML =
          '<div class="modal-screen-animate ' +
          dirClass +
          '">' +
          html +
          "</div>";
      }

      function updateModalTitle(text) {
        var el = document.getElementById("modal-title-text");
        if (el) el.textContent = text;
      }

      function formatDateWithSuffix(dateStr) {
        if (!dateStr) return "";
        var date = new Date(dateStr);
        var day = date.getDate();
        var month = date.toLocaleString("default", { month: "short" });
        var year = date.getFullYear();
        var h = date.getHours();
        var m = date.getMinutes();
        var ampm = h >= 12 ? "PM" : "AM";
        var hh = h % 12;
        hh = hh ? hh : 12; // the hour '0' should be '12'
        var mm = m < 10 ? "0" + m : m;
        return (
          day +
          getOrdinalSuffix(day) +
          " " +
          month +
          " " +
          year +
          ", " +
          hh +
          ":" +
          mm +
          " " +
          ampm
        );
      }

      function formatCronWithTime(cron) {
        if (!cron) return "";
        var parts = cron.trim().split(" ");
        if (parts.length >= 2) {
          var m = parseInt(parts[0], 10);
          var h = parseInt(parts[1], 10);
          if (!isNaN(m) && !isNaN(h)) {
            var displayHour = ((h + 11) % 12) + 1;
            var ampm = h < 12 ? "AM" : "PM";
            var minLabel = String(m).padStart(2, "0");
            return (
              cron + " (" + displayHour + ":" + minLabel + " " + ampm + ")"
            );
          }
        }
        return cron;
      }

      function renderPagination(container, total, page, limit, onPageClick) {
        if (!container) return;
        var totalPages = Math.ceil(total / limit);
        if (totalPages <= 1) {
          container.innerHTML = "";
          return;
        }
        var html = "";
        html +=
          '<button class="pagination-btn" ' +
          (page === 1 ? "disabled" : "") +
          ' data-page="' +
          (page - 1) +
          '">' +
          ICON_CHEVRON_LEFT +
          " Previous</button>";

        var start = Math.max(1, page - 2);
        var end = Math.min(totalPages, page + 2);

        if (start > 1)
          html +=
            '<button class="pagination-btn" data-page="1">1</button><span>...</span>';
        for (var i = start; i <= end; i++) {
          html +=
            '<button class="pagination-btn ' +
            (i === page ? "active" : "") +
            '" data-page="' +
            i +
            '">' +
            i +
            "</button>";
        }
        if (end < totalPages)
          html +=
            '<span>...</span><button class="pagination-btn" data-page="' +
            totalPages +
            '">' +
            totalPages +
            "</button>";

        html +=
          '<button class="pagination-btn" ' +
          (page === totalPages ? "disabled" : "") +
          ' data-page="' +
          (page + 1) +
          '">Next ' +
          ICON_CHEVRON_RIGHT +
          "</button>";
        container.innerHTML = html;
        container.querySelectorAll(".pagination-btn").forEach(function (btn) {
          btn.onclick = function () {
            var p = parseInt(this.getAttribute("data-page"), 10);
            if (!isNaN(p)) onPageClick(p);
          };
        });
      }

      function openExtractionDataModal() {
        var overlay = document.getElementById("extraction-data-modal-overlay");
        if (!overlay) return;
        overlay.classList.add("open");
        overlay.setAttribute("aria-hidden", "false");

        var closeIcon = document.getElementById(
          "extraction-data-modal-close-icon",
        );
        if (closeIcon)
          closeIcon.onclick = function () {
            overlay.classList.remove("open");
            overlay.setAttribute("aria-hidden", "true");
          };

        var currentTab = "all";
        var currentSearch = "";
        var currentPage = 1;

        function refresh() {
          fetchExtractionStats();
          fetchExtractionResults(currentPage, currentTab, currentSearch);
        }

        document
          .querySelectorAll("#extraction-data-modal-overlay .modal-tab-btn")
          .forEach(function (btn) {
            btn.onclick = function () {
              document
                .querySelectorAll(
                  "#extraction-data-modal-overlay .modal-tab-btn",
                )
                .forEach((b) => b.classList.remove("active"));
              this.classList.add("active");
              currentTab = this.getAttribute("data-tab");
              currentPage = 1;
              refresh();
            };
          });

        var searchInput = document.getElementById("extraction-search");
        if (searchInput) {
          var timer;
          searchInput.oninput = function () {
            clearTimeout(timer);
            timer = setTimeout(function () {
              currentSearch = searchInput.value;
              currentPage = 1;
              refresh();
            }, 300);
          };
        }

        refresh();
      }

      function fetchExtractionStats() {
        fetch("/api/extraction-stats")
          .then((r) => r.json())
          .then((data) => {
            var container = document.getElementById("extraction-stats");
            if (!container) return;
            container.innerHTML = `
              <div class="stat-card">
                <div class="stat-label">Total Extractions</div>
                <div class="stat-value">${data.success + data.failed}</div>
              </div>
              <div class="stat-card success-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value">${Math.round((data.success / (data.success + data.failed || 1)) * 100)}%</div>
              </div>
              <div class="stat-card failed-card">
                <div class="stat-label">Critical Issues</div>
                <div class="stat-value">${data.failed}</div>
              </div>
            `;
          });
      }

      function fetchExtractionResults(page, status, search) {
        var container = document.getElementById("extraction-table-container");
        if (container)
          container.innerHTML =
            '<div class="schedule-empty">Loading dynamic results...</div>';

        var url = `/api/extraction-results?page=${page || 1}&status=${status || "all"}&search=${encodeURIComponent(search || "")}`;
        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            renderExtractionResultsTable(data.results);
            renderPagination(
              document.getElementById("extraction-pagination"),
              data.total,
              data.page,
              data.limit,
              function (p) {
                fetchExtractionResults(p, status, search);
              },
            );
          });
      }

      function renderExtractionResultsTable(results) {
        var container = document.getElementById("extraction-table-container");
        if (!container) return;
        if (!results || results.length === 0) {
          container.innerHTML =
            '<div class="schedule-empty">No results found for this selection.</div>';
          return;
        }
        var html =
          '<table class="schedule-list data-table"><thead><tr><th style="width:180px">Timestamp</th><th>Filename</th><th>Pattern</th><th>Purchaser</th><th style="width:100px;text-align:center">Status</th></tr></thead><tbody style="font-family:inherit">';
        results.forEach(function (r) {
          var badge =
            r.status === "success"
              ? '<span class="badge badge-success">Success</span>'
              : '<span class="badge badge-failed">Failed</span>';
          var time = r.timestamp ? new Date(r.timestamp).toLocaleString() : "â€”";
          html += `<tr class="row-${r.status}">
            <td style="white-space:nowrap; font-size: 0.75rem">${escapeHtml(time)}</td>
            <td style="font-size:0.75rem; color:var(--text); word-break: break-all">${escapeHtml(r.filename)}</td>
            <td><code style="background:var(--bg); padding:2px 4px; border-radius:3px; font-size:0.7rem">${escapeHtml(r.patternKey || "â€”")}</code></td>
            <td style="font-size: 0.75rem">${escapeHtml(formatPurchaserName(r.purchaserKey) || "â€”")}</td>
            <td style="text-align:center">${badge}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function renderScheduleListView(state, direction) {
        updateModalTitle("Operation Dashboard");
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;
        var schedules =
          state && Array.isArray(state.schedules) ? state.schedules : [];
        var tz = state && Array.isArray(state.timezones) ? state.timezones : [];
        var html =
          '<div class="schedule-header-row"><div class="subtitle-chip">Configure automated periodic operations</div><div style="display:flex;gap:0.51rem;flex-wrap:wrap;"><button type="button" id="schedule-history-btn" class="btn-secondary">' +
          ICON_HISTORY +
          '<span>History</span></button><button type="button" id="schedule-create-btn" class="download-report-btn download-report-schedule-btn">' +
          ICON_PLUS +
          '<span>Create Operation</span></button></div></div><div style="flex:1;display:flex;flex-direction:column;min-height:0;">';
        if (!schedules.length) {
          html +=
            '<div class="schedule-empty">No active schedules. Start by creating an operation.</div>';
        } else {
          html +=
            '<div style="flex:1;overflow-y:auto;padding-right:4px;"><table class="schedule-list"><thead><tr><th>Brand Scope</th><th>Purchaser Scope</th><th>Operation Time</th><th>Timezone</th><th>Created</th><th style="text-align:right">Actions</th></tr></thead><tbody>';
          schedules.forEach(function (s) {
            var brands =
              s.brands && s.brands.length
                ? s.brands.map(formatBrandName).join(", ")
                : "All Brands";
            var purchasers =
              s.purchasers && s.purchasers.length
                ? s.purchasers.map(formatPurchaserName).join(", ")
                : "All Purchasers";
            html +=
              "<tr data-sched-id='" +
              escapeHtml(s.id || "") +
              "'><td><strong>" +
              escapeHtml(brands) +
              "</strong></td><td>" +
              escapeHtml(purchasers) +
              "</td><td><span class='cron-tag'>" +
              escapeHtml(formatCronWithTime(s.cron)) +
              "</span></td><td>" +
              escapeHtml(s.timezone) +
              "</td><td>" +
              escapeHtml(formatDateWithSuffix(s.createdAt || "")) +
              '</td><td style="text-align:right"><div style="display:flex;justify-content:flex-end;gap:0.4rem;">' +
              '<button type="button" class="btn-secondary" data-sched-edit style="padding:0.4rem 0.6rem">' +
              ICON_EDIT +
              "</button>" +
              '<button type="button" class="btn-secondary" data-sched-delete style="padding:0.4rem 0.6rem;color:var(--fail)">' +
              ICON_DELETE +
              "</button>" +
              "</div></td></tr>";
          });
          html += "</tbody></table></div>";
        }
        html += "</div>";
        html +=
          '<div class="modal-footer"><button type="button" class="btn-secondary" onclick="window.closeScheduleModal()">Close window</button></div>';
        renderWithTransition(body, html, direction);
        var createBtn = document.getElementById("schedule-create-btn");
        if (createBtn) {
          createBtn.onclick = function () {
            renderScheduleCreateForm(tz, null, "right");
          };
        }
        var historyBtn = document.getElementById("schedule-history-btn");
        if (historyBtn) {
          historyBtn.onclick = function () {
            renderScheduleRunHistoryView("right");
          };
        }

        body.querySelectorAll("[data-sched-edit]").forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tr = btn.closest("tr");
            var id = tr && tr.getAttribute("data-sched-id");
            if (!id) return;
            var sched = schedules.find(function (s) {
              return s.id === id;
            });
            if (!sched) return;
            renderScheduleCreateForm(tz, sched, "right");
          });
        });
        body.querySelectorAll("[data-sched-delete]").forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tr = btn.closest("tr");
            var id = tr && tr.getAttribute("data-sched-id");
            if (!id) return;
            if (!window.confirm("Delete this schedule? This cannot be undone."))
              return;
            deleteSchedule(id);
          });
        });
      }

      function getSelectedScheduleBrands() {
        var panel = document.getElementById("sched-brand-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll(
            "input[type=checkbox]:checked:not([value='ALL'])",
          ),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function getSelectedSchedulePurchasers() {
        var panel = document.getElementById("sched-purchaser-dropdown-panel");
        if (!panel) return [];
        return Array.from(
          panel.querySelectorAll(
            "input[type=checkbox]:checked:not([value='ALL'])",
          ),
        ).map(function (cb) {
          return cb.value;
        });
      }
      function updateScheduleDropdownTrigger(type) {
        var trigger = document.getElementById(
          type === "brand"
            ? "sched-brand-dropdown-trigger"
            : "sched-purchaser-dropdown-trigger",
        );
        var panel = document.getElementById(
          type === "brand"
            ? "sched-brand-dropdown-panel"
            : "sched-purchaser-dropdown-panel",
        );
        var total = panel
          ? panel.querySelectorAll("input[type=checkbox]:not([value='ALL'])")
              .length
          : 0;

        if (panel) {
          var allCb = panel.querySelector('input[value="ALL"]');
          if (allCb) {
            var otherCbs = Array.from(
              panel.querySelectorAll('input[type=checkbox]:not([value="ALL"])'),
            );
            allCb.checked =
              otherCbs.length > 0 &&
              otherCbs.every(function (c) {
                return c.checked;
              });
          }
        }

        if (!trigger) return;
        var selected =
          type === "brand"
            ? getSelectedScheduleBrands()
            : getSelectedSchedulePurchasers();
        if (selected.length === 0) {
          trigger.textContent =
            type === "brand" ? "Select brand" : "Select purchaser";
        } else if (selected.length === 1) {
          trigger.textContent =
            type === "brand"
              ? formatBrandName(selected[0])
              : formatPurchaserName(selected[0]);
        } else {
          if (total > 0 && selected.length === total) {
            trigger.textContent = "All";
          } else {
            trigger.textContent = selected.length + " selected";
          }
        }
      }
      function refreshSchedulePurchaserOptions() {
        var panel = document.getElementById("sched-purchaser-dropdown-panel");
        var trigger = document.getElementById(
          "sched-purchaser-dropdown-trigger",
        );
        if (!panel || !trigger) return;
        var brands = getSelectedScheduleBrands();
        var opts =
          brands.length === 0
            ? ALL_PURCHASERS
            : (function () {
                var set = new Set();
                brands.forEach(function (b) {
                  (BRAND_PURCHASERS[b] || []).forEach(function (p) {
                    set.add(p);
                  });
                });
                return Array.from(set).sort(function (a, b) {
                  var nameA = formatPurchaserName(a).toLowerCase();
                  var nameB = formatPurchaserName(b).toLowerCase();
                  var isTempA = nameA.startsWith("temp");
                  var isTempB = nameB.startsWith("temp");
                  if (isTempA && !isTempB) return 1;
                  if (!isTempA && isTempB) return -1;
                  return nameA.localeCompare(nameB);
                });
              })();
        var currentChecked = getSelectedSchedulePurchasers();
        var allChecked =
          opts.length > 0 &&
          opts.every(function (p) {
            return currentChecked.indexOf(p) !== -1;
          });
        var allHtml =
          '<label class="filter-dropdown-option"><input type="checkbox" value="ALL"' +
          (allChecked ? " checked" : "") +
          "> <strong>All</strong></label>";
        panel.innerHTML =
          allHtml +
          opts
            .map(function (p) {
              var checked = currentChecked.indexOf(p) !== -1 ? " checked" : "";
              return (
                '<label class="filter-dropdown-option"><input type="checkbox" value="' +
                escapeHtml(p) +
                '"' +
                checked +
                "> " +
                escapeHtml(formatPurchaserName(p)) +
                "</label>"
              );
            })
            .join("");
        attachSelectAll("sched-purchaser-dropdown-panel", function () {
          updateScheduleDropdownTrigger("purchaser");
        });
        updateScheduleDropdownTrigger("purchaser");
      }
      function renderScheduleCreateForm(timezones, schedule, direction) {
        updateModalTitle(
          "Dashboard / " + (schedule ? "Edit Operation" : "New Operation"),
        );
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;
        var brands = Object.keys(BRAND_PURCHASERS || {}).sort(function (a, b) {
          var la = formatBrandName(a).toLowerCase();
          var lb = formatBrandName(b).toLowerCase();
          return la < lb ? -1 : la > lb ? 1 : 0;
        });
        var tz =
          Array.isArray(timezones) && timezones.length ? timezones : ["UTC"];
        var brandOptions =
          '<label class="filter-dropdown-option"><input type="checkbox" value="ALL"> <strong>All</strong></label>' +
          brands
            .map(function (b) {
              return (
                '<label class="filter-dropdown-option"><input type="checkbox" value="' +
                escapeHtml(b) +
                '"> ' +
                escapeHtml(formatBrandName(b)) +
                "</label>"
              );
            })
            .join("");
        var cronOptions = "";
        for (var h = 0; h < 24; h++) {
          for (var m = 0; m < 60; m += 5) {
            var displayHour = ((h + 11) % 12) + 1; // 0 -> 12, 13 -> 1
            var ampm = h < 12 ? "AM" : "PM";
            var minLabel = String(m).padStart(2, "0");
            var label = displayHour + ":" + minLabel + " " + ampm;
            var cronVal = String(m) + " " + String(h) + " * * *";
            cronOptions +=
              '<div class="filter-dropdown-option single-select" data-value="' +
              cronVal +
              '">' +
              escapeHtml(label) +
              "</div>";
          }
        }
        var tzOptions = tz
          .map(function (z) {
            return (
              '<div class="filter-dropdown-option single-select" data-value="' +
              escapeHtml(z) +
              '">' +
              escapeHtml(z) +
              "</div>"
            );
          })
          .join("");
        renderWithTransition(
          body,
          '<div class="schedule-header-row"><div style="display:flex;align-items:center;gap:0.75rem;"><button type="button" id="schedule-form-back-btn" class="btn-secondary" style="padding: 0.4rem 0.6rem">' +
            ICON_BACK +
            '</button><div class="subtitle-chip">' +
            (schedule
              ? "Edit operation parameters"
              : "Launch a new operation schedule") +
            "</div></div></div>" +
            '<div style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:visible;padding-right:4px;">' +
            '<div class="schedule-form-grid">' +
            '<div class="schedule-field"><label class="schedule-label" for="sched-brand-dropdown-trigger">Brand (optional)</label><div id="sched-brand-dropdown" class="filter-dropdown"><button type="button" id="sched-brand-dropdown-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false" title="Select one or more brands">Select brand</button><div id="sched-brand-dropdown-panel" class="filter-dropdown-panel" role="listbox">' +
            brandOptions +
            '</div></div><div class="schedule-hint">Leave empty to include all brands.</div></div>' +
            '<div class="schedule-field"><label class="schedule-label" for="sched-purchaser-dropdown-trigger">Purchaser (optional)</label><div id="sched-purchaser-dropdown" class="filter-dropdown"><button type="button" id="sched-purchaser-dropdown-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false" title="Select one or more purchasers">Select purchaser</button><div id="sched-purchaser-dropdown-panel" class="filter-dropdown-panel" role="listbox"></div></div><div class="schedule-hint">Leave empty to include all purchasers. Options update based on selected brands.</div></div>' +
            '<div class="schedule-field"><label class="schedule-label" for="sched-cron-trigger">Run time (daily)</label><div id="sched-cron-dropdown" class="filter-dropdown"><input type="hidden" id="sched-cron"><button type="button" id="sched-cron-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false">Select time</button><div id="sched-cron-panel" class="filter-dropdown-panel" role="listbox">' +
            cronOptions +
            '</div></div><div class="schedule-hint">Runs once per day at the selected time.</div></div>' +
            '<div class="schedule-field"><label class="schedule-label" for="sched-tz-trigger">Timezone</label><div id="sched-tz-dropdown" class="filter-dropdown"><input type="hidden" id="sched-tz"><button type="button" id="sched-tz-trigger" class="filter-dropdown-trigger" aria-haspopup="listbox" aria-expanded="false">Select timezone</button><div id="sched-tz-panel" class="filter-dropdown-panel" role="listbox">' +
            tzOptions +
            '</div></div><div class="schedule-hint">All runs use this timezone for the schedule.</div></div>' +
            "</div>" +
            '<div id="schedule-error" class="schedule-error"></div>' +
            "</div>" +
            '<div class="schedule-note-card">' +
            "<strong>âš  Important Information:</strong> Ensure no other extraction operations are scheduled or active at this time. Manual processes or <strong>paused (Resume)</strong> states will cause this operation to be skipped to prevent data conflicts." +
            "</div>" +
            '<div class="modal-footer" style="border-top: none; padding-top: 0.5rem;"><button type="button" id="schedule-cancel-btn" class="btn-secondary">Discard</button><button type="button" id="schedule-save-btn" class="download-report-btn download-report-schedule-btn">' +
            "<span>" +
            (schedule ? "Update Changes" : "Launch Operation") +
            "</span>" +
            "</button></div>",
          direction || "right",
        );

        function updateDisabledCronOptions() {
          var cronPanel = document.getElementById("sched-cron-panel");
          var tzInput = document.getElementById("sched-tz");
          if (!cronPanel || !tzInput) return;
          var selectedTz = tzInput.value;
          var options = cronPanel.querySelectorAll(".filter-dropdown-option");
          options.forEach(function (opt) {
            var cronVal = opt.getAttribute("data-value");
            var inUse = ALL_SCHEDULES.some(function (s) {
              return (
                s.cron === cronVal &&
                s.timezone === selectedTz &&
                (!schedule || s.id !== schedule.id)
              );
            });
            if (inUse) {
              opt.classList.add("disabled");
              if (opt.textContent.indexOf(" (In Use)") === -1) {
                opt.textContent += " (In Use)";
              }
            } else {
              opt.classList.remove("disabled");
              opt.textContent = opt.textContent.replace(" (In Use)", "");
            }
          });
        }

        var tzEl = document.getElementById("sched-tz");
        if (tzEl) {
          tzEl.addEventListener("change", updateDisabledCronOptions);
        }
        updateDisabledCronOptions();

        refreshSchedulePurchaserOptions();
        var brandTrigger = document.getElementById(
          "sched-brand-dropdown-trigger",
        );
        var brandPanel = document.getElementById("sched-brand-dropdown-panel");
        var brandDropdown = document.getElementById("sched-brand-dropdown");
        var purchaserTrigger = document.getElementById(
          "sched-purchaser-dropdown-trigger",
        );
        var purchaserPanel = document.getElementById(
          "sched-purchaser-dropdown-panel",
        );
        var purchaserDropdown = document.getElementById(
          "sched-purchaser-dropdown",
        );
        var cronTrigger = document.getElementById("sched-cron-trigger");
        var cronPanel = document.getElementById("sched-cron-panel");
        var tzTrigger = document.getElementById("sched-tz-trigger");
        var tzPanel = document.getElementById("sched-tz-panel");

        function closeScheduleDropdowns() {
          if (brandPanel) brandPanel.classList.remove("open");
          if (purchaserPanel) purchaserPanel.classList.remove("open");
          if (cronPanel) cronPanel.classList.remove("open");
          if (tzPanel) tzPanel.classList.remove("open");
          if (brandTrigger) brandTrigger.setAttribute("aria-expanded", "false");
          if (purchaserTrigger)
            purchaserTrigger.setAttribute("aria-expanded", "false");
          if (cronTrigger) cronTrigger.setAttribute("aria-expanded", "false");
          if (tzTrigger) tzTrigger.setAttribute("aria-expanded", "false");
        }
        function toggleScheduleDropdown(panel, trigger) {
          var isOpen = panel && panel.classList.contains("open");
          closeScheduleDropdowns();
          if (!isOpen && panel && trigger) {
            panel.classList.add("open");
            trigger.setAttribute("aria-expanded", "true");
          }
        }
        if (brandTrigger && brandPanel) {
          brandTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(brandPanel, brandTrigger);
          });
        }
        if (cronTrigger && cronPanel) {
          cronTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(cronPanel, cronTrigger);
          });
        }
        if (tzTrigger && tzPanel) {
          tzTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(tzPanel, tzTrigger);
          });
        }

        function initSingleSelectDropdown(panel, trigger, inputId, onSelect) {
          if (!panel || !trigger) return;
          var input = document.getElementById(inputId);
          panel
            .querySelectorAll(".filter-dropdown-option")
            .forEach(function (opt) {
              opt.onclick = function (e) {
                e.stopPropagation();
                if (opt.classList.contains("disabled")) return;
                var val = opt.getAttribute("data-value");
                if (input) input.value = val;
                trigger.textContent = opt.textContent.replace(" (In Use)", "");
                panel.classList.remove("open");
                trigger.setAttribute("aria-expanded", "false");
                if (onSelect) onSelect(val);
              };
            });
        }

        initSingleSelectDropdown(cronPanel, cronTrigger, "sched-cron");
        initSingleSelectDropdown(tzPanel, tzTrigger, "sched-tz", function () {
          updateDisabledCronOptions();
        });

        if (purchaserTrigger && purchaserPanel) {
          purchaserTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleScheduleDropdown(purchaserPanel, purchaserTrigger);
          });
        }
        if (brandDropdown) {
          brandDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
        if (purchaserDropdown) {
          purchaserDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
        document.addEventListener("click", function () {
          closeScheduleDropdowns();
        });
        attachSelectAll("sched-brand-dropdown-panel", function () {
          updateScheduleDropdownTrigger("brand");
          refreshSchedulePurchaserOptions();
        });
        var backBtnHeader = document.getElementById("schedule-form-back-btn");
        if (backBtnHeader) {
          backBtnHeader.onclick = function () {
            loadSchedulesIntoModal("left");
          };
        }
        var cancelBtn = document.getElementById("schedule-cancel-btn");
        if (cancelBtn) {
          cancelBtn.onclick = function () {
            loadSchedulesIntoModal("left");
          };
        }
        var saveBtn = document.getElementById("schedule-save-btn");
        if (saveBtn) {
          saveBtn.onclick = function () {
            submitScheduleForm(schedule);
          };
        }
        if (schedule) {
          var cronInput = document.getElementById("sched-cron");
          var tzInput = document.getElementById("sched-tz");
          if (schedule.brands && schedule.brands.length) {
            schedule.brands.forEach(function (b) {
              var cb = brandPanel.querySelector(
                'input[type=checkbox][value="' + escapeHtml(b) + '"]',
              );
              if (cb) cb.checked = true;
            });
            updateScheduleDropdownTrigger("brand");
            refreshSchedulePurchaserOptions();
          }
          if (schedule.purchasers && schedule.purchasers.length) {
            schedule.purchasers.forEach(function (p) {
              var cb = purchaserPanel.querySelector(
                'input[type=checkbox][value="' + escapeHtml(p) + '"]',
              );
              if (cb) cb.checked = true;
            });
            updateScheduleDropdownTrigger("purchaser");
          }
          if (cronInput && schedule.cron) {
            cronInput.value = schedule.cron;
            var cronOpt = cronPanel.querySelector(
              '.filter-dropdown-option[data-value="' + schedule.cron + '"]',
            );
            if (cronOpt && cronTrigger)
              cronTrigger.textContent = cronOpt.textContent.replace(
                " (In Use)",
                "",
              );
          }
          if (tzInput && schedule.timezone) {
            tzInput.value = schedule.timezone;
            var tzOpt = tzPanel.querySelector(
              '.filter-dropdown-option[data-value="' + schedule.timezone + '"]',
            );
            if (tzOpt && tzTrigger) tzTrigger.textContent = tzOpt.textContent;
          }
        }
      }

      function loadSchedulesIntoModal(direction) {
        fetch("/api/schedules")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load schedules");
            return r.json();
          })
          .then(function (data) {
            ALL_SCHEDULES = data.schedules || [];
            ALL_SCHEDULES.sort(function (a, b) {
              return new Date(b.createdAt) - new Date(a.createdAt);
            });
            renderScheduleListView(
              {
                schedules: ALL_SCHEDULES,
                timezones: data.timezones || [],
              },
              direction,
            );
          })
          .catch(function () {
            renderScheduleListView(
              { schedules: [], timezones: ["UTC"] },
              direction,
            );
          });
      }

      function renderScheduleRunHistoryView(direction, page) {
        page = page || 1;
        updateModalTitle("Dashboard / Execution Logs");
        var body = document.getElementById("schedule-modal-body");
        if (!body) return;

        // Initial loading state
        if (page === 1) {
          renderWithTransition(
            body,
            '<div class="schedule-header-row"><div style="display:flex;align-items:center;gap:0.75rem;"><button type="button" id="schedule-log-back-btn" class="btn-secondary" style="padding: 0.4rem 0.6rem">' +
              ICON_BACK +
              '</button><div class="subtitle-chip">Schedule execution logs</div></div></div><div class="schedule-empty">Loading history logsâ€¦</div><div class="modal-footer" style="margin-top:0.85rem; border-top:none;"><button type="button" class="btn-secondary" onclick="window.closeScheduleModal()">Cancel</button></div>',
            direction || "right",
          );
          var backBtn = document.getElementById("schedule-log-back-btn");
          if (backBtn) {
            backBtn.onclick = function () {
              loadSchedulesIntoModal("left");
            };
          }
        }

        fetch("/api/schedule-log?page=" + page + "&limit=15")
          .then(function (r) {
            if (!r.ok) throw new Error("Could not load schedule log");
            return r.json();
          })
          .then(function (data) {
            var entries = data.entries || [];
            var html =
              '<div class="schedule-header-row"><div style="display:flex;align-items:center;gap:0.75rem;"><button type="button" id="schedule-log-back-btn" class="btn-secondary" style="padding: 0.4rem 0.6rem">' +
              ICON_BACK +
              '</button><div class="subtitle-chip">Schedule execution logs</div></div></div><div style="flex:1;display:flex;flex-direction:column;overflow-y:auto;padding-right:4px;">';
            if (!entries.length) {
              html +=
                '<div class="schedule-empty">No execution history found yet. Logs for operations will appear here.</div>';
            } else {
              html +=
                '<table class="schedule-list"><thead><tr><th>Time</th><th>Schedule ID</th><th>Outcome</th><th>Message</th></tr></thead><tbody>';
              entries.forEach(function (e) {
                var time = e.timestamp
                  ? new Date(e.timestamp).toLocaleString()
                  : "";
                var schedId =
                  e.scheduleId != null ? String(e.scheduleId).slice(0, 20) : "";
                var outcome = (e.outcome || "executed").toLowerCase();
                var outcomeLabel =
                  outcome === "skipped" ? "Skipped" : "Executed";
                var outcomeClass =
                  outcome === "skipped"
                    ? "schedule-outcome-skipped"
                    : "schedule-outcome-executed";
                var msg = e.message || "";
                if (outcome === "executed") {
                  if (e.exitCode === 0) {
                    msg = "Operation completed successfully";
                  } else if (e.exitCode != null) {
                    msg = "Operation completed with issues";
                  }
                }
                if (e.error) {
                  msg += (msg ? " â€” " : "") + e.error;
                }
                html +=
                  "<tr><td>" +
                  escapeHtml(time) +
                  "</td><td>" +
                  escapeHtml(schedId) +
                  '</td><td><span class="' +
                  outcomeClass +
                  '">' +
                  escapeHtml(outcomeLabel) +
                  "</span></td><td>" +
                  escapeHtml(msg) +
                  "</td></tr>";
              });
              html += "</tbody></table>";
              html +=
                '<div id="schedule-log-pagination" class="pagination-wrap"></div>';
            }
            html += "</div>";
            html +=
              '<div class="modal-footer" style="margin-top:0.85rem; border-top:none;"><button type="button" class="btn-secondary" onclick="window.closeScheduleModal()">Cancel</button></div>';

            // For page > 1, don't use transition to make it feel local
            if (page === 1) {
              renderWithTransition(body, html, direction || "right");
            } else {
              body.innerHTML = html;
            }

            renderPagination(
              document.getElementById("schedule-log-pagination"),
              data.total,
              data.page,
              data.limit,
              function (p) {
                renderScheduleRunHistoryView(null, p);
              },
            );

            backBtn = document.getElementById("schedule-log-back-btn");
            if (backBtn) {
              backBtn.onclick = function () {
                loadSchedulesIntoModal("left");
              };
            }
          })
          .catch(function () {
            // ... error handling
          });
      }

      function deleteSchedule(id) {
        fetch("/api/schedules/" + encodeURIComponent(id), {
          method: "DELETE",
        })
          .then(function (r) {
            if (!r.ok) {
              throw new Error("Failed to delete schedule");
            }
            loadSchedulesIntoModal("left");
          })
          .catch(function () {
            // Best effort; keep current view if delete fails.
          });
      }

      function submitScheduleForm(schedule) {
        var cronEl = document.getElementById("sched-cron");
        var tzEl = document.getElementById("sched-tz");
        var errorEl = document.getElementById("schedule-error");
        if (!cronEl || !tzEl || !errorEl) return;
        var brands = getSelectedScheduleBrands();
        var purchasers = getSelectedSchedulePurchasers();
        var cron = (cronEl.value || "").trim();
        var timezone = (tzEl.value || "").trim();
        errorEl.textContent = "";
        if (brands.length === 0 && purchasers.length === 0) {
          errorEl.textContent =
            "Please select at least one brand or purchaser.";
          return;
        }
        if (!cron) {
          errorEl.textContent = "Run time is required.";
          return;
        }
        if (!timezone) {
          errorEl.textContent = "Timezone is required.";
          return;
        }
        // Final duplicate check
        var isDuplicate = ALL_SCHEDULES.some(function (s) {
          return (
            s.cron === cron &&
            s.timezone === timezone &&
            (!schedule || s.id !== schedule.id)
          );
        });
        if (isDuplicate) {
          errorEl.textContent =
            "A schedule for this time and timezone already exists.";
          return;
        }
        var url = "/api/schedules";
        var method = "POST";
        if (schedule && schedule.id) {
          url = "/api/schedules/" + encodeURIComponent(schedule.id);
          method = "PUT";
        }
        fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            brands: brands,
            purchasers: purchasers,
            cron: cron,
            timezone: timezone,
          }),
        })
          .then(function (r) {
            if (!r.ok) {
              return r.json().then(function (err) {
                throw new Error(
                  err && err.error ? err.error : "Failed to save schedule",
                );
              });
            }
            return r.json();
          })
          .then(function () {
            loadSchedulesIntoModal("left");
          })
          .catch(function (e) {
            errorEl.textContent =
              e && e.message ? e.message : "Failed to save schedule.";
          });
      }
      function clearResumeStateFromAllRows() {
        var tbody = document.getElementById("rows");
        if (!tbody) return;
        var rows = tbody.querySelectorAll("tr[data-case-id]");
        rows.forEach(function (tr) {
          var runBtn = tr.querySelector("button.run");
          if (!runBtn || runBtn.textContent !== "Resume") return;
          var caseId = tr.getAttribute("data-case-id");
          var resultDiv = document.getElementById("result-" + caseId);
          runBtn.textContent = getRunButtonLabel(caseId);
          runBtn.title = runBtn.textContent || "";
          runBtn.classList.remove("resume-btn");
          runBtn.onclick = function () {
            runCase(caseId, runBtn, resultDiv, null);
          };
          if (tr._resumeSync !== undefined) delete tr._resumeSync;
          if (tr._resumeExtract !== undefined) delete tr._resumeExtract;
          if (tr._resumeSyncLimit !== undefined) delete tr._resumeSyncLimit;
          if (tr._resumeExtractLimit !== undefined)
            delete tr._resumeExtractLimit;
          if (resultDiv) {
            resultDiv.className = "result result-placeholder";
            resultDiv.innerHTML =
              '<span class="result-placeholder-text">Select at least one brand or purchaser in the filter above, then click Run.</span>';
          }
          tr.querySelectorAll(".limit-sync, .limit-extract").forEach(
            function (input) {
              input.disabled = false;
            },
          );
          var resetDuringResumeBtn = tr.querySelector(".reset-during-resume");
          if (resetDuringResumeBtn)
            resetDuringResumeBtn.classList.remove("show-during-resume");
          var resetBtn = tr.querySelector(
            "button.reset-case:not(.reset-during-resume)",
          );
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
        });
      }
      function updateFilterDropdownTrigger(which) {
        var trigger = document.getElementById(
          which === "brand"
            ? "brand-dropdown-trigger"
            : "purchaser-dropdown-trigger",
        );
        var selected =
          which === "brand" ? getSelectedBrands() : getSelectedPurchasers();
        var panel = document.getElementById(
          which === "brand"
            ? "brand-dropdown-panel"
            : "purchaser-dropdown-panel",
        );
        var total = panel
          ? panel.querySelectorAll("input[type=checkbox]:not([value='ALL'])")
              .length
          : 0;

        if (panel) {
          var allCb = panel.querySelector('input[value="ALL"]');
          if (allCb) {
            var otherCbs = Array.from(
              panel.querySelectorAll('input[type=checkbox]:not([value="ALL"])'),
            );
            allCb.checked =
              otherCbs.length > 0 &&
              otherCbs.every(function (c) {
                return c.checked;
              });
          }
        }

        if (!trigger) return;
        var defaultTitle =
          which === "brand"
            ? "Select one or more brands"
            : "Select one or more purchasers";
        if (selected.length === 0) {
          trigger.textContent =
            which === "brand" ? "Select brand" : "Select purchaser";
          trigger.title = defaultTitle;
        } else if (selected.length === 1) {
          var label =
            which === "brand"
              ? formatBrandName(selected[0])
              : formatPurchaserName(selected[0]);
          trigger.textContent = label;
          trigger.title = label;
        } else {
          if (total > 0 && selected.length === total) {
            trigger.textContent = "All";
          } else {
            trigger.textContent = selected.length + " selected";
          }
          var formatter =
            which === "brand" ? formatBrandName : formatPurchaserName;
          trigger.title = selected.map(formatter).join(", ");
        }
        clearValidationAlertWhenFilterSelected();
        clearResumeStateFromAllRows();
        updateHeaderStatus();
      }
      function updateHeaderStatus() {
        var scopeEl = document.getElementById("header-status-scope");
        if (!scopeEl) return;
        var selectedBrands = getSelectedBrands();
        var selectedPurchasers = getSelectedPurchasers();

        var brandText = "All Assets";
        var totalBrands = document.querySelectorAll(
          '#brand-dropdown-panel input[type=checkbox]:not([value="ALL"])',
        ).length;
        if (selectedBrands.length > 0) {
          if (totalBrands > 0 && selectedBrands.length === totalBrands) {
            brandText = "All Brands";
          } else if (selectedBrands.length === 1) {
            brandText = formatBrandName(selectedBrands[0]);
          } else {
            brandText = selectedBrands.length + " Brands";
          }
        }

        var purchaserText = "";
        var totalPurchasers = document.querySelectorAll(
          '#purchaser-dropdown-panel input[type=checkbox]:not([value="ALL"])',
        ).length;
        if (selectedPurchasers.length > 0) {
          if (
            totalPurchasers > 0 &&
            selectedPurchasers.length === totalPurchasers
          ) {
            purchaserText = "All Purchasers";
          } else if (selectedPurchasers.length === 1) {
            purchaserText = formatPurchaserName(selectedPurchasers[0]);
          } else {
            purchaserText = selectedPurchasers.length + " Purchasers";
          }
        }

        if (purchaserText) {
          scopeEl.textContent = brandText + " / " + purchaserText;
        } else {
          scopeEl.textContent = brandText;
        }
        scopeEl.title = "Current Scope: " + scopeEl.textContent;
      }
      function resetFilter() {
        var brandPanel = document.getElementById("brand-dropdown-panel");
        var purchaserPanel = document.getElementById(
          "purchaser-dropdown-panel",
        );
        if (brandPanel)
          brandPanel
            .querySelectorAll("input[type=checkbox]")
            .forEach(function (cb) {
              cb.checked = false;
            });
        if (purchaserPanel)
          purchaserPanel
            .querySelectorAll("input[type=checkbox]")
            .forEach(function (cb) {
              cb.checked = false;
            });
        updateFilterDropdownTrigger("brand");
        updateFilterDropdownTrigger("purchaser");
        clearBrandError();
        clearPurchaserError();
        refreshPurchaserOptions();
        updateHeaderStatus();
      }
      function showBrandError(msg) {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = msg || "Please select a brand.";
      }
      function clearBrandError() {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = "";
      }
      function showPurchaserError(msg) {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = msg || "Please select a brand first.";
      }
      function clearPurchaserError() {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = "";
      }
      (function () {
        var brandTrigger = document.getElementById("brand-dropdown-trigger");
        var brandPanel = document.getElementById("brand-dropdown-panel");
        var brandDropdown = document.getElementById("brand-dropdown");
        var purchaserTrigger = document.getElementById(
          "purchaser-dropdown-trigger",
        );
        var purchaserPanel = document.getElementById(
          "purchaser-dropdown-panel",
        );
        var purchaserDropdown = document.getElementById("purchaser-dropdown");
        var resetBtn = document.getElementById("filter-reset-btn");

        function closeAllDropdowns() {
          if (brandPanel) brandPanel.classList.remove("open");
          if (purchaserPanel) purchaserPanel.classList.remove("open");
          if (brandTrigger) brandTrigger.setAttribute("aria-expanded", "false");
          if (purchaserTrigger)
            purchaserTrigger.setAttribute("aria-expanded", "false");
        }
        function toggleDropdown(panel, trigger) {
          var isOpen = panel && panel.classList.contains("open");
          closeAllDropdowns();
          if (!isOpen && panel && trigger) {
            panel.classList.add("open");
            trigger.setAttribute("aria-expanded", "true");
          }
        }
        if (brandTrigger && brandPanel) {
          brandTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleDropdown(brandPanel, brandTrigger);
          });
        }
        if (purchaserTrigger && purchaserPanel) {
          purchaserTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            toggleDropdown(purchaserPanel, purchaserTrigger);
          });
        }
        document.addEventListener("click", function () {
          closeAllDropdowns();
        });
        if (brandDropdown)
          brandDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        if (purchaserDropdown)
          purchaserDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });

        if (resetBtn)
          resetBtn.addEventListener("click", function () {
            resetFilter();
          });
        fetchConfig().then(function () {
          updateHeaderStatus();

          // Handle deep linking from reports
          var urlParams = new URLSearchParams(window.location.search);
          var brandParam = urlParams.get("brand");
          var purchaserParam = urlParams.get("purchaser");
          var caseIdParam = urlParams.get("caseId");
          var autoRun = urlParams.get("autoRun") === "true";
          var retryFailed = urlParams.get("retryFailed") === "true";

          if (brandParam) {
            var brandPanel = document.getElementById("brand-dropdown-panel");
            if (brandPanel) {
              var brandCb = brandPanel.querySelector(
                'input[type=checkbox][value="' + brandParam + '"]',
              );
              if (brandCb) {
                brandCb.checked = true;
                refreshPurchaserOptions();
              }
            }
          }
          if (purchaserParam) {
            var purchaserPanel = document.getElementById(
              "purchaser-dropdown-panel",
            );
            if (purchaserPanel) {
              var purchaserCb = purchaserPanel.querySelector(
                'input[type=checkbox][value="' + purchaserParam + '"]',
              );
              if (purchaserCb) {
                purchaserCb.checked = true;
              }
            }
          }
          if (brandParam || purchaserParam) {
            updateFilterDropdownTrigger("brand");
            updateFilterDropdownTrigger("purchaser");
            updateHeaderStatus();
          }

          if (autoRun && caseIdParam) {
            var caseRow = document.querySelector(
              'tr[data-case-id="' + caseIdParam + '"]',
            );
            if (caseRow) {
              var runBtn = caseRow.querySelector("button.run");
              var resultDiv = caseRow.querySelector(".result");
              var retryBtn = caseRow.querySelector(".retry-failed-btn");

              if (retryFailed && retryBtn) {
                retryBtn.click();
              } else if (runBtn) {
                runBtn.click();
              }
            }
          }
        });

        // Initialize notification modal logic
        function initNotificationModal() {
          var overlay = document.getElementById("notification-modal-overlay");
          var openBtn = document.getElementById("notification-settings-btn");
          var closeIcon = document.getElementById(
            "notification-modal-close-icon",
          );
          var cancelBtn = document.getElementById("notification-modal-cancel");
          var saveBtn = document.getElementById("notification-save-btn");
          var emailInput = document.getElementById("recipient-email-input");

          if (!overlay || !openBtn) return;

          if (saveBtn) {
            saveBtn.innerHTML = "<span>Save</span>";
          }

          function close() {
            overlay.classList.remove("open");
            overlay.setAttribute("aria-hidden", "true");
          }

          openBtn.onclick = function () {
            // Fetch current config
            fetch("/api/email-config")
              .then(function (r) {
                return r.json();
              })
              .then(function (data) {
                if (data.recipientEmail) {
                  emailInput.value = data.recipientEmail;
                }
                overlay.classList.add("open");
                overlay.setAttribute("aria-hidden", "false");
              })
              .catch(function (e) {
                console.warn("Failed to load config, opening anyway:", e);
                overlay.classList.add("open");
                overlay.setAttribute("aria-hidden", "false");
              });
          };

          if (closeIcon) closeIcon.onclick = close;
          if (cancelBtn) cancelBtn.onclick = close;

          overlay.onclick = function (e) {
            if (e.target === overlay) close();
          };

          if (saveBtn) {
            saveBtn.onclick = function () {
              var rawValue = emailInput.value.trim();
              if (rawValue) {
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                var emails = rawValue.split(",").map(function (e) {
                  return e.trim();
                });

                for (var i = 0; i < emails.length; i++) {
                  var emailToTest = emails[i];
                  if (!emailToTest) {
                    alert("List contains empty email entry.");
                    return;
                  }
                  if (!emailRegex.test(emailToTest)) {
                    alert(
                      '"' + emailToTest + '" is not a valid email address.',
                    );
                    return;
                  }
                }
              }
              var email = rawValue;

              saveBtn.disabled = true;
              saveBtn.innerHTML = "<span>Saving...</span>";

              fetch("/api/email-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ recipientEmail: email }),
              })
                .then(function (r) {
                  return r.json();
                })
                .then(function (data) {
                  if (data.success) {
                    alert("Notification settings saved successfully!");
                    close();
                  } else {
                    alert("Failed to save.");
                  }
                })
                .catch(function (e) {
                  alert("Network error: " + e.message);
                })
                .finally(function () {
                  saveBtn.disabled = false;
                  saveBtn.innerHTML = "<span>Save</span>";
                });
            };
          }
        }
        initNotificationModal();
      })();
      window.stopBackgroundJob = function (caseId) {
        if (confirm("Are you sure you want to stop auto extraction?")) {
          var resultDiv = document.getElementById("result-" + caseId);
          var tbody = document.getElementById("rows");
          var caseRow = tbody
            ? tbody.querySelector('tr[data-case-id="' + caseId + '"]')
            : null;
          var resetBtn = caseRow
            ? caseRow.querySelector(
                "button.reset-case:not(.reset-during-resume)",
              )
            : null;

          if (resetBtn) {
            resetBtn.disabled = true;
            resetBtn.innerHTML = "<span>Stopping...</span>";
          }

          fetch("/api/stop-run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ caseId: caseId, origin: "scheduled" }),
          })
            .then(function (r) {
              return r.json();
            })
            .then(function (data) {
              if (data.error) {
                alert("Error stopping auto extraction: " + data.error);
                if (resetBtn) {
                  resetBtn.disabled = false;
                  resetBtn.innerHTML =
                    ICON_STOP + "<span>Stop Auto Extraction</span>";
                }
              } else {
                // Success â€” reset UI back to default state
                if (resultDiv) {
                  resultDiv.className = "result result-placeholder";
                  resultDiv.innerHTML =
                    '<span class="result-placeholder-text">Ready to extract. Configure filters and click Run.</span>';
                }
                if (resetBtn) {
                  resetBtn.disabled = false;
                  resetBtn.innerHTML = ICON_RESET + "<span>Reset</span>";
                  resetBtn.classList.remove("stop-btn");
                  resetBtn.onclick = function () {
                    resetCase(resultDiv);
                  };
                }
                var runBtn = caseRow
                  ? caseRow.querySelector("button.run")
                  : null;
                if (runBtn) runBtn.disabled = false;
                setOtherRowsActive();
              }
            })
            .catch(function (e) {
              alert("Network error: " + e.message);
              if (resetBtn) {
                resetBtn.disabled = false;
                resetBtn.innerHTML =
                  ICON_STOP + "<span>Stop Auto Extraction</span>";
              }
            });
        }
      };
    </script>
  </body>
</html>
